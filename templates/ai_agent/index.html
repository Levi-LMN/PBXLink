{% extends "base.html" %}

{% block title %}AI Agent Management - Sibasi PBX{% endblock %}
{% block page_title %}AI Agent Management{% endblock %}

{% block extra_css %}
<style>
    .connection-card {
        border-left: 4px solid #dee2e6;
    }
    .connection-card.connected { border-left-color: #22c55e; background-color: #f0fdf4; }
    .connection-card.disconnected { border-left-color: #ef4444; background-color: #fef2f2; }
    .stat-card {
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        color: white;
        padding: 1.5rem;
    }
    .call-log-row { cursor: pointer; }
    .call-log-row:hover { background-color: #f8f9fa; }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-1"><i class="fas fa-robot"></i> AI Voice Agent</h4>
                <p class="text-muted mb-0">Real-time monitoring and configuration</p>
            </div>
            <div>
                <button class="btn btn-success btn-sm" id="startBtn" onclick="startService()">
                    <i class="fas fa-play"></i> Start
                </button>
                <button class="btn btn-danger btn-sm" id="stopBtn" onclick="stopService()" disabled>
                    <i class="fas fa-stop"></i> Stop
                </button>
                <button class="btn btn-outline-primary btn-sm" onclick="refreshStatus()">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Service Status Overview -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card rounded">
            <div class="small opacity-75 mb-2">Service Status</div>
            <h2 id="serviceStatus" class="mb-0"><i class="fas fa-circle"></i></h2>
            <div id="uptimeDisplay" class="mt-2 small">Checking...</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card rounded">
            <div class="small opacity-75 mb-2">Active Calls</div>
            <h2 id="activeCalls" class="mb-0">-</h2>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card rounded">
            <div class="small opacity-75 mb-2">Total Calls</div>
            <h2 id="totalCalls" class="mb-0">-</h2>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card rounded">
            <div class="small opacity-75 mb-2">Cached Phrases</div>
            <h2 id="cachedPhrases" class="mb-0">-</h2>
        </div>
    </div>
</div>

<!-- Connection Status Grid -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-plug"></i> System Connections</h5>
        <small class="text-muted">Last update: <span id="lastUpdate"></span></small>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4 col-sm-6">
                <div class="connection-card card" id="card-azure-openai">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1"><i class="fas fa-brain"></i> Azure OpenAI</h6>
                                <small class="text-muted">GPT-4 API</small>
                            </div>
                            <span class="badge bg-secondary" id="status-azure-openai">Unknown</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 col-sm-6">
                <div class="connection-card card" id="card-azure-speech">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1"><i class="fas fa-microphone"></i> Azure Speech</h6>
                                <small class="text-muted">Speech Recognition</small>
                            </div>
                            <span class="badge bg-secondary" id="status-azure-speech">Unknown</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 col-sm-6">
                <div class="connection-card card" id="card-ari">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1"><i class="fas fa-phone-volume"></i> Asterisk ARI</h6>
                                <small class="text-muted">Call Interface</small>
                            </div>
                            <span class="badge bg-secondary" id="status-ari">Unknown</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 col-sm-6">
                <div class="connection-card card" id="card-ssh">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1"><i class="fas fa-terminal"></i> SSH Connection</h6>
                                <small class="text-muted">File Upload</small>
                            </div>
                            <span class="badge bg-secondary" id="status-ssh">Unknown</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 col-sm-6">
                <div class="connection-card card" id="card-dataverse">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1"><i class="fas fa-database"></i> Dataverse</h6>
                                <small class="text-muted">Customer Data</small>
                            </div>
                            <span class="badge bg-secondary" id="status-dataverse">Unknown</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 col-sm-6">
                <div class="connection-card card" id="card-cache">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1"><i class="fas fa-box"></i> TTS Cache</h6>
                                <small class="text-muted">Audio Cache</small>
                            </div>
                            <span class="badge bg-secondary" id="status-cache">Unknown</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Active Calls -->
<div class="card mb-4" id="activeCallsSection" style="display: none;">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="fas fa-phone-alt"></i> Active Calls</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Channel ID</th>
                        <th>Caller Number</th>
                        <th>Duration</th>
                    </tr>
                </thead>
                <tbody id="activeCallsList"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Error Display -->
<div class="alert alert-danger" id="errorAlert" style="display: none;">
    <h6 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> Last Error</h6>
    <p id="errorMessage" class="mb-0"></p>
</div>

<!-- Configuration Tabs -->
<ul class="nav nav-tabs mb-3">
    <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#configTab">
            <i class="fas fa-cog"></i> Configuration
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#departmentsTab" onclick="loadDepartments()">
            <i class="fas fa-building"></i> Departments
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#callsTab" onclick="loadCallHistory()">
            <i class="fas fa-history"></i> Call History
        </button>
    </li>
</ul>

<div class="tab-content">
    <!-- Configuration Tab -->
    <div class="tab-pane fade show active" id="configTab">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-sliders-h"></i> AI Agent Configuration</h5>
            </div>
            <div class="card-body">
                <form id="configForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Company Name</label>
                            <input type="text" class="form-control" id="companyName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Max Conversation Turns</label>
                            <input type="number" class="form-control" id="maxTurns" min="1" max="20" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">System Prompt</label>
                        <textarea class="form-control" id="systemPrompt" rows="8" required></textarea>
                        <small class="text-muted">Instructions for the AI agent's behavior</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Greeting Template</label>
                        <textarea class="form-control" id="greetingTemplate" rows="3" required></textarea>
                        <small class="text-muted">Available variables: {time_greeting}, {company_name}</small>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="storeRecordings">
                                <label class="form-check-label" for="storeRecordings">Store Call Recordings</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="storeTranscripts">
                                <label class="form-check-label" for="storeTranscripts">Store Transcripts</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="enabled">
                                <label class="form-check-label" for="enabled">Enable AI Agent</label>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Configuration
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Departments Tab -->
    <div class="tab-pane fade" id="departmentsTab">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-building"></i> Transfer Departments</h5>
                <button class="btn btn-primary btn-sm" onclick="showAddDepartmentModal()">
                    <i class="fas fa-plus"></i> Add Department
                </button>
            </div>
            <div class="card-body">
                <div id="departmentsList">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Call History Tab -->
    <div class="tab-pane fade" id="callsTab">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-history"></i> Recent Call Logs</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Caller</th>
                                <th>Duration</th>
                                <th>Turns</th>
                                <th>Transferred</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="callHistoryBody">
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <div class="spinner-border text-primary"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let statusInterval = null;
let isUpdating = false;
let consecutiveErrors = 0;
let lastKnownState = null;

// Load configuration
async function loadConfig() {
    try {
        const response = await fetch('/ai_agent/api/config');
        const data = await response.json();

        if (data.success && data.config) {
            const config = data.config;
            document.getElementById('companyName').value = config.company_name || '';
            document.getElementById('maxTurns').value = config.max_turns || 6;
            document.getElementById('systemPrompt').value = config.system_prompt || '';
            document.getElementById('greetingTemplate').value = config.greeting_template || '';
            document.getElementById('storeRecordings').checked = config.store_recordings || false;
            document.getElementById('storeTranscripts').checked = config.store_transcripts || false;
            document.getElementById('enabled').checked = config.enabled || false;
        }
    } catch (error) {
        console.error('Failed to load config:', error);
    }
}

// Save configuration
document.getElementById('configForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const config = {
        company_name: document.getElementById('companyName').value,
        max_turns: parseInt(document.getElementById('maxTurns').value),
        system_prompt: document.getElementById('systemPrompt').value,
        greeting_template: document.getElementById('greetingTemplate').value,
        store_recordings: document.getElementById('storeRecordings').checked,
        store_transcripts: document.getElementById('storeTranscripts').checked,
        enabled: document.getElementById('enabled').checked
    };

    try {
        const response = await fetch('/ai_agent/api/config', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(config)
        });

        const data = await response.json();
        if (data.success) {
            alert('Configuration saved successfully!');
        } else {
            alert('Failed to save: ' + data.error);
        }
    } catch (error) {
        alert('Error saving configuration: ' + error);
    }
});

// Refresh status with error handling
async function refreshStatus() {
    if (isUpdating) return;
    isUpdating = true;

    try {
        const response = await fetch('/ai_agent/api/service/status');

        if (!response.ok) {
            consecutiveErrors++;
            console.warn(`Status check failed: ${response.status}`);

            if (consecutiveErrors >= 3 && consecutiveErrors % 3 === 0) {
                console.warn('Multiple connection failures detected');
            }
            return;
        }

        const data = await response.json();

        if (data.success) {
            consecutiveErrors = 0;
            lastKnownState = data.status;
            updateStatusDisplay(data.status);
            updateLastUpdateTime();
        }
    } catch (error) {
        consecutiveErrors++;
        console.error('Failed to refresh status:', error);

        if (lastKnownState && consecutiveErrors < 10) {
            console.log('Using last known state');
        }
    } finally {
        setTimeout(() => { isUpdating = false; }, 500);
    }
}

function updateLastUpdateTime() {
    const now = new Date();
    document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
}

function updateStatusDisplay(status) {
    const running = status.running;
    const statusIcon = document.getElementById('serviceStatus');

    statusIcon.innerHTML = running ?
        '<i class="fas fa-check-circle"></i>' :
        '<i class="fas fa-times-circle"></i>';

    document.getElementById('startBtn').disabled = running;
    document.getElementById('stopBtn').disabled = !running;

    document.getElementById('activeCalls').textContent = status.active_calls || 0;
    document.getElementById('totalCalls').textContent = status.total_calls_handled || 0;
    document.getElementById('cachedPhrases').textContent = status.cache?.phrases_count || 0;

    if (running && status.uptime_seconds !== null && status.uptime_seconds !== undefined) {
        const hours = Math.floor(status.uptime_seconds / 3600);
        const minutes = Math.floor((status.uptime_seconds % 3600) / 60);
        const seconds = status.uptime_seconds % 60;

        if (hours > 0) {
            document.getElementById('uptimeDisplay').textContent = `Uptime: ${hours}h ${minutes}m`;
        } else if (minutes > 0) {
            document.getElementById('uptimeDisplay').textContent = `Uptime: ${minutes}m ${seconds}s`;
        } else {
            document.getElementById('uptimeDisplay').textContent = `Uptime: ${seconds}s`;
        }
    } else {
        document.getElementById('uptimeDisplay').textContent = running ? 'Starting...' : 'Offline';
    }

    updateConnection('azure-openai', status.connections?.azure_openai);
    updateConnection('azure-speech', status.connections?.azure_speech);
    updateConnection('ari', status.connections?.ari);
    updateConnection('ssh', status.connections?.ssh);
    updateConnection('dataverse', status.connections?.dataverse);
    updateConnection('cache', status.cache?.loaded);

    if (status.calls && status.calls.length > 0) {
        document.getElementById('activeCallsSection').style.display = 'block';
        const tbody = document.getElementById('activeCallsList');
        tbody.innerHTML = status.calls.map(call => `
            <tr>
                <td><code>${call.channel_id}</code></td>
                <td><strong>${call.caller_number}</strong></td>
                <td><span class="badge bg-info">${call.duration}s</span></td>
            </tr>
        `).join('');
    } else {
        document.getElementById('activeCallsSection').style.display = 'none';
    }

    if (status.last_error) {
        document.getElementById('errorAlert').style.display = 'block';
        document.getElementById('errorMessage').textContent = status.last_error;
    } else {
        document.getElementById('errorAlert').style.display = 'none';
    }
}

function updateConnection(name, connected) {
    const card = document.getElementById(`card-${name}`);
    const badge = document.getElementById(`status-${name}`);

    if (!card || !badge) return;

    card.classList.remove('connected', 'disconnected');

    if (connected === true) {
        card.classList.add('connected');
        badge.className = 'badge bg-success';
        badge.innerHTML = '<i class="fas fa-check"></i> Connected';
    } else if (connected === false) {
        card.classList.add('disconnected');
        badge.className = 'badge bg-danger';
        badge.innerHTML = '<i class="fas fa-times"></i> Disconnected';
    } else {
        badge.className = 'badge bg-secondary';
        badge.innerHTML = 'Unknown';
    }
}

async function startService() {
    const btn = document.getElementById('startBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';

    try {
        const response = await fetch('/ai_agent/api/service/start', {method: 'POST'});
        const data = await response.json();

        if (data.success) {
            document.getElementById('stopBtn').disabled = false;
            alert('Service started successfully');
            startStatusPolling();
        } else {
            alert('Failed to start: ' + data.message);
            btn.disabled = false;
        }
    } catch (error) {
        alert('Error starting service: ' + error);
        btn.disabled = false;
    } finally {
        btn.innerHTML = '<i class="fas fa-play"></i> Start';
    }
}

async function stopService() {
    const btn = document.getElementById('stopBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Stopping...';

    try {
        const response = await fetch('/ai_agent/api/service/stop', {method: 'POST'});
        const data = await response.json();

        if (data.success) {
            document.getElementById('startBtn').disabled = false;
            alert('Service stopped successfully');
            stopStatusPolling();
        } else {
            alert('Failed to stop: ' + data.message);
            btn.disabled = false;
        }
    } catch (error) {
        alert('Error stopping service: ' + error);
        btn.disabled = false;
    } finally {
        btn.innerHTML = '<i class="fas fa-stop"></i> Stop';
    }
}

async function loadDepartments() {
    try {
        const response = await fetch('/ai_agent/api/departments');
        const data = await response.json();

        const container = document.getElementById('departmentsList');

        if (data.success && data.departments && data.departments.length > 0) {
            container.innerHTML = data.departments.map(dept => `
                <div class="card mb-2">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${dept.display_name}</h6>
                                <small class="text-muted">
                                    Extension: ${dept.extension} | Endpoint: ${dept.endpoint}
                                </small>
                                ${dept.description ? `<p class="mb-0 mt-2 small">${dept.description}</p>` : ''}
                            </div>
                            <span class="badge ${dept.enabled ? 'bg-success' : 'bg-secondary'}">
                                ${dept.enabled ? 'Enabled' : 'Disabled'}
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
        } else {
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-building fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No departments configured yet</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Failed to load departments:', error);
    }
}

async function loadCallHistory(page = 1) {
    try {
        const response = await fetch(`/ai_agent/api/calls?page=${page}&per_page=20`);
        const data = await response.json();

        const tbody = document.getElementById('callHistoryBody');

        if (data.success && data.calls && data.calls.length > 0) {
            tbody.innerHTML = data.calls.map(call => `
                <tr class="call-log-row" onclick="viewCallDetail(${call.id})">
                    <td>${new Date(call.created_at).toLocaleString()}</td>
                    <td>
                        <strong>${call.caller_name || 'Unknown'}</strong><br>
                        <small class="text-muted">${call.caller_number}</small>
                    </td>
                    <td>${call.call_duration ? call.call_duration + 's' : '-'}</td>
                    <td><span class="badge bg-info">${call.turns_count || 0}</span></td>
                    <td>${call.transferred_to ? `<span class="badge bg-success">${call.transferred_to}</span>` : '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); viewCallDetail(${call.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        } else {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4">
                        <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">No call history yet</p>
                    </td>
                </tr>
            `;
        }
    } catch (error) {
        console.error('Failed to load call history:', error);
    }
}

function viewCallDetail(callId) {
    alert('Call detail view - coming soon');
}

function showAddDepartmentModal() {
    alert('Add department modal - coming soon');
}

function startStatusPolling() {
    if (statusInterval) return;
    statusInterval = setInterval(refreshStatus, 5000);
    refreshStatus();
}

function stopStatusPolling() {
    if (statusInterval) {
        clearInterval(statusInterval);
        statusInterval = null;
    }
}

document.addEventListener('DOMContentLoaded', () => {
    loadConfig();
    refreshStatus();
    startStatusPolling();
});

window.addEventListener('beforeunload', () => {
    stopStatusPolling();
});
</script>
{% endblock %}