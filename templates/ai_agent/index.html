{% extends "base.html" %}

{% block title %}AI Agent page- FreePBX Management{% endblock %}
{% block page_title %}AI Agent Management{% endblock %}

{% block extra_css %}
<style>
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    .pulse { animation: pulse 2s infinite; }

    @keyframes heartbeat {
        0%, 100% { transform: scale(1); }
        10%, 30% { transform: scale(1.2); }
        20%, 40% { transform: scale(1); }
    }
    .heartbeat-icon { animation: heartbeat 1.5s infinite; }

    .log-viewer {
        background: #1e293b;
        color: #e2e8f0;
        font-family: 'Courier New', monospace;
        font-size: 0.75rem;
        height: 400px;
        overflow-y: auto;
        white-space: pre-wrap;
        padding: 1rem;
    }

    .log-line.error { color: #fca5a5; }
    .log-line.warning { color: #fcd34d; }
    .log-line.info { color: #93c5fd; }

    .transcript-line { padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 6px; }
    .transcript-line.user { background: #eff6ff; border-left: 3px solid #0d6efd; }
    .transcript-line.ai { background: #f0fdf4; border-left: 3px solid #198754; }
    .speaker-label { font-weight: 600; font-size: 0.75rem; text-transform: uppercase; margin-bottom: 0.25rem; }
</style>
{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- Status Overview -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h5 class="mb-1"><i class="fas fa-robot text-primary me-2"></i>Service Status</h5>
                        <small class="text-muted">Real-time AI Agent monitoring</small>
                    </div>
                    <div id="status-badge-container">
                        <span class="badge bg-secondary"><span class="pulse">●</span> Checking...</span>
                    </div>
                </div>

                <div id="alert-container"></div>

                <div class="row g-3">
                    <div class="col-6 col-md-3">
                        <div class="text-center p-3 bg-light rounded">
                            <i class="fas fa-clock text-primary mb-2"></i>
                            <div class="fw-bold" id="uptime">-</div>
                            <small class="text-muted">Uptime</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="text-center p-3 bg-light rounded">
                            <i class="fas fa-hashtag text-primary mb-2"></i>
                            <div class="fw-bold" id="pid">-</div>
                            <small class="text-muted">Process ID</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="text-center p-3 bg-light rounded">
                            <i class="fas fa-phone-alt text-primary mb-2"></i>
                            <div class="fw-bold" id="active-calls">-</div>
                            <small class="text-muted">Active Calls</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="text-center p-3 bg-light rounded">
                            <i class="fas fa-chart-line text-primary mb-2"></i>
                            <div class="fw-bold" id="total-calls">-</div>
                            <small class="text-muted">Total Calls</small>
                        </div>
                    </div>
                </div>

                <div id="heartbeat-container" class="mt-3 d-none">
                    <div class="alert alert-success d-flex align-items-center">
                        <i class="fas fa-heartbeat heartbeat-icon me-2"></i>
                        <span>Last heartbeat: <strong id="heartbeat-time">-</strong></span>
                    </div>
                </div>

                <div class="mt-4 d-flex flex-wrap gap-2">
                    <button class="btn btn-success" id="btn-start" onclick="startService()">
                        <i class="fas fa-play me-2"></i>Start
                    </button>
                    <button class="btn btn-danger" id="btn-stop" onclick="stopService()" disabled>
                        <i class="fas fa-stop me-2"></i>Stop
                    </button>
                    <button class="btn btn-warning" id="btn-restart" onclick="restartService()" disabled>
                        <i class="fas fa-redo me-2"></i>Restart
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-cog text-primary me-2"></i>Configuration
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                        <span>Azure OpenAI</span>
                        <span id="azure-status" class="badge bg-secondary">
                            <i class="fas fa-circle-notch fa-spin"></i>
                        </span>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                        <span>Azure Speech</span>
                        <span id="speech-status" class="badge bg-secondary">
                            <i class="fas fa-circle-notch fa-spin"></i>
                        </span>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                        <span>Dataverse</span>
                        <span id="dataverse-status" class="badge bg-secondary">
                            <i class="fas fa-circle-notch fa-spin"></i>
                        </span>
                    </div>
                </div>
                <button class="btn btn-outline-primary btn-sm w-100 mt-3" onclick="refreshStatus()">
                    <i class="fas fa-sync-alt me-2"></i>Refresh Status
                </button>
            </div>
        </div>
    </div>

    <!-- Recent Conversations -->
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-history text-primary me-2"></i>Recent Conversations</span>
                <button class="btn btn-sm btn-outline-primary" onclick="loadCalls()">
                    <i class="fas fa-sync-alt me-2"></i>Refresh
                </button>
            </div>
            <div class="card-body">
                <!-- Filters -->
                <div class="row g-2 mb-3">
                    <div class="col-md-3">
                        <input type="text" class="form-control form-control-sm" id="filter-caller" placeholder="Caller Number">
                    </div>
                    <div class="col-md-2">
                        <select class="form-select form-select-sm" id="filter-limit">
                            <option value="10">10 calls</option>
                            <option value="25" selected>25 calls</option>
                            <option value="50">50 calls</option>
                            <option value="100">100 calls</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-sm btn-primary w-100" onclick="loadCalls()">
                            <i class="fas fa-filter me-2"></i>Apply
                        </button>
                    </div>
                </div>

                <!-- Calls List -->
                <div id="calls-container">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="text-muted mt-2">Loading conversations...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Logs -->
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-terminal text-primary me-2"></i>System Logs</span>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" onclick="refreshLogs()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="btn btn-outline-secondary" onclick="toggleAutoScroll()">
                        <i class="fas fa-arrow-down" id="autoscroll-icon"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="log-viewer rounded" id="log-viewer">
                    <div class="text-center py-5">
                        <div class="spinner-border text-light" role="status"></div>
                        <p class="mt-2 opacity-75">Loading logs...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Call Details Modal -->
<div class="modal fade" id="callModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-comments text-primary me-2"></i>Call Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modal-content"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let autoScroll = true;
let statusCheckInterval;
let callsModal;

document.addEventListener('DOMContentLoaded', function() {
    callsModal = new bootstrap.Modal(document.getElementById('callModal'));
    updateStatus();
    updateLogs();
    loadCalls();
    statusCheckInterval = setInterval(updateStatus, 5000);
    setInterval(updateLogs, 10000);
    setInterval(loadCalls, 30000);
});

function formatUptime(seconds) {
    if (!seconds) return '-';
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    if (h > 0) return `${h}h ${m}m`;
    if (m > 0) return `${m}m ${s}s`;
    return `${s}s`;
}

function formatTimestamp(timestamp) {
    if (!timestamp) return '-';
    const diff = Date.now() / 1000 - timestamp;
    if (diff < 60) return `${Math.floor(diff)}s ago`;
    if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
    return new Date(timestamp * 1000).toLocaleTimeString();
}

function formatDuration(seconds) {
    if (!seconds) return '0s';
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    return m > 0 ? `${m}m ${s}s` : `${s}s`;
}

async function updateStatus() {
    try {
        const response = await fetch('/ai_agent/api/status');
        const data = await response.json();
        if (!data.success) return;

        const status = data.status;
        const env = data.environment;
        const isRunning = status.running;

        document.getElementById('status-badge-container').innerHTML = isRunning ?
            '<span class="badge bg-success"><span class="pulse">●</span> Running</span>' :
            '<span class="badge bg-danger"><span class="pulse">●</span> Stopped</span>';

        document.getElementById('uptime').textContent = formatUptime(status.uptime_seconds);
        document.getElementById('pid').textContent = status.pid || '-';
        document.getElementById('active-calls').textContent = status.active_calls || 0;
        document.getElementById('total-calls').textContent = status.total_calls || 0;

        if (isRunning && status.last_heartbeat) {
            document.getElementById('heartbeat-container').classList.remove('d-none');
            document.getElementById('heartbeat-time').textContent = formatTimestamp(status.last_heartbeat);
        } else {
            document.getElementById('heartbeat-container').classList.add('d-none');
        }

        document.getElementById('btn-start').disabled = isRunning;
        document.getElementById('btn-stop').disabled = !isRunning;
        document.getElementById('btn-restart').disabled = !isRunning;

        document.getElementById('azure-status').innerHTML = env.azure_openai_configured ?
            '<i class="fas fa-check-circle"></i> OK' : '<i class="fas fa-times-circle"></i> Missing';
        document.getElementById('azure-status').className = env.azure_openai_configured ? 'badge bg-success' : 'badge bg-danger';

        document.getElementById('speech-status').innerHTML = env.azure_speech_configured ?
            '<i class="fas fa-check-circle"></i> OK' : '<i class="fas fa-times-circle"></i> Missing';
        document.getElementById('speech-status').className = env.azure_speech_configured ? 'badge bg-success' : 'badge bg-danger';

        document.getElementById('dataverse-status').innerHTML = env.dataverse_configured ?
            '<i class="fas fa-check-circle"></i> OK' : '<i class="fas fa-info-circle"></i> Optional';
        document.getElementById('dataverse-status').className = env.dataverse_configured ? 'badge bg-success' : 'badge bg-secondary';

        if (!env.azure_openai_configured || !env.azure_speech_configured) {
            document.getElementById('alert-container').innerHTML = `
                <div class="alert alert-warning alert-dismissible fade show">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Azure credentials not configured. Service cannot start.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>`;
        } else {
            document.getElementById('alert-container').innerHTML = '';
        }
    } catch (error) {
        console.error('Status update failed:', error);
    }
}

async function loadCalls() {
    try {
        const caller = document.getElementById('filter-caller')?.value || '';
        const limit = document.getElementById('filter-limit')?.value || '25';
        let url = `/admin/api/ai-agent-calls?limit=${limit}`;
        if (caller) url += `&caller_number=${encodeURIComponent(caller)}`;

        const response = await fetch(url);
        const data = await response.json();
        const container = document.getElementById('calls-container');

        if (!data.success || !data.calls || data.calls.length === 0) {
            container.innerHTML = `
                <div class="text-center py-5 text-muted">
                    <i class="fas fa-phone-slash fa-3x mb-3 opacity-25"></i>
                    <p>No conversations found</p>
                </div>`;
            return;
        }

        let html = '<div class="list-group">';
        data.calls.forEach(call => {
            const intentClass = call.intent === 'transfer_requested' ? 'warning' :
                               call.intent === 'ticket_created' ? 'info' : 'success';
            html += `
                <a href="#" class="list-group-item list-group-item-action" onclick="showCallDetails('${call.call_id}'); return false;">
                    <div class="d-flex w-100 justify-content-between">
                        <div>
                            <h6 class="mb-1">
                                <i class="fas fa-user me-2"></i>${call.caller_name || 'Unknown Caller'}
                            </h6>
                            <small class="text-muted">${call.caller_number || 'No number'}</small>
                        </div>
                        <div class="text-end">
                            <small class="text-muted">${new Date(call.call_start).toLocaleString()}</small>
                            <br><strong>${formatDuration(call.call_duration)}</strong>
                        </div>
                    </div>
                    <div class="mt-2">
                        ${call.intent ? `<span class="badge bg-${intentClass} me-1">${call.intent.replace('_', ' ')}</span>` : ''}
                        ${call.transferred_to ? '<span class="badge bg-warning me-1"><i class="fas fa-exchange-alt me-1"></i>Transferred</span>' : ''}
                        ${call.turns_count ? `<span class="badge bg-info me-1">${call.turns_count} turns</span>` : ''}
                        ${call.avg_confidence ? `<span class="badge bg-secondary me-1">${Math.round(call.avg_confidence * 100)}% confidence</span>` : ''}
                    </div>
                    ${call.summary ? `<p class="mb-1 mt-2 small">${call.summary}</p>` : ''}
                </a>`;
        });
        html += '</div>';
        container.innerHTML = html;
    } catch (error) {
        console.error('Failed to load calls:', error);
        document.getElementById('calls-container').innerHTML = `
            <div class="text-center py-5 text-danger">
                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                <p>Failed to load conversations</p>
            </div>`;
    }
}

async function showCallDetails(callId) {
    try {
        const response = await fetch(`/admin/api/ai-agent-calls/${callId}`);
        const data = await response.json();
        if (!data.success) {
            showToast('Failed to load call details', 'danger');
            return;
        }

        const call = data.call;
        let html = `
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-body">
                            <small class="text-muted d-block mb-1">Caller</small>
                            <strong>${call.caller_name || 'Unknown'}</strong>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-body">
                            <small class="text-muted d-block mb-1">Number</small>
                            <strong>${call.caller_number || '-'}</strong>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-body">
                            <small class="text-muted d-block mb-1">Duration</small>
                            <strong>${formatDuration(call.call_duration)}</strong>
                        </div>
                    </div>
                </div>
            </div>

            ${call.summary ? `
            <div class="mb-4">
                <h6><i class="fas fa-file-alt text-primary me-2"></i>Summary</h6>
                <div class="alert alert-info">${call.summary}</div>
            </div>` : ''}

            ${call.transcript ? `
            <div class="mb-4">
                <h6><i class="fas fa-comments text-primary me-2"></i>Full Transcript</h6>
                <div class="border rounded p-3" style="max-height: 400px; overflow-y: auto;">
                    ${parseTranscript(call.transcript)}
                </div>
            </div>` : ''}

            ${call.functions_called && call.functions_called.length > 0 ? `
            <div class="mb-4">
                <h6><i class="fas fa-cogs text-primary me-2"></i>Functions Called</h6>
                <div class="list-group">
                    ${call.functions_called.map(fn => `
                        <div class="list-group-item">
                            <strong>${fn.function}</strong>
                            ${fn.args ? `<div class="small text-muted mt-1">Args: ${JSON.stringify(fn.args)}</div>` : ''}
                        </div>
                    `).join('')}
                </div>
            </div>` : ''}
        `;

        document.getElementById('modal-content').innerHTML = html;
        callsModal.show();
    } catch (error) {
        console.error('Failed to load call details:', error);
        showToast('Failed to load call details', 'danger');
    }
}

function parseTranscript(transcript) {
    if (!transcript) return '<p class="text-muted">No transcript available</p>';
    const lines = transcript.split('\n').filter(line => line.trim());
    let html = '';
    lines.forEach(line => {
        if (line.startsWith('USER:')) {
            html += `<div class="transcript-line user mb-2">
                <div class="speaker-label text-primary">User</div>
                <div>${line.replace('USER:', '').trim()}</div>
            </div>`;
        } else if (line.startsWith('AI:')) {
            html += `<div class="transcript-line ai mb-2">
                <div class="speaker-label text-success">AI Assistant</div>
                <div>${line.replace('AI:', '').trim()}</div>
            </div>`;
        }
    });
    return html || '<p class="text-muted">No transcript available</p>';
}

async function startService() {
    const btn = document.getElementById('btn-start');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Starting...';
    try {
        const response = await fetch('/ai_agent/api/start', { method: 'POST' });
        const data = await response.json();
        showToast(data.success ? 'AI Agent started' : 'Failed to start: ' + data.message,
                 data.success ? 'success' : 'danger');
        if (data.success) setTimeout(updateStatus, 2000);
    } catch (error) {
        showToast('Error: ' + error.message, 'danger');
    } finally {
        btn.innerHTML = '<i class="fas fa-play me-2"></i>Start';
        btn.disabled = false;
    }
}

async function stopService() {
    if (!confirm('Stop AI Agent service?')) return;
    const btn = document.getElementById('btn-stop');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Stopping...';
    try {
        const response = await fetch('/ai_agent/api/stop', { method: 'POST' });
        const data = await response.json();
        showToast(data.success ? 'AI Agent stopped' : 'Failed to stop: ' + data.message,
                 data.success ? 'success' : 'danger');
        if (data.success) setTimeout(updateStatus, 1000);
    } catch (error) {
        showToast('Error: ' + error.message, 'danger');
    } finally {
        btn.innerHTML = '<i class="fas fa-stop me-2"></i>Stop';
        btn.disabled = false;
    }
}

async function restartService() {
    if (!confirm('Restart AI Agent service?')) return;
    const btn = document.getElementById('btn-restart');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Restarting...';
    try {
        const response = await fetch('/ai_agent/api/restart', { method: 'POST' });
        const data = await response.json();
        showToast(data.success ? 'AI Agent restarted' : 'Failed to restart: ' + data.message,
                 data.success ? 'success' : 'danger');
        if (data.success) setTimeout(updateStatus, 3000);
    } catch (error) {
        showToast('Error: ' + error.message, 'danger');
    } finally {
        btn.innerHTML = '<i class="fas fa-redo me-2"></i>Restart';
        btn.disabled = false;
    }
}

function refreshStatus() {
    updateStatus();
    updateLogs();
}

async function updateLogs() {
    try {
        const response = await fetch('/ai_agent/api/logs?lines=100');
        const data = await response.json();
        const viewer = document.getElementById('log-viewer');

        if (!data.success || !data.logs || data.logs.length === 0) {
            viewer.innerHTML = '<div class="text-center py-5 opacity-75">No logs available</div>';
            return;
        }

        const html = data.logs.map(line => {
            let className = 'log-line';
            if (line.includes('ERROR') || line.includes('❌')) className += ' error';
            else if (line.includes('WARNING') || line.includes('⚠️')) className += ' warning';
            else if (line.includes('INFO') || line.includes('✅')) className += ' info';
            return `<div class="${className}">${escapeHtml(line)}</div>`;
        }).join('');

        viewer.innerHTML = html;
        if (autoScroll) viewer.scrollTop = viewer.scrollHeight;
    } catch (error) {
        console.error('Failed to load logs:', error);
    }
}

function refreshLogs() {
    updateLogs();
}

function toggleAutoScroll() {
    autoScroll = !autoScroll;
    document.getElementById('autoscroll-icon').className = autoScroll ? 'fas fa-arrow-down' : 'fas fa-pause';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
    toast.style.zIndex = '9999';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
}

window.addEventListener('beforeunload', () => {
    if (statusCheckInterval) clearInterval(statusCheckInterval);
});
</script>
{% endblock %}