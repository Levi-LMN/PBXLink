{% extends "base.html" %}

{% block title %}Service Monitoring - Sibasi PBX{% endblock %}

{% block page_title %}Service Monitoring{% endblock %}
{% block page_subtitle %}Real-time monitoring of critical services with Microsoft Teams alerts{% endblock %}

{% block content %}
<div class="space-y-5">
    <!-- Alert Container -->
    <div id="alert-container"></div>

    <!-- Teams Notification Toggle Card -->
    <div class="bg-white rounded-xl border border-gray-100 p-5">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h2 class="text-base font-bold text-gray-900 mb-1 flex items-center gap-2">
                    <i class="fas fa-bell"></i>
                    Teams Notifications
                </h2>
                <p class="text-xs text-gray-500">Control whether service alerts are sent to Microsoft Teams</p>
            </div>
            <div class="flex items-center gap-3">
                <span class="text-xs font-medium text-gray-600" id="toggle-status-text">Loading...</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="teams-toggle" class="sr-only peer" disabled>
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
            </div>
        </div>
        <div class="text-xs text-gray-500 bg-blue-50 border border-blue-100 rounded-lg p-3">
            <i class="fas fa-info-circle text-blue-600 mr-1"></i>
            <strong>Note:</strong> When disabled, service monitoring continues but NO Teams alerts will be sent. Use this to prevent spam during maintenance.
        </div>
    </div>

    <!-- Actions Card -->
    <div class="bg-white rounded-xl border border-gray-100 p-5">
        <h2 class="text-base font-bold text-gray-900 mb-4">Actions</h2>
        <div class="flex flex-wrap gap-2">
            <button onclick="refreshStatus()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium rounded-lg transition-colors flex items-center gap-2">
                <i class="fas fa-sync-alt"></i>
                <span>Refresh Status</span>
            </button>
            <button onclick="testNotification()" id="test-notif-btn" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-xs font-medium rounded-lg transition-colors flex items-center gap-2">
                <i class="fas fa-bell"></i>
                <span>Test Teams Notification</span>
            </button>
            <button onclick="window.location.href='/admin'" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white text-xs font-medium rounded-lg transition-colors flex items-center gap-2">
                <i class="fas fa-arrow-left"></i>
                <span>Back to Admin</span>
            </button>
        </div>
    </div>

    <!-- Services Status -->
    <div>
        <h2 class="text-base font-bold text-gray-900 mb-4">Service Status</h2>
        <div id="status-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Loading state -->
            <div class="col-span-full text-center py-10">
                <i class="fas fa-spinner fa-spin text-3xl text-gray-400 mb-3"></i>
                <p class="text-sm text-gray-500">Loading service status...</p>
            </div>
        </div>
    </div>

    <!-- Configuration Card -->
    <div class="bg-white rounded-xl border border-gray-100 p-5">
        <h2 class="text-base font-bold text-gray-900 mb-4">Configuration</h2>
        <div id="config-container">
            <!-- Loading state -->
            <div class="text-center py-5">
                <i class="fas fa-spinner fa-spin text-2xl text-gray-400 mb-2"></i>
                <p class="text-xs text-gray-500">Loading configuration...</p>
            </div>
        </div>
    </div>
</div>

<style>
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .alert-enter {
        animation: fadeIn 0.3s ease-out;
    }

    .status-card {
        transition: all 0.2s ease;
    }

    .status-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
</style>

<script>
let refreshInterval;
let teamsNotificationsEnabled = false;

// Teams notification toggle
async function loadTeamsStatus() {
    try {
        const response = await fetch('/admin/api/monitoring/teams-status');
        const data = await response.json();

        if (data.status === 'success') {
            teamsNotificationsEnabled = data.enabled;
            const toggle = document.getElementById('teams-toggle');
            const statusText = document.getElementById('toggle-status-text');
            const testBtn = document.getElementById('test-notif-btn');

            toggle.checked = teamsNotificationsEnabled;
            toggle.disabled = false;
            statusText.textContent = teamsNotificationsEnabled ? 'Enabled' : 'Disabled';
            statusText.className = teamsNotificationsEnabled ? 'text-xs font-medium text-green-600' : 'text-xs font-medium text-gray-600';

            // Disable test button if notifications are off
            if (!teamsNotificationsEnabled) {
                testBtn.disabled = true;
                testBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                testBtn.disabled = false;
                testBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
    } catch (error) {
        console.error('Error loading Teams status:', error);
    }
}

async function toggleTeamsNotifications() {
    const toggle = document.getElementById('teams-toggle');
    const newState = toggle.checked;

    try {
        const response = await fetch('/admin/api/monitoring/teams-toggle', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                enabled: newState
            })
        });

        const data = await response.json();

        if (data.status === 'success') {
            teamsNotificationsEnabled = newState;
            const statusText = document.getElementById('toggle-status-text');
            statusText.textContent = newState ? 'Enabled' : 'Disabled';
            statusText.className = newState ? 'text-xs font-medium text-green-600' : 'text-xs font-medium text-gray-600';

            // Update test button
            const testBtn = document.getElementById('test-notif-btn');
            if (!newState) {
                testBtn.disabled = true;
                testBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                testBtn.disabled = false;
                testBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }

            showAlert(
                `‚úÖ Teams notifications ${newState ? 'enabled' : 'disabled'}. ${newState ? 'You will receive alerts.' : 'No alerts will be sent.'}`,
                newState ? 'success' : 'warning'
            );
        } else {
            // Revert toggle on error
            toggle.checked = !newState;
            showAlert('‚ùå Failed to toggle notifications: ' + data.message, 'error');
        }
    } catch (error) {
        // Revert toggle on error
        toggle.checked = !newState;
        showAlert('‚ùå Error toggling notifications: ' + error.message, 'error');
    }
}

// Attach toggle event listener
document.addEventListener('DOMContentLoaded', function() {
    const toggle = document.getElementById('teams-toggle');
    toggle.addEventListener('change', toggleTeamsNotifications);
});

async function loadStatus() {
    try {
        const response = await fetch('/admin/api/monitoring/status');
        const data = await response.json();

        if (data.status === 'success') {
            displayServices(data.services, data.monitoring_active);
        } else {
            showAlert('Error loading status: ' + data.message, 'error');
        }
    } catch (error) {
        showAlert('Failed to load service status: ' + error.message, 'error');
    }
}

async function loadConfig() {
    try {
        const response = await fetch('/admin/api/monitoring/webhook-config');
        const data = await response.json();

        if (data.status === 'success') {
            displayConfig(data);
        } else {
            document.getElementById('config-container').innerHTML =
                '<p class="text-xs text-red-600">Error loading configuration</p>';
        }
    } catch (error) {
        document.getElementById('config-container').innerHTML =
            '<p class="text-xs text-red-600">Failed to load configuration</p>';
    }
}

function displayServices(services, monitoringActive) {
    const container = document.getElementById('status-container');

    if (!services || Object.keys(services).length === 0) {
        container.innerHTML = `
            <div class="col-span-full text-center py-10">
                <i class="fas fa-inbox text-4xl text-gray-300 mb-3"></i>
                <p class="text-sm text-gray-500">No services being monitored</p>
            </div>
        `;
        return;
    }

    let html = '';

    for (const [serviceName, serviceInfo] of Object.entries(services)) {
        const status = serviceInfo.status || 'unknown';

        // Status styling
        let statusClass, statusBg, statusIcon;
        if (status === 'up') {
            statusClass = 'text-green-700 bg-green-50 border-green-200';
            statusBg = 'bg-green-100';
            statusIcon = 'fa-check-circle text-green-600';
        } else if (status === 'down') {
            statusClass = 'text-red-700 bg-red-50 border-red-200';
            statusBg = 'bg-red-100';
            statusIcon = 'fa-times-circle text-red-600';
        } else {
            statusClass = 'text-yellow-700 bg-yellow-50 border-yellow-200';
            statusBg = 'bg-yellow-100';
            statusIcon = 'fa-question-circle text-yellow-600';
        }

        html += `
            <div class="status-card bg-white rounded-xl border border-gray-100 p-4">
                <!-- Service Header -->
                <div class="flex items-start justify-between mb-3">
                    <div class="flex-1">
                        <h3 class="text-sm font-bold text-gray-900 mb-1">${serviceName}</h3>
                        <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold ${statusClass} border">
                            <i class="fas ${statusIcon}"></i>
                            ${status.toUpperCase()}
                        </span>
                    </div>
                </div>

                <!-- Service Info -->
                <div class="space-y-2 text-xs">
                    <div class="flex justify-between py-1.5 border-b border-gray-100">
                        <span class="text-gray-500 font-medium">Last Check:</span>
                        <span class="text-gray-900">${formatTimestamp(serviceInfo.last_check)}</span>
                    </div>
                    <div class="flex justify-between py-1.5 border-b border-gray-100">
                        <span class="text-gray-500 font-medium">Last Success:</span>
                        <span class="text-gray-900">${formatTimestamp(serviceInfo.last_success)}</span>
                    </div>
                    <div class="flex justify-between py-1.5">
                        <span class="text-gray-500 font-medium">Failures:</span>
                        <span class="text-gray-900 font-semibold">${serviceInfo.consecutive_failures || 0}</span>
                    </div>
                </div>
            </div>
        `;
    }

    container.innerHTML = html;
}

function displayConfig(config) {
    const container = document.getElementById('config-container');

    const getStatusBadge = (value) => {
        if (value) {
            return '<span class="inline-flex items-center gap-1 px-2.5 py-1 bg-green-50 text-green-700 text-xs font-semibold rounded-full border border-green-200"><i class="fas fa-check-circle"></i> Yes</span>';
        } else {
            return '<span class="inline-flex items-center gap-1 px-2.5 py-1 bg-red-50 text-red-700 text-xs font-semibold rounded-full border border-red-200"><i class="fas fa-times-circle"></i> No</span>';
        }
    };

    html = `
        <div class="space-y-3">
            <div class="flex items-center justify-between py-2.5 border-b border-gray-100">
                <span class="text-xs font-semibold text-gray-700">Teams Webhook Configured:</span>
                ${getStatusBadge(config.webhook_configured)}
            </div>
            <div class="flex items-center justify-between py-2.5 border-b border-gray-100">
                <span class="text-xs font-semibold text-gray-700">Notifications Enabled:</span>
                ${getStatusBadge(config.notifications_enabled)}
            </div>
            <div class="flex items-center justify-between py-2.5">
                <span class="text-xs font-semibold text-gray-700">Monitoring Active:</span>
                ${getStatusBadge(config.monitoring_active)}
            </div>
        </div>
    `;

    container.innerHTML = html;
}

function formatTimestamp(timestamp) {
    if (!timestamp) return '<span class="text-gray-400">Never</span>';

    try {
        // Parse ISO string with Z suffix (UTC)
        const date = new Date(timestamp);

        // Check if date is valid
        if (isNaN(date.getTime())) {
            console.error('Invalid timestamp:', timestamp);
            return '<span class="text-red-400">Invalid</span>';
        }

        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);

        if (diffMins < 0) {
            return '<span class="text-yellow-400">Future?</span>';
        } else if (diffMins < 1) {
            return '<span class="text-green-600">Just now</span>';
        } else if (diffMins < 60) {
            return `<span class="text-gray-600">${diffMins} min${diffMins !== 1 ? 's' : ''} ago</span>`;
        } else if (diffMins < 1440) { // Less than 24 hours
            const diffHours = Math.floor(diffMins / 60);
            return `<span class="text-gray-600">${diffHours} hr${diffHours !== 1 ? 's' : ''} ago</span>`;
        } else {
            // More than 24 hours - show date
            return '<span class="text-gray-600">' + date.toLocaleString() + '</span>';
        }
    } catch (error) {
        console.error('Error formatting timestamp:', timestamp, error);
        return '<span class="text-red-400">Error</span>';
    }
}

async function testNotification() {
    if (!teamsNotificationsEnabled) {
        showAlert('‚ö†Ô∏è Teams notifications are disabled. Enable them first to send test messages.', 'warning');
        return;
    }

    try {
        showAlert('Sending test notification...', 'info');

        const response = await fetch('/admin/api/monitoring/test-notification', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: 'This is a test notification from the Service Monitoring Dashboard'
            })
        });

        const data = await response.json();

        if (data.status === 'success') {
            showAlert('‚úÖ Test notification sent successfully! Check your Teams channel.', 'success');
        } else {
            showAlert('‚ùå Failed to send notification: ' + data.message, 'error');
        }
    } catch (error) {
        showAlert('‚ùå Error sending test notification: ' + error.message, 'error');
    }
}

function refreshStatus() {
    loadStatus();
    loadTeamsStatus();
    showAlert('üîÑ Status refreshed', 'success');
}

function showAlert(message, type) {
    const container = document.getElementById('alert-container');

    const alertClasses = {
        'success': 'bg-green-50 text-green-700 border-green-200',
        'error': 'bg-red-50 text-red-700 border-red-200',
        'warning': 'bg-yellow-50 text-yellow-700 border-yellow-200',
        'info': 'bg-blue-50 text-blue-700 border-blue-200'
    };

    const iconClasses = {
        'success': 'fa-check-circle text-green-600',
        'error': 'fa-exclamation-circle text-red-600',
        'warning': 'fa-exclamation-triangle text-yellow-600',
        'info': 'fa-info-circle text-blue-600'
    };

    const alertClass = alertClasses[type] || alertClasses['info'];
    const iconClass = iconClasses[type] || iconClasses['info'];

    container.innerHTML = `
        <div class="alert-enter flex items-start gap-2.5 p-3 ${alertClass} border rounded-lg mb-4">
            <i class="fas ${iconClass} text-sm mt-0.5"></i>
            <div class="flex-1">
                <p class="text-xs font-medium">${message}</p>
            </div>
            <button onclick="this.parentElement.remove()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <i class="fas fa-times text-xs"></i>
            </button>
        </div>
    `;

    // Auto-hide after 5 seconds
    setTimeout(() => {
        const alert = container.querySelector('.alert-enter');
        if (alert) {
            alert.style.opacity = '0';
            alert.style.transform = 'translateY(-10px)';
            setTimeout(() => alert.remove(), 300);
        }
    }, 5000);
}

// Initial load
document.addEventListener('DOMContentLoaded', function() {
    loadStatus();
    loadConfig();
    loadTeamsStatus();

    // Auto-refresh every 30 seconds
    refreshInterval = setInterval(loadStatus, 30000);
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});
</script>
{% endblock %}