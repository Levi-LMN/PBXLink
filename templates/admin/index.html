{% extends "base.html" %}

{% block title %}Admin Dashboard - Sibasi PBX{% endblock %}
{% block page_title %}System Administration{% endblock %}

{% block content %}
<div class="space-y-4">
    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
        <div class="bg-white rounded-xl border border-gray-100 p-4">
            <div class="w-10 h-10 bg-blue-50 rounded-lg flex items-center justify-center mb-3">
                <i class="fas fa-users text-blue-600"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-1" id="total-users">-</h3>
            <p class="text-xs text-gray-500 font-medium uppercase tracking-wide">Total Users</p>
        </div>

        <div class="bg-white rounded-xl border border-gray-100 p-4">
            <div class="w-10 h-10 bg-green-50 rounded-lg flex items-center justify-center mb-3">
                <i class="fas fa-user-check text-green-600"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-1" id="active-users">-</h3>
            <p class="text-xs text-gray-500 font-medium uppercase tracking-wide">Active Users</p>
        </div>

        <div class="bg-white rounded-xl border border-gray-100 p-4">
            <div class="w-10 h-10 bg-yellow-50 rounded-lg flex items-center justify-center mb-3">
                <i class="fas fa-history text-yellow-600"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-1" id="audit-count">-</h3>
            <p class="text-xs text-gray-500 font-medium uppercase tracking-wide">Audit Logs (7d)</p>
        </div>

        <div class="bg-white rounded-xl border border-gray-100 p-4">
            <div class="w-10 h-10 bg-cyan-50 rounded-lg flex items-center justify-center mb-3">
                <i class="fas fa-robot text-cyan-600"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-1" id="ai-calls-count">-</h3>
            <p class="text-xs text-gray-500 font-medium uppercase tracking-wide">AI Agent Calls (7d)</p>
        </div>
    </div>

    <!-- Main Tabs -->
    <div class="bg-white rounded-xl border border-gray-100">
        <div class="border-b border-gray-100">
            <nav class="flex -mb-px" id="adminTabs">
                <button class="tab-btn active px-6 py-3 text-sm font-semibold border-b-2 border-blue-600 text-blue-600" data-tab="users">
                    <i class="fas fa-users mr-2"></i>User Management
                </button>
                <button class="tab-btn px-6 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="audit">
                    <i class="fas fa-clipboard-list mr-2"></i>Audit Logs
                </button>
                <button class="tab-btn px-6 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="ai-calls">
                    <i class="fas fa-robot mr-2"></i>AI Agent Calls
                </button>
                <button class="tab-btn px-6 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="cleanup">
                    <i class="fas fa-broom mr-2"></i>Log Cleanup
                </button>
            </nav>
        </div>

        <div class="p-4">
            <!-- Users Tab -->
            <div class="tab-content" id="users-content">
                <div class="flex justify-between items-center mb-4">
                    <h5 class="text-base font-semibold text-gray-900 flex items-center gap-2">
                        <i class="fas fa-users text-blue-600"></i>User Management
                    </h5>
                    <button class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-xs font-semibold transition-colors" onclick="showCreateUserModal()">
                        <i class="fas fa-plus mr-2"></i>Add User
                    </button>
                </div>
                <div id="users-list" class="space-y-3">
                    <div class="text-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                    </div>
                </div>
            </div>

            <!-- Audit Logs Tab -->
            <div class="tab-content hidden" id="audit-content">
                <div class="flex justify-between items-center mb-4">
                    <h5 class="text-base font-semibold text-gray-900 flex items-center gap-2">
                        <i class="fas fa-clipboard-list text-blue-600"></i>Audit Logs
                    </h5>
                    <div class="flex gap-2">
                        <select class="px-3 py-2 text-xs border border-gray-200 rounded-lg" id="audit-filter">
                            <option value="">All Types</option>
                            <option value="user">Users</option>
                            <option value="admin_page">Admin Pages</option>
                            <option value="audit_logs">Audit Logs</option>
                            <option value="ai_agent_call_logs">AI Agent Calls</option>
                        </select>
                        <button class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-xs font-semibold transition-colors" onclick="loadAuditLogs()">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh
                        </button>
                    </div>
                </div>
                <div id="audit-logs-list">
                    <div class="text-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                    </div>
                </div>
            </div>

            <!-- AI Agent Calls Tab -->
            <div class="tab-content hidden" id="ai-calls-content">
                <div class="flex justify-between items-center mb-4">
                    <h5 class="text-base font-semibold text-gray-900 flex items-center gap-2">
                        <i class="fas fa-robot text-blue-600"></i>AI Agent Call Logs
                    </h5>
                    <button class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-xs font-semibold transition-colors" onclick="loadAIAgentCalls()">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                </div>

                <!-- AI Call Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                    <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                        <p class="text-xs text-gray-500 mb-1">Total Calls (7d)</p>
                        <h4 class="text-xl font-bold text-gray-900" id="ai-total-calls">-</h4>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                        <p class="text-xs text-gray-500 mb-1">Avg Duration</p>
                        <h4 class="text-xl font-bold text-gray-900" id="ai-avg-duration">-</h4>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                        <p class="text-xs text-gray-500 mb-1">Sentiment Distribution</p>
                        <div id="sentiment-dist" class="mt-2 flex flex-wrap gap-1"></div>
                    </div>
                </div>

                <div id="ai-calls-list">
                    <div class="text-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                    </div>
                </div>
            </div>

            <!-- Log Cleanup Tab -->
            <div class="tab-content hidden" id="cleanup-content">
                <h5 class="text-base font-semibold text-gray-900 flex items-center gap-2 mb-4">
                    <i class="fas fa-broom text-blue-600"></i>Log Cleanup Management
                </h5>

                <!-- Cleanup Statistics -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="bg-gradient-to-br from-blue-600 to-cyan-600 rounded-xl p-4 text-white">
                        <h6 class="text-sm font-medium mb-2 flex items-center gap-2">
                            <i class="fas fa-clipboard-list"></i>Audit Logs
                        </h6>
                        <div class="text-3xl font-bold mb-2" id="audit-log-count">-</div>
                        <p class="text-xs opacity-75 mb-3">Total records in database</p>
                        <div class="border-t border-white/30 pt-3 flex justify-between text-xs">
                            <span>Retention: <strong id="audit-retention">-</strong> days</span>
                            <span>Size: <strong id="audit-size">-</strong></span>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-cyan-600 to-blue-600 rounded-xl p-4 text-white">
                        <h6 class="text-sm font-medium mb-2 flex items-center gap-2">
                            <i class="fas fa-robot"></i>AI Agent Logs
                        </h6>
                        <div class="text-3xl font-bold mb-2" id="ai-log-count">-</div>
                        <p class="text-xs opacity-75 mb-3">Total records in database</p>
                        <div class="border-t border-white/30 pt-3 flex justify-between text-xs">
                            <span>Retention: <strong id="ai-retention">-</strong> days</span>
                            <span>Size: <strong id="ai-size">-</strong></span>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-green-600 to-teal-500 rounded-xl p-4 text-white">
                        <h6 class="text-sm font-medium mb-2 flex items-center gap-2">
                            <i class="fas fa-database"></i>Total Storage
                        </h6>
                        <div class="text-3xl font-bold mb-2" id="total-log-count">-</div>
                        <p class="text-xs opacity-75 mb-3">Combined log records</p>
                        <div class="border-t border-white/30 pt-3 flex justify-between text-xs">
                            <span>Check Interval: <strong id="cleanup-interval">-</strong>h</span>
                            <span>Total: <strong id="total-size">-</strong></span>
                        </div>
                    </div>
                </div>

                <!-- Cleanup Actions -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-white rounded-xl border border-gray-100 p-4">
                        <h6 class="text-sm font-semibold text-gray-900 mb-2 flex items-center gap-2">
                            <i class="fas fa-clipboard-list text-blue-600"></i>Audit Logs
                        </h6>
                        <p class="text-xs text-gray-500 mb-3">Remove old audit logs based on retention policy</p>
                        <div class="mb-3">
                            <label class="block text-xs font-medium text-gray-700 mb-1">Retention Days</label>
                            <input type="number" class="w-full px-3 py-2 text-xs border border-gray-200 rounded-lg" id="audit-retention-input" value="90" min="1">
                        </div>
                        <button class="w-full px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg text-xs font-semibold transition-colors" onclick="cleanupAuditLogs()">
                            <i class="fas fa-broom mr-2"></i>Cleanup Audit Logs
                        </button>
                    </div>

                    <div class="bg-white rounded-xl border border-gray-100 p-4">
                        <h6 class="text-sm font-semibold text-gray-900 mb-2 flex items-center gap-2">
                            <i class="fas fa-robot text-blue-600"></i>AI Agent Logs
                        </h6>
                        <p class="text-xs text-gray-500 mb-3">Remove old AI agent call logs</p>
                        <div class="mb-3">
                            <label class="block text-xs font-medium text-gray-700 mb-1">Retention Days</label>
                            <input type="number" class="w-full px-3 py-2 text-xs border border-gray-200 rounded-lg" id="ai-retention-input" value="90" min="1">
                        </div>
                        <button class="w-full px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg text-xs font-semibold transition-colors" onclick="cleanupAIAgentLogs()">
                            <i class="fas fa-broom mr-2"></i>Cleanup AI Logs
                        </button>
                    </div>

                    <div class="bg-white rounded-xl border border-red-200 p-4">
                        <h6 class="text-sm font-semibold text-red-600 mb-2 flex items-center gap-2">
                            <i class="fas fa-exclamation-triangle"></i>All Logs
                        </h6>
                        <p class="text-xs text-gray-500 mb-3">Cleanup all log types at once using default retention</p>
                        <div class="mb-3">
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-2 text-xs text-yellow-800">
                                <i class="fas fa-info-circle mr-1"></i>
                                Uses default retention policies
                            </div>
                        </div>
                        <button class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-xs font-semibold transition-colors" onclick="cleanupAllLogs()">
                            <i class="fas fa-trash-alt mr-2"></i>Cleanup All Logs
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit User Modal -->
<div id="userModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-xl w-full max-w-md mx-4">
        <div class="flex justify-between items-center px-6 py-4 border-b border-gray-100">
            <h5 class="text-base font-semibold" id="userModalTitle">Add New User</h5>
            <button onclick="closeModal('userModal')" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-6">
            <form id="userForm">
                <input type="hidden" id="userId">
                <div class="mb-4">
                    <label class="block text-xs font-medium text-gray-700 mb-1">Name</label>
                    <input type="text" class="w-full px-3 py-2 text-xs border border-gray-200 rounded-lg" id="userName" required>
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" class="w-full px-3 py-2 text-xs border border-gray-200 rounded-lg" id="userEmail" required>
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-medium text-gray-700 mb-1">Role</label>
                    <select class="w-full px-3 py-2 text-xs border border-gray-200 rounded-lg" id="userRole" required>
                        <option value="VIEWER">Viewer</option>
                        <option value="EDITOR">Editor</option>
                        <option value="ADMIN">Admin</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-medium text-gray-700 mb-1">Azure AD ID (Optional)</label>
                    <input type="text" class="w-full px-3 py-2 text-xs border border-gray-200 rounded-lg" id="azureId">
                </div>
            </form>
        </div>
        <div class="flex justify-end gap-2 px-6 py-4 border-t border-gray-100">
            <button onclick="closeModal('userModal')" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-xs font-semibold transition-colors">Cancel</button>
            <button onclick="saveUser()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-xs font-semibold transition-colors">Save User</button>
        </div>
    </div>
</div>

<!-- AI Call Details Modal -->
<div id="aiCallModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-xl w-full max-w-3xl mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center px-6 py-4 border-b border-gray-100 sticky top-0 bg-white">
            <h5 class="text-base font-semibold">AI Agent Call Details</h5>
            <button onclick="closeModal('aiCallModal')" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-6" id="aiCallDetails">
            <div class="text-center py-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
            </div>
        </div>
    </div>
</div>

<style>
.tab-btn.active {
    border-color: #2563eb;
    color: #2563eb;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Tab switching
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const targetTab = this.dataset.tab;

        // Update buttons
        document.querySelectorAll('.tab-btn').forEach(b => {
            b.classList.remove('active', 'border-blue-600', 'text-blue-600');
            b.classList.add('border-transparent', 'text-gray-500');
        });
        this.classList.add('active', 'border-blue-600', 'text-blue-600');
        this.classList.remove('border-transparent', 'text-gray-500');

        // Update content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
        });
        document.getElementById(targetTab + '-content').classList.remove('hidden');

        // Load data for specific tabs
        if (targetTab === 'audit') loadAuditLogs();
        if (targetTab === 'ai-calls') { loadAIAgentCalls(); loadAICallStats(); }
        if (targetTab === 'cleanup') loadLogStatistics();
    });
});

function showModal(modalId) {
    document.getElementById(modalId).classList.remove('hidden');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.add('hidden');
}

document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
    loadStats();
});

async function loadStats() {
    try {
        const response = await fetch('/admin/api/users');
        const data = await response.json();
        if (data.success) {
            document.getElementById('total-users').textContent = data.users.length;
            document.getElementById('active-users').textContent = data.users.filter(u => u.is_active).length;
        }
    } catch (error) {
        console.error('Error loading stats:', error);
    }

    try {
        const auditRes = await fetch('/admin/api/audit-logs/stats?days=7');
        const auditData = await auditRes.json();
        if (auditData.success) {
            document.getElementById('audit-count').textContent = auditData.stats.total_actions;
        }
    } catch (error) {
        console.error('Error loading audit stats:', error);
    }

    try {
        const aiRes = await fetch('/admin/api/ai-agent-calls/stats?days=7');
        const aiData = await aiRes.json();
        if (aiData.success) {
            document.getElementById('ai-calls-count').textContent = aiData.stats.total_calls;
        }
    } catch (error) {
        console.error('Error loading AI call stats:', error);
    }
}

async function loadUsers() {
    try {
        const response = await fetch('/admin/api/users');
        const data = await response.json();

        if (data.success && data.users.length > 0) {
            const html = data.users.map(user => {
                const initials = user.name.split(' ').map(n => n[0]).join('').toUpperCase();
                const roleColors = {
                    'ADMIN': 'bg-red-50 text-red-600',
                    'EDITOR': 'bg-blue-50 text-blue-600',
                    'VIEWER': 'bg-gray-50 text-gray-600'
                };

                return `
                    <div class="bg-white rounded-xl border border-gray-100 p-4">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white font-semibold text-sm">
                                    ${initials}
                                </div>
                                <div>
                                    <h6 class="text-sm font-semibold text-gray-900">${user.name}</h6>
                                    <p class="text-xs text-gray-500">${user.email}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="px-2 py-1 rounded text-xs font-semibold ${roleColors[user.role]}">${user.role}</span>
                                <span class="px-2 py-1 rounded text-xs font-semibold ${user.is_active ? 'bg-green-50 text-green-600' : 'bg-gray-50 text-gray-600'}">
                                    ${user.is_active ? 'Active' : 'Inactive'}
                                </span>
                                <div class="flex gap-1">
                                    <button class="w-8 h-8 flex items-center justify-center rounded-lg bg-blue-50 hover:bg-blue-100 text-blue-600 transition-colors" onclick="editUser(${user.id})" title="Edit">
                                        <i class="fas fa-edit text-xs"></i>
                                    </button>
                                    <button class="w-8 h-8 flex items-center justify-center rounded-lg ${user.is_active ? 'bg-yellow-50 hover:bg-yellow-100 text-yellow-600' : 'bg-green-50 hover:bg-green-100 text-green-600'} transition-colors"
                                            onclick="toggleUserActive(${user.id}, ${!user.is_active})"
                                            title="${user.is_active ? 'Deactivate' : 'Activate'}">
                                        <i class="fas fa-${user.is_active ? 'ban' : 'check'} text-xs"></i>
                                    </button>
                                    <button class="w-8 h-8 flex items-center justify-center rounded-lg bg-red-50 hover:bg-red-100 text-red-600 transition-colors" onclick="deleteUser(${user.id})" title="Delete">
                                        <i class="fas fa-trash text-xs"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('users-list').innerHTML = html;
        } else {
            document.getElementById('users-list').innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-users text-4xl mb-2"></i>
                    <p>No users found</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading users:', error);
        showAlert('Error loading users', 'danger');
    }
}

function showCreateUserModal() {
    document.getElementById('userModalTitle').textContent = 'Add New User';
    document.getElementById('userForm').reset();
    document.getElementById('userId').value = '';
    showModal('userModal');
}

async function editUser(userId) {
    try {
        const response = await fetch(`/admin/api/users/${userId}`);
        const data = await response.json();

        if (data.success) {
            document.getElementById('userModalTitle').textContent = 'Edit User';
            document.getElementById('userId').value = data.user.id;
            document.getElementById('userName').value = data.user.name;
            document.getElementById('userEmail').value = data.user.email;
            document.getElementById('userRole').value = data.user.role;
            document.getElementById('azureId').value = data.user.azure_id || '';
            showModal('userModal');
        }
    } catch (error) {
        console.error('Error loading user:', error);
        showAlert('Error loading user details', 'danger');
    }
}

async function saveUser() {
    const userId = document.getElementById('userId').value;
    const userData = {
        name: document.getElementById('userName').value,
        email: document.getElementById('userEmail').value,
        role: document.getElementById('userRole').value,
        azure_id: document.getElementById('azureId').value || null
    };

    try {
        const url = userId ? `/admin/api/users/${userId}` : '/admin/api/users';
        const method = userId ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(userData)
        });

        const data = await response.json();

        if (data.success) {
            showAlert(data.message, 'success');
            closeModal('userModal');
            loadUsers();
            loadStats();
        } else {
            showAlert(data.error, 'danger');
        }
    } catch (error) {
        console.error('Error saving user:', error);
        showAlert('Error saving user', 'danger');
    }
}

async function toggleUserActive(userId, isActive) {
    if (!confirm(`Are you sure you want to ${isActive ? 'activate' : 'deactivate'} this user?`)) return;

    try {
        const response = await fetch(`/admin/api/users/${userId}/active`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_active: isActive })
        });

        const data = await response.json();

        if (data.success) {
            showAlert(data.message, 'success');
            loadUsers();
            loadStats();
        } else {
            showAlert(data.error, 'danger');
        }
    } catch (error) {
        console.error('Error updating user status:', error);
        showAlert('Error updating user status', 'danger');
    }
}

async function deleteUser(userId) {
    if (!confirm('Are you sure you want to delete this user? This will deactivate their account.')) return;

    try {
        const response = await fetch(`/admin/api/users/${userId}`, {
            method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
            showAlert(data.message, 'success');
            loadUsers();
            loadStats();
        } else {
            showAlert(data.error, 'danger');
        }
    } catch (error) {
        console.error('Error deleting user:', error);
        showAlert('Error deleting user', 'danger');
    }
}

async function loadAuditLogs() {
    const filter = document.getElementById('audit-filter').value;
    const url = filter ? `/admin/api/audit-logs?resource_type=${filter}` : '/admin/api/audit-logs';

    try {
        const response = await fetch(url);
        const data = await response.json();

        if (data.success && data.logs.length > 0) {
            const html = data.logs.map(log => {
                const actionColors = {
                    'view': 'border-cyan-500',
                    'create': 'border-green-500',
                    'update': 'border-yellow-500',
                    'delete': 'border-red-500',
                    'cleanup': 'border-purple-500'
                };
                const borderClass = actionColors[log.action] || 'border-gray-300';
                const date = new Date(log.timestamp).toLocaleString();
                const details = typeof log.details === 'object'
                    ? JSON.stringify(log.details, null, 2)
                    : log.details;

                return `
                    <div class="p-3 bg-gray-50 rounded-lg border-l-3 ${borderClass}">
                        <div class="flex justify-between items-start mb-1">
                            <div>
                                <span class="font-semibold text-xs">${log.action}</span> on
                                <span class="px-2 py-0.5 bg-white border border-gray-200 rounded text-xs">${log.resource_type}</span>
                                ${log.resource_id ? `<span class="text-xs text-gray-500">(ID: ${log.resource_id})</span>` : ''}
                                by <span class="font-semibold text-xs">${log.user_name}</span>
                            </div>
                            <span class="text-xs text-gray-500">${date}</span>
                        </div>
                        ${details && details !== 'null' ? `<pre class="mt-2 text-xs text-gray-600 overflow-x-auto">${details}</pre>` : ''}
                    </div>
                `;
            }).join('');
            document.getElementById('audit-logs-list').innerHTML = html;
        } else {
            document.getElementById('audit-logs-list').innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-clipboard-list text-4xl mb-2"></i>
                    <p>No audit logs found</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading audit logs:', error);
        showAlert('Error loading audit logs', 'danger');
    }
}

async function loadAIAgentCalls() {
    try {
        const response = await fetch('/admin/api/ai-agent-calls');
        const data = await response.json();

        if (data.success && data.calls.length > 0) {
            const html = data.calls.map(call => {
                const date = new Date(call.call_date).toLocaleString();
                const sentimentColors = {
                    'positive': 'bg-green-50 text-green-600',
                    'negative': 'bg-red-50 text-red-600',
                    'neutral': 'bg-gray-50 text-gray-600'
                };
                const sentimentClass = sentimentColors[call.sentiment] || 'bg-gray-50 text-gray-600';

                return `
                    <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="flex justify-between items-start">
                            <div class="flex-grow">
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="fas fa-phone text-blue-600"></i>
                                    <span class="font-semibold text-xs">${call.caller_number || 'Unknown'}</span>
                                    <i class="fas fa-arrow-right text-gray-400 text-xs"></i>
                                    <span class="text-xs">${call.called_number || 'N/A'}</span>
                                </div>
                                <div class="flex gap-2 flex-wrap">
                                    ${call.intent ? `<span class="px-2 py-0.5 bg-cyan-50 text-cyan-600 rounded text-xs font-semibold">${call.intent}</span>` : ''}
                                    ${call.sentiment ? `<span class="px-2 py-0.5 ${sentimentClass} rounded text-xs font-semibold">${call.sentiment}</span>` : ''}
                                    <span class="px-2 py-0.5 bg-white border border-gray-200 rounded text-xs">${call.call_duration}s</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-gray-500 mb-2">${date}</div>
                                <button class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-xs font-semibold transition-colors"
                                        onclick="viewAICallDetails('${call.call_id}')">
                                    <i class="fas fa-eye"></i> Details
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('ai-calls-list').innerHTML = html;
        } else {
            document.getElementById('ai-calls-list').innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-robot text-4xl mb-2"></i>
                    <p>No AI agent calls found</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading AI calls:', error);
        showAlert('Error loading AI agent calls', 'danger');
    }
}

async function loadAICallStats() {
    try {
        const response = await fetch('/admin/api/ai-agent-calls/stats?days=7');
        const data = await response.json();

        if (data.success) {
            document.getElementById('ai-total-calls').textContent = data.stats.total_calls;
            document.getElementById('ai-avg-duration').textContent =
                data.stats.avg_duration ? `${data.stats.avg_duration}s` : '0s';

            const sentimentHtml = data.stats.sentiment_distribution.map(s =>
                `<span class="px-2 py-0.5 bg-gray-200 text-gray-700 rounded text-xs">${s.sentiment}: ${s.count}</span>`
            ).join('');
            document.getElementById('sentiment-dist').innerHTML = sentimentHtml || 'No data';
        }
    } catch (error) {
        console.error('Error loading AI call stats:', error);
    }
}

async function viewAICallDetails(callId) {
    try {
        const response = await fetch(`/admin/api/ai-agent-calls/${callId}`);
        const data = await response.json();

        if (data.success) {
            const call = data.call;
            const sentimentColors = {
                'positive': 'bg-green-50 text-green-600',
                'negative': 'bg-red-50 text-red-600',
                'neutral': 'bg-gray-50 text-gray-600'
            };
            const sentimentClass = sentimentColors[call.sentiment] || 'bg-gray-50 text-gray-600';

            const html = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h6 class="text-xs font-semibold text-gray-500 mb-3">Call Information</h6>
                        <div class="space-y-2">
                            <div class="flex justify-between text-xs">
                                <span class="text-gray-500">Call ID:</span>
                                <span class="font-semibold">${call.call_id}</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-gray-500">Caller:</span>
                                <span class="font-semibold">${call.caller_number || 'Unknown'}</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-gray-500">Called:</span>
                                <span class="font-semibold">${call.called_number || 'N/A'}</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-gray-500">Duration:</span>
                                <span class="font-semibold">${call.call_duration}s</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-gray-500">Date:</span>
                                <span class="font-semibold">${new Date(call.call_date).toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h6 class="text-xs font-semibold text-gray-500 mb-3">Analysis</h6>
                        <div class="space-y-2">
                            <div class="flex justify-between text-xs">
                                <span class="text-gray-500">Intent:</span>
                                <span class="px-2 py-0.5 bg-cyan-50 text-cyan-600 rounded font-semibold">${call.intent || 'Unknown'}</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-gray-500">Sentiment:</span>
                                <span class="px-2 py-0.5 ${sentimentClass} rounded font-semibold">${call.sentiment || 'Unknown'}</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-gray-500">Language:</span>
                                <span class="font-semibold">${call.language_detected || 'N/A'}</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-gray-500">Confidence:</span>
                                <span class="font-semibold">${call.confidence_score ? (call.confidence_score * 100).toFixed(1) + '%' : 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                </div>
                ${call.transcript ? `
                    <div class="mt-4">
                        <h6 class="text-xs font-semibold text-gray-500 mb-2">Transcript</h6>
                        <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                            <pre class="text-xs text-gray-700 whitespace-pre-wrap">${call.transcript}</pre>
                        </div>
                    </div>
                ` : ''}
                ${call.summary ? `
                    <div class="mt-4">
                        <h6 class="text-xs font-semibold text-gray-500 mb-2">Summary</h6>
                        <p class="text-xs text-gray-700">${call.summary}</p>
                    </div>
                ` : ''}
            `;
            document.getElementById('aiCallDetails').innerHTML = html;
            showModal('aiCallModal');
        }
    } catch (error) {
        console.error('Error loading call details:', error);
        showAlert('Error loading call details', 'danger');
    }
}

async function loadLogStatistics() {
    try {
        const [statsRes, configRes] = await Promise.all([
            fetch('/admin/api/logs/statistics'),
            fetch('/admin/api/logs/retention-config')
        ]);

        const statsData = await statsRes.json();
        const configData = await configRes.json();

        if (statsData.status === 'success') {
            const stats = statsData.statistics;
            document.getElementById('audit-log-count').textContent = stats.audit_logs?.count || 0;
            document.getElementById('audit-size').textContent =
                (stats.audit_logs?.size_mb !== undefined ? stats.audit_logs.size_mb.toFixed(2) : '0.00') + ' MB';
            document.getElementById('ai-log-count').textContent = stats.ai_agent_logs?.count || 0;
            document.getElementById('ai-size').textContent =
                (stats.ai_agent_logs?.size_mb !== undefined ? stats.ai_agent_logs.size_mb.toFixed(2) : '0.00') + ' MB';
            document.getElementById('total-log-count').textContent = stats.total_logs || 0;
            document.getElementById('total-size').textContent =
                (stats.total_size_mb !== undefined ? stats.total_size_mb.toFixed(2) : '0.00') + ' MB';
        }

        if (configData.status === 'success') {
            const config = configData.config;
            document.getElementById('audit-retention').textContent = config.audit_log_retention_days || 90;
            document.getElementById('ai-retention').textContent = config.ai_agent_log_retention_days || 180;
            document.getElementById('cleanup-interval').textContent = config.cleanup_check_hours || 24;
            document.getElementById('audit-retention-input').value = config.audit_log_retention_days || 90;
            document.getElementById('ai-retention-input').value = config.ai_agent_log_retention_days || 180;
        }
    } catch (error) {
        console.error('Error loading log statistics:', error);
    }
}

async function cleanupAuditLogs() {
    const retentionDays = document.getElementById('audit-retention-input').value;

    if (!confirm(`Delete audit logs older than ${retentionDays} days?`)) return;

    try {
        const response = await fetch('/admin/api/logs/cleanup/audit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ retention_days: parseInt(retentionDays) })
        });

        const data = await response.json();

        if (data.status === 'success') {
            showAlert(`Successfully deleted ${data.deleted_count} audit logs`, 'success');
            loadLogStatistics();
        } else {
            showAlert(data.message, 'danger');
        }
    } catch (error) {
        console.error('Error cleaning up audit logs:', error);
        showAlert('Error cleaning up audit logs', 'danger');
    }
}

async function cleanupAIAgentLogs() {
    const retentionDays = document.getElementById('ai-retention-input').value;

    if (!confirm(`Delete AI agent logs older than ${retentionDays} days?`)) return;

    try {
        const response = await fetch('/admin/api/logs/cleanup/ai-agent', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ retention_days: parseInt(retentionDays) })
        });

        const data = await response.json();

        if (data.status === 'success') {
            showAlert(`Successfully deleted ${data.deleted_count} AI agent logs`, 'success');
            loadLogStatistics();
        } else {
            showAlert(data.message, 'danger');
        }
    } catch (error) {
        console.error('Error cleaning up AI agent logs:', error);
        showAlert('Error cleaning up AI agent logs', 'danger');
    }
}

async function cleanupAllLogs() {
    if (!confirm('Delete all old logs using default retention policies? This action affects both audit and AI agent logs.')) return;

    try {
        const response = await fetch('/admin/api/logs/cleanup/all', {
            method: 'POST'
        });

        const data = await response.json();

        if (data.status === 'success') {
            const stats = data.statistics;
            showAlert(
                `Successfully deleted ${stats.total_deleted} logs (${stats.audit_logs_deleted} audit, ${stats.ai_agent_logs_deleted} AI agent)`,
                'success'
            );
            loadLogStatistics();
        } else {
            showAlert(data.message, 'danger');
        }
    } catch (error) {
        console.error('Error cleaning up all logs:', error);
        showAlert('Error cleaning up all logs', 'danger');
    }
}

function showAlert(message, type) {
    const alertColors = {
        'success': 'bg-green-50 border-green-200 text-green-800',
        'danger': 'bg-red-50 border-red-200 text-red-800',
        'warning': 'bg-yellow-50 border-yellow-200 text-yellow-800',
        'info': 'bg-blue-50 border-blue-200 text-blue-800'
    };
    const alertClass = alertColors[type] || alertColors.info;

    const alertHtml = `
        <div class="fixed top-4 right-4 z-50 ${alertClass} border rounded-lg p-4 shadow-lg max-w-md animate-slide-in">
            <div class="flex items-start gap-3">
                <div class="flex-1 text-sm font-medium">${message}</div>
                <button onclick="this.parentElement.parentElement.remove()" class="text-current opacity-50 hover:opacity-100">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', alertHtml);

    setTimeout(() => {
        const alert = document.querySelector('.animate-slide-in');
        if (alert) alert.remove();
    }, 5000);
}
</script>
{% endblock %}