{% extends "base.html" %}

{% block title %}Call Detail Records - Sibasi PBX{% endblock %}
{% block page_title %}Call Detail Records{% endblock %}
{% block page_subtitle %}Detailed call analytics and statistics{% endblock %}

{% block content %}
<div class="space-y-4">
    <!-- Filters -->
    <div class="bg-white rounded-xl border border-gray-100 p-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
            <div>
                <label class="block text-xs font-semibold text-gray-700 mb-1">Time Period</label>
                <select class="w-full px-3 py-2 text-xs border border-gray-200 rounded-lg" id="days-filter">
                    <option value="1">Last 24 Hours</option>
                    <option value="7" selected>Last 7 Days</option>
                    <option value="30">Last 30 Days</option>
                    <option value="90">Last 90 Days</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-semibold text-gray-700 mb-1">Records per Page</label>
                <select class="w-full px-3 py-2 text-xs border border-gray-200 rounded-lg" id="per-page-filter">
                    <option value="25">25</option>
                    <option value="50" selected>50</option>
                    <option value="100">100</option>
                </select>
            </div>
            <div class="md:text-right">
                <button class="w-full md:w-auto px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-xs font-semibold transition-colors" onclick="loadAllData()">
                    <i class="fas fa-sync-alt mr-2"></i>Refresh Data
                </button>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
        <div class="bg-white rounded-xl border border-gray-100 p-4">
            <div class="w-10 h-10 bg-blue-50 rounded-lg flex items-center justify-center mb-3">
                <i class="fas fa-phone-volume text-blue-600"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-1" id="total-calls">0</h3>
            <p class="text-xs text-gray-500 font-medium uppercase tracking-wide">Total Calls</p>
        </div>

        <div class="bg-white rounded-xl border border-gray-100 p-4">
            <div class="w-10 h-10 bg-green-50 rounded-lg flex items-center justify-center mb-3">
                <i class="fas fa-check-circle text-green-600"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-1" id="answered-calls">0</h3>
            <p class="text-xs text-gray-500 font-medium uppercase tracking-wide">Answered</p>
        </div>

        <div class="bg-white rounded-xl border border-gray-100 p-4">
            <div class="w-10 h-10 bg-red-50 rounded-lg flex items-center justify-center mb-3">
                <i class="fas fa-phone-slash text-red-600"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-1" id="missed-calls">0</h3>
            <p class="text-xs text-gray-500 font-medium uppercase tracking-wide">Missed</p>
        </div>

        <div class="bg-white rounded-xl border border-gray-100 p-4">
            <div class="w-10 h-10 bg-yellow-50 rounded-lg flex items-center justify-center mb-3">
                <i class="fas fa-clock text-yellow-600"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-1" id="avg-duration">0m</h3>
            <p class="text-xs text-gray-500 font-medium uppercase tracking-wide">Avg Duration</p>
        </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="bg-white rounded-xl border border-gray-100">
            <div class="px-4 py-3 border-b border-gray-100">
                <h6 class="text-xs font-semibold text-gray-900 flex items-center gap-2">
                    <i class="fas fa-chart-pie text-blue-600"></i>Call Disposition
                </h6>
            </div>
            <div class="p-4">
                <div style="height: 250px">
                    <canvas id="disposition-chart"></canvas>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl border border-gray-100">
            <div class="px-4 py-3 border-b border-gray-100">
                <h6 class="text-xs font-semibold text-gray-900 flex items-center gap-2">
                    <i class="fas fa-chart-bar text-blue-600"></i>Hourly Distribution
                </h6>
            </div>
            <div class="p-4">
                <div style="height: 250px">
                    <canvas id="hourly-chart"></canvas>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl border border-gray-100">
            <div class="px-4 py-3 border-b border-gray-100">
                <h6 class="text-xs font-semibold text-gray-900 flex items-center gap-2">
                    <i class="fas fa-chart-line text-blue-600"></i>Daily Trends
                </h6>
            </div>
            <div class="p-4">
                <div style="height: 250px">
                    <canvas id="daily-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Callers & Destinations -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="bg-white rounded-xl border border-gray-100">
            <div class="px-4 py-3 border-b border-gray-100">
                <h6 class="text-xs font-semibold text-gray-900 flex items-center gap-2">
                    <i class="fas fa-user-friends text-blue-600"></i>Top Callers
                </h6>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-xs">
                    <thead class="bg-gray-50">
                        <tr class="border-b border-gray-100">
                            <th class="px-4 py-2 text-left font-semibold text-gray-600">Number</th>
                            <th class="px-4 py-2 text-right font-semibold text-gray-600">Calls</th>
                            <th class="px-4 py-2 text-right font-semibold text-gray-600">Answered</th>
                            <th class="px-4 py-2 text-right font-semibold text-gray-600">Duration</th>
                        </tr>
                    </thead>
                    <tbody id="top-callers-table" class="divide-y divide-gray-100">
                        <tr>
                            <td colspan="4" class="px-4 py-8 text-center text-gray-500">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="bg-white rounded-xl border border-gray-100">
            <div class="px-4 py-3 border-b border-gray-100">
                <h6 class="text-xs font-semibold text-gray-900 flex items-center gap-2">
                    <i class="fas fa-phone-square text-blue-600"></i>Top Destinations
                </h6>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-xs">
                    <thead class="bg-gray-50">
                        <tr class="border-b border-gray-100">
                            <th class="px-4 py-2 text-left font-semibold text-gray-600">Number</th>
                            <th class="px-4 py-2 text-right font-semibold text-gray-600">Calls</th>
                            <th class="px-4 py-2 text-right font-semibold text-gray-600">Answered</th>
                            <th class="px-4 py-2 text-right font-semibold text-gray-600">Duration</th>
                        </tr>
                    </thead>
                    <tbody id="top-destinations-table" class="divide-y divide-gray-100">
                        <tr>
                            <td colspan="4" class="px-4 py-8 text-center text-gray-500">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Call Records Table -->
    <div class="bg-white rounded-xl border border-gray-100">
        <div class="px-4 py-3 border-b border-gray-100 flex items-center justify-between">
            <h6 class="text-xs font-semibold text-gray-900 flex items-center gap-2">
                <i class="fas fa-list text-blue-600"></i>Call Records
            </h6>
            <span class="text-xs text-gray-500" id="pagination-info">-</span>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-xs">
                <thead class="bg-gray-50">
                    <tr class="border-b border-gray-100">
                        <th class="px-4 py-3 text-left font-semibold text-gray-600">Date/Time</th>
                        <th class="px-4 py-3 text-left font-semibold text-gray-600">Caller ID</th>
                        <th class="px-4 py-3 text-left font-semibold text-gray-600">Source</th>
                        <th class="px-4 py-3 text-left font-semibold text-gray-600">Destination</th>
                        <th class="px-4 py-3 text-left font-semibold text-gray-600">Duration</th>
                        <th class="px-4 py-3 text-left font-semibold text-gray-600">Status</th>
                    </tr>
                </thead>
                <tbody id="calls-table" class="divide-y divide-gray-100">
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center">
                            <div class="flex flex-col items-center justify-center">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-3"></div>
                                <span class="text-gray-500">Loading...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="px-4 py-3 border-t border-gray-100">
            <nav>
                <ul class="flex items-center justify-center gap-1" id="pagination"></ul>
            </nav>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let hourlyChart, dailyChart, dispositionChart;

async function loadStats() {
    try {
        const days = document.getElementById('days-filter').value;
        const response = await fetch(`/cdr/api/stats?days=${days}`);
        const data = await response.json();

        document.getElementById('total-calls').textContent = data.total_calls || 0;
        document.getElementById('answered-calls').textContent = data.answered_calls || 0;
        document.getElementById('missed-calls').textContent = data.missed_calls || 0;
        document.getElementById('avg-duration').textContent = data.avg_duration_formatted || '0s';

        loadDispositionChart(data);
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

function loadDispositionChart(stats) {
    try {
        const ctx = document.getElementById('disposition-chart').getContext('2d');

        if (dispositionChart) dispositionChart.destroy();

        const answered = stats.answered_calls || 0;
        const missed = stats.missed_calls || 0;

        dispositionChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Answered', 'Missed'],
                datasets: [{
                    data: [answered, missed],
                    backgroundColor: ['rgba(34, 197, 94, 0.8)', 'rgba(239, 68, 68, 0.8)'],
                    borderColor: ['rgb(34, 197, 94)', 'rgb(239, 68, 68)'],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { padding: 15, font: { size: 11 } } }
                }
            }
        });
    } catch (error) {
        console.error('Error loading disposition chart:', error);
    }
}

async function loadCalls(page = 1) {
    try {
        const days = document.getElementById('days-filter').value;
        const perPage = document.getElementById('per-page-filter').value;

        const response = await fetch(`/cdr/api/calls?days=${days}&page=${page}&per_page=${perPage}`);
        const data = await response.json();

        const tbody = document.getElementById('calls-table');
        tbody.innerHTML = '';

        if (data.calls.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">No call records found</td></tr>';
            return;
        }

        data.calls.forEach(call => {
            const statusColors = {
                'ANSWERED': 'bg-green-50 text-green-600',
                'NO ANSWER': 'bg-red-50 text-red-600',
                'BUSY': 'bg-yellow-50 text-yellow-600',
                'FAILED': 'bg-red-50 text-red-600'
            };
            const statusClass = statusColors[call.disposition] || 'bg-gray-100 text-gray-600';

            const row = `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3">${call.calldate}</td>
                    <td class="px-4 py-3">${call.caller_id}</td>
                    <td class="px-4 py-3">${call.source}</td>
                    <td class="px-4 py-3">${call.destination}</td>
                    <td class="px-4 py-3">${call.duration_formatted}</td>
                    <td class="px-4 py-3">
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold ${statusClass}">
                            ${call.disposition}
                        </span>
                    </td>
                </tr>
            `;
            tbody.insertAdjacentHTML('beforeend', row);
        });

        updatePagination(data.pagination);
        currentPage = page;
    } catch (error) {
        console.error('Error loading calls:', error);
    }
}

function updatePagination(pagination) {
    const info = document.getElementById('pagination-info');
    const start = ((pagination.page - 1) * pagination.per_page) + 1;
    const end = Math.min(pagination.page * pagination.per_page, pagination.total_records);
    info.textContent = `Showing ${start}-${end} of ${pagination.total_records} records`;

    const paginationEl = document.getElementById('pagination');
    paginationEl.innerHTML = '';

    const prevDisabled = pagination.page === 1;
    paginationEl.insertAdjacentHTML('beforeend', `
        <li>
            <button class="px-3 py-1.5 text-xs font-medium ${prevDisabled ? 'text-gray-400 cursor-not-allowed' : 'text-gray-700 hover:bg-gray-100'} rounded"
                    onclick="${prevDisabled ? '' : `loadCalls(${pagination.page - 1})`}" ${prevDisabled ? 'disabled' : ''}>
                Previous
            </button>
        </li>
    `);

    const maxPages = 5;
    let startPage = Math.max(1, pagination.page - 2);
    let endPage = Math.min(pagination.total_pages, startPage + maxPages - 1);

    for (let i = startPage; i <= endPage; i++) {
        const active = i === pagination.page;
        paginationEl.insertAdjacentHTML('beforeend', `
            <li>
                <button class="px-3 py-1.5 text-xs font-medium rounded ${active ? 'bg-blue-600 text-white' : 'text-gray-700 hover:bg-gray-100'}"
                        onclick="loadCalls(${i})">
                    ${i}
                </button>
            </li>
        `);
    }

    const nextDisabled = pagination.page === pagination.total_pages;
    paginationEl.insertAdjacentHTML('beforeend', `
        <li>
            <button class="px-3 py-1.5 text-xs font-medium ${nextDisabled ? 'text-gray-400 cursor-not-allowed' : 'text-gray-700 hover:bg-gray-100'} rounded"
                    onclick="${nextDisabled ? '' : `loadCalls(${pagination.page + 1})`}" ${nextDisabled ? 'disabled' : ''}>
                Next
            </button>
        </li>
    `);
}

async function loadHourlyStats() {
    try {
        const days = document.getElementById('days-filter').value;
        const response = await fetch(`/cdr/api/hourly-stats?days=${days}`);
        const result = await response.json();

        const ctx = document.getElementById('hourly-chart').getContext('2d');

        if (hourlyChart) hourlyChart.destroy();

        hourlyChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: result.data.map(d => `${d.hour}:00`),
                datasets: [{
                    label: 'Calls',
                    data: result.data.map(d => d.calls),
                    backgroundColor: 'rgba(59, 130, 246, 0.5)',
                    borderColor: 'rgb(59, 130, 246)',
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, ticks: { precision: 0, font: { size: 10 } } },
                    x: { ticks: { font: { size: 10 } } }
                }
            }
        });
    } catch (error) {
        console.error('Error loading hourly stats:', error);
    }
}

async function loadDailyStats() {
    try {
        const days = document.getElementById('days-filter').value;
        const response = await fetch(`/cdr/api/daily-stats?days=${days}`);
        const result = await response.json();

        const ctx = document.getElementById('daily-chart').getContext('2d');

        if (dailyChart) dailyChart.destroy();

        dailyChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: result.data.map(d => d.date),
                datasets: [
                    {
                        label: 'Total',
                        data: result.data.map(d => d.total),
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.3,
                        borderWidth: 2
                    },
                    {
                        label: 'Answered',
                        data: result.data.map(d => d.answered),
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        tension: 0.3,
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { font: { size: 11 } } } },
                scales: {
                    y: { beginAtZero: true, ticks: { precision: 0, font: { size: 10 } } }
                }
            }
        });
    } catch (error) {
        console.error('Error loading daily stats:', error);
    }
}

async function loadTopCallers() {
    try {
        const days = document.getElementById('days-filter').value;
        const response = await fetch(`/cdr/api/top-callers?days=${days}&limit=10`);
        const result = await response.json();

        const tbody = document.getElementById('top-callers-table');
        tbody.innerHTML = '';

        if (result.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-4 text-center text-gray-500">No data available</td></tr>';
            return;
        }

        result.data.forEach(caller => {
            tbody.insertAdjacentHTML('beforeend', `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2">${caller.number}</td>
                    <td class="px-4 py-2 text-right">${caller.total_calls}</td>
                    <td class="px-4 py-2 text-right">${caller.answered_calls}</td>
                    <td class="px-4 py-2 text-right">${caller.total_duration_formatted}</td>
                </tr>
            `);
        });
    } catch (error) {
        console.error('Error loading top callers:', error);
    }
}

async function loadTopDestinations() {
    try {
        const days = document.getElementById('days-filter').value;
        const response = await fetch(`/cdr/api/top-destinations?days=${days}&limit=10`);
        const result = await response.json();

        const tbody = document.getElementById('top-destinations-table');
        tbody.innerHTML = '';

        if (result.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-4 text-center text-gray-500">No data available</td></tr>';
            return;
        }

        result.data.forEach(dest => {
            tbody.insertAdjacentHTML('beforeend', `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2">${dest.number}</td>
                    <td class="px-4 py-2 text-right">${dest.total_calls}</td>
                    <td class="px-4 py-2 text-right">${dest.answered_calls}</td>
                    <td class="px-4 py-2 text-right">${dest.total_duration_formatted}</td>
                </tr>
            `);
        });
    } catch (error) {
        console.error('Error loading top destinations:', error);
    }
}

function loadAllData() {
    loadStats();
    loadCalls(1);
    loadHourlyStats();
    loadDailyStats();
    loadTopCallers();
    loadTopDestinations();
}

document.addEventListener('DOMContentLoaded', function() {
    loadAllData();
    document.getElementById('days-filter').addEventListener('change', loadAllData);
    document.getElementById('per-page-filter').addEventListener('change', () => loadCalls(1));
});
</script>
{% endblock %}