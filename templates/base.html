<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Sibasi PBX{% endblock %}</title>

    <!-- Icon -->
    <link rel="icon" href="../static/img/sibasifavicon.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        'primary-dark': '#1e40af',
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        * {
            font-family: 'Inter', sans-serif;
        }

        .sidebar-scroll::-webkit-scrollbar {
            width: 5px;
        }

        .sidebar-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar-scroll::-webkit-scrollbar-thumb {
            background: #e5e7eb;
            border-radius: 3px;
        }

        .nav-link-item {
            transition: all 0.2s ease;
        }

        .nav-link-item:hover {
            transform: translateX(3px);
        }

        .nav-link-active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 65%;
            background: #2563eb;
            border-radius: 0 4px 4px 0;
        }
    </style>

    {% block extra_css %}{% endblock %}
</head>
<body class="bg-gray-50 text-gray-900 text-[13px] antialiased">

    <!-- Mobile Overlay -->
    <div id="overlay" class="hidden fixed inset-0 bg-black/50 z-40 md:hidden"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed top-0 left-0 h-screen w-56 bg-white border-r border-gray-100 z-50 -translate-x-full md:translate-x-0 transition-transform duration-300 flex flex-col sidebar-scroll overflow-y-auto">

        <!-- Brand Header -->
        <div class="p-5 border-b border-gray-100">
            <a href="/" class="flex items-center gap-2.5 group">
                <div class="w-8 h-8 bg-blue-600 rounded-xl flex items-center justify-center text-white group-hover:bg-blue-700 transition-colors overflow-hidden">
                    <img src="../static/img/sibasifavicon.png" alt="Sibasi Logo" class="w-6 h-6 object-contain">
                </div>
                <div>
                    <h4 class="text-sm font-bold text-gray-900">Sibasi PBX</h4>
                    <p class="text-[10px] text-gray-500">Communication Hub</p>
                </div>
            </a>
        </div>

        <!-- Search -->
        <div class="px-4 py-3">
            <div class="relative">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-[10px]"></i>
                <input
                    type="text"
                    id="sidebarSearch"
                    placeholder="Search..."
                    class="w-full pl-8 pr-3 py-2 text-xs bg-gray-50 border-0 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-500 focus:bg-white transition-colors placeholder:text-gray-400"
                >
            </div>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 px-3 py-2">
            <!-- Main Section -->
            <div class="mb-5">
                <p class="px-3 mb-1.5 text-[10px] font-semibold text-gray-400 uppercase tracking-wide">Menu</p>

                <a href="/" class="nav-link-item relative flex items-center gap-2.5 px-3 py-2 rounded-lg text-gray-600 hover:text-gray-900 hover:bg-gray-50 {% if request.endpoint and request.endpoint == 'index' %}nav-link-active bg-blue-50 text-blue-600{% endif %} mb-0.5">
                    <i class="fas fa-th-large w-4 text-center text-sm"></i>
                    <span class="font-medium text-xs">Dashboard</span>
                </a>

                <a href="/cdr/" class="nav-link-item relative flex items-center gap-2.5 px-3 py-2 rounded-lg text-gray-600 hover:text-gray-900 hover:bg-gray-50 {% if request.endpoint and 'cdr' in request.endpoint %}nav-link-active bg-blue-50 text-blue-600{% endif %} mb-0.5">
                    <i class="fas fa-chart-line w-4 text-center text-sm"></i>
                    <span class="font-medium text-xs">Call Records</span>
                </a>

                <a href="/extensions/" class="nav-link-item relative flex items-center gap-2.5 px-3 py-2 rounded-lg text-gray-600 hover:text-gray-900 hover:bg-gray-50 {% if request.endpoint and 'extensions' in request.endpoint %}nav-link-active bg-blue-50 text-blue-600{% endif %} mb-0.5">
                    <i class="fas fa-phone w-4 text-center text-sm"></i>
                    <span class="font-medium text-xs">Extensions</span>
                </a>
            </div>

            <!-- Services Section -->
            <div class="mb-5">
                <p class="px-3 mb-1.5 text-[10px] font-semibold text-gray-400 uppercase tracking-wide">Services</p>

                <a href="/wireguard/" class="nav-link-item relative flex items-center gap-2.5 px-3 py-2 rounded-lg text-gray-600 hover:text-gray-900 hover:bg-gray-50 {% if request.endpoint and 'wireguard' in request.endpoint %}nav-link-active bg-blue-50 text-blue-600{% endif %} mb-0.5">
                    <i class="fas fa-shield-alt w-4 text-center text-sm"></i>
                    <span class="font-medium text-xs">WireGuard VPN</span>
                </a>

                <a href="/ai_agent/" class="nav-link-item relative flex items-center gap-2.5 px-3 py-2 rounded-lg text-gray-600 hover:text-gray-900 hover:bg-gray-50 {% if request.endpoint and 'ai_agent' in request.endpoint %}nav-link-active bg-blue-50 text-blue-600{% endif %} mb-0.5">
                    <i class="fas fa-robot w-4 text-center text-sm"></i>
                    <span class="font-medium text-xs">AI Agent</span>
                </a>

                <a href="/tg100/" class="nav-link-item relative flex items-center gap-2.5 px-3 py-2 rounded-lg text-gray-600 hover:text-gray-900 hover:bg-gray-50 {% if request.endpoint and 'tg100' in request.endpoint %}nav-link-active bg-blue-50 text-blue-600{% endif %} mb-0.5">
                    <i class="fas fa-server w-4 text-center text-sm"></i>
                    <span class="font-medium text-xs">TG100 Gateway</span>
                </a>
            </div>

            {% if session.user and session.user.role == 'admin' %}
            <!-- System Section -->
            <div>
                <p class="px-3 mb-1.5 text-[10px] font-semibold text-gray-400 uppercase tracking-wide">System</p>

                <a href="/admin/" class="nav-link-item relative flex items-center gap-2.5 px-3 py-2 rounded-lg text-gray-600 hover:text-gray-900 hover:bg-gray-50 {% if request.endpoint and 'admin' in request.endpoint %}nav-link-active bg-blue-50 text-blue-600{% endif %} mb-0.5">
                    <i class="fas fa-users-cog w-4 text-center text-sm"></i>
                    <span class="font-medium text-xs">Admin Panel</span>
                </a>
            </div>
            {% endif %}
        </nav>

        <!-- User Section -->
        {% if session.user %}
        <div class="p-4 border-t border-gray-100">
            <div class="bg-gray-50 rounded-xl p-2.5 mb-2 cursor-pointer hover:bg-gray-100 transition-colors">
                <div class="flex items-center gap-2.5">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-semibold text-xs">
                        {{ session.user.name[0].upper() }}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs font-semibold text-gray-900 truncate">{{ session.user.name }}</p>
                        <p class="text-[10px] text-gray-500">{{ session.user.role|capitalize }}</p>
                    </div>
                </div>
            </div>
            <button onclick="logout()" class="w-full flex items-center justify-center gap-2 px-3 py-2 bg-white border border-gray-200 text-gray-600 rounded-lg text-xs font-medium hover:bg-red-50 hover:border-red-200 hover:text-red-600 transition-colors">
                <i class="fas fa-sign-out-alt text-[10px]"></i>
                <span>Sign Out</span>
            </button>
        </div>
        {% endif %}
    </aside>

    <!-- Main Content -->
    <div class="md:ml-56 min-h-screen transition-all duration-300">

        <!-- Top Bar -->
        <header class="sticky top-0 z-30 bg-white border-b border-gray-100">
            <div class="px-4 md:px-6 py-3.5 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="md:hidden w-8 h-8 flex items-center justify-center rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                        <i class="fas fa-bars text-sm"></i>
                    </button>
                    <div>
                        <h5 class="text-base font-bold text-gray-900">{% block page_title %}Dashboard{% endblock %}</h5>
                        <p class="text-[11px] text-gray-500 mt-0.5">{% block page_subtitle %}Plan, prioritize, and accomplish your tasks with ease.{% endblock %}</p>
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    <button onclick="window.location.reload()" class="w-8 h-8 flex items-center justify-center rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors" title="Refresh">
                        <i class="fas fa-sync-alt text-xs"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Content Area -->
        <main class="p-4 md:p-5">
            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="mb-5 space-y-2">
                        {% for category, message in messages %}
                        <div class="flex items-start gap-2.5 p-3 bg-white border {% if category == 'success' %}border-green-200 bg-green-50{% elif category == 'error' %}border-red-200 bg-red-50{% elif category == 'warning' %}border-yellow-200 bg-yellow-50{% else %}border-blue-200 bg-blue-50{% endif %} rounded-lg">
                            <i class="fas {% if category == 'success' %}fa-check-circle text-green-600{% elif category == 'error' %}fa-exclamation-circle text-red-600{% elif category == 'warning' %}fa-exclamation-triangle text-yellow-600{% else %}fa-info-circle text-blue-600{% endif %} text-sm mt-0.5"></i>
                            <div class="flex-1">
                                <p class="text-xs text-gray-900 font-medium">{{ message }}</p>
                            </div>
                            <button onclick="this.parentElement.remove()" class="text-gray-400 hover:text-gray-600 transition-colors">
                                <i class="fas fa-times text-xs"></i>
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}

            <!-- Page Content -->
            {% block content %}{% endblock %}
        </main>
    </div>

    <script>
        // Toggle sidebar (mobile)
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');

            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }

        // Close sidebar when clicking overlay
        document.getElementById('overlay').addEventListener('click', toggleSidebar);

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to sign out?')) {
                window.location.href = '{{ url_for("auth.logout") }}';
            }
        }

        // Search functionality
        document.getElementById('sidebarSearch').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const navLinks = document.querySelectorAll('.nav-link-item');

            navLinks.forEach(link => {
                const text = link.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    link.classList.remove('hidden');
                } else {
                    link.classList.add('hidden');
                }
            });

            // Hide section titles if all items are hidden
            const sections = document.querySelectorAll('nav > div');
            sections.forEach(section => {
                const visibleLinks = section.querySelectorAll('.nav-link-item:not(.hidden)');
                if (visibleLinks.length === 0) {
                    section.classList.add('hidden');
                } else {
                    section.classList.remove('hidden');
                }
            });
        });

        // Auto-dismiss flash messages
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                document.querySelectorAll('[class*="animate-"]').forEach(el => {
                    if (el.closest('main')) {
                        el.style.transition = 'opacity 0.3s ease-out';
                        el.style.opacity = '0';
                        setTimeout(() => el.remove(), 300);
                    }
                });
            }, 5000);
        });

        // Close sidebar on navigation (mobile)
        if (window.innerWidth < 768) {
            document.querySelectorAll('.nav-link-item').forEach(link => {
                link.addEventListener('click', () => {
                    const sidebar = document.getElementById('sidebar');
                    const overlay = document.getElementById('overlay');
                    sidebar.classList.add('-translate-x-full');
                    overlay.classList.add('hidden');
                });
            });
        }
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>