{% extends "base.html" %}

{% block title %}WireGuard VPN - FreePBX Dashboard{% endblock %}
{% block page_title %}WireGuard VPN Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Server Status -->
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="fas fa-server text-primary me-2"></i>Server Status</h6>
            <div>
                <button class="btn btn-sm btn-outline-secondary me-1" onclick="refreshStatus()" title="Refresh Status">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button class="btn btn-sm btn-primary me-1" onclick="restartWireGuard()" title="Restart WireGuard">
                    <i class="fas fa-redo"></i> Restart
                </button>
                <button class="btn btn-sm btn-success" onclick="initializeUsersDirectory()" title="Initialize Users Directory">
                    <i class="fas fa-folder-plus"></i> Init Dir
                </button>
            </div>
        </div>
        <div class="card-body">
            <div id="enhancedStatus" style="display: none;">
                <!-- Status Overview Cards -->
                <div class="row g-3 mb-4" id="statusOverview"></div>

                <!-- Interface Info -->
                <div class="alert alert-light mb-3" id="interfaceInfo"></div>

                <!-- Connected Peers -->
                <h6 class="mb-3"><i class="fas fa-users me-2"></i>Connected Peers</h6>
                <div id="peersList"></div>
            </div>

            <!-- Loading/Fallback Status -->
            <div id="statusLoading" class="text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="text-muted mb-0">Loading status...</p>
            </div>
            <pre id="serverStatus" class="bg-dark text-light p-3 rounded" style="display: none;"></pre>
        </div>
    </div>

    <!-- VPN Users -->
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="fas fa-users text-primary me-2"></i>VPN Users</h6>
            <button class="btn btn-success btn-sm" onclick="showAddUserModal()">
                <i class="fas fa-user-plus me-1"></i>Add User
            </button>
        </div>
        <div class="card-body">
            <div id="usersLoading" class="text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="text-muted mb-0">Loading users...</p>
            </div>

            <div id="usersTableContainer" style="display: none;">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Username</th>
                                <th>IP Address</th>
                                <th>Public Key</th>
                                <th>Status</th>
                                <th style="width: 220px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="noUsers" class="text-center py-5" style="display: none;">
                <i class="fas fa-user-slash fa-3x text-muted opacity-50 mb-3"></i>
                <p class="text-muted mb-0">No users found. Create your first VPN user to get started.</p>
            </div>
        </div>
    </div>

    <!-- Server Config -->
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="fas fa-cog text-primary me-2"></i>Server Configuration</h6>
            <button class="btn btn-sm btn-primary" onclick="showEditConfigModal()">
                <i class="fas fa-edit me-1"></i>Edit Config
            </button>
        </div>
        <div class="card-body">
            <div id="configLoading" class="text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="text-muted mb-0">Loading configuration...</p>
            </div>
            <pre id="serverConfig" class="bg-dark text-light p-3 rounded mb-0" style="display: none;"></pre>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-user-plus text-success me-2"></i>Add New VPN User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Username <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="newUsername" placeholder="e.g., john_doe" required>
                    <div class="form-text">Only letters, numbers, underscores, and hyphens allowed</div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Description</label>
                    <input type="text" class="form-control" id="newDescription" placeholder="Optional description">
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="useExistingKeys" onchange="toggleKeyFields()">
                    <label class="form-check-label fw-bold">Use Existing Keys</label>
                </div>
                <div id="keyFields" style="display: none;">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Private Key</label>
                        <textarea class="form-control font-monospace" id="newPrivateKey" rows="2" placeholder="Paste private key here"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Public Key</label>
                        <textarea class="form-control font-monospace" id="newPublicKey" rows="2" placeholder="Paste public key here"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="createUser()">
                    <i class="fas fa-check me-1"></i>Create User
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View User Config Modal -->
<div class="modal fade" id="viewUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-user text-primary me-2"></i>User Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <div class="alert alert-light mb-0">
                            <label class="small text-muted mb-1">Username</label>
                            <div class="fw-bold" id="viewUsername">-</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="alert alert-light mb-0">
                            <label class="small text-muted mb-1">IP Address</label>
                            <div class="fw-bold" id="viewUserIP">-</div>
                        </div>
                    </div>
                </div>
                <pre class="bg-dark text-light p-3 rounded mb-0" id="viewUserConfig">Loading...</pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="downloadConfigFromModal()">
                    <i class="fas fa-download me-1"></i>Download Config
                </button>
            </div>
        </div>
    </div>
</div>

<!-- QR Code Modal -->
<div class="modal fade" id="qrModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-qrcode text-primary me-2"></i>QR Code</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="qrImage" src="" class="img-fluid rounded" alt="QR Code" />
                <p class="text-muted mt-3 mb-0 small">
                    <i class="fas fa-mobile-alt me-1"></i>Scan with WireGuard mobile app
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Config Modal -->
<div class="modal fade" id="editConfigModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-edit text-primary me-2"></i>Edit Server Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> Editing the configuration directly can break your VPN. Make sure you know what you're doing.
                </div>
                <textarea class="form-control font-monospace" id="configEditor" rows="20" style="font-size: 0.85rem;"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveConfig()">
                    <i class="fas fa-save me-1"></i>Save & Restart
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Peer Details Modal -->
<div class="modal fade" id="peerDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-network-wired text-primary me-2"></i>Peer Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3 mb-3" id="peerDetailsFull"></div>
                <div id="peerTransferStatsFull"></div>
                <div class="d-flex gap-2 mt-3" id="peerActions"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentUser = null, currentPeer = null, statusData = null, usersData = [];
let addUserModal, viewUserModal, qrModal, editConfigModal, peerDetailModal;

document.addEventListener('DOMContentLoaded', function() {
    addUserModal = new bootstrap.Modal(document.getElementById('addUserModal'));
    viewUserModal = new bootstrap.Modal(document.getElementById('viewUserModal'));
    qrModal = new bootstrap.Modal(document.getElementById('qrModal'));
    editConfigModal = new bootstrap.Modal(document.getElementById('editConfigModal'));
    peerDetailModal = new bootstrap.Modal(document.getElementById('peerDetailModal'));

    loadEnhancedStatus();
    loadServerConfig();
    loadUsers();
});

function toggleKeyFields() {
    const keyFields = document.getElementById('keyFields');
    const useExisting = document.getElementById('useExistingKeys').checked;
    keyFields.style.display = useExisting ? 'block' : 'none';

    if (!useExisting) {
        document.getElementById('newPrivateKey').value = '';
        document.getElementById('newPublicKey').value = '';
    }
}

// Function to match peer to user by public key
function findUsernameForPeer(publicKey) {
    if (!usersData || !publicKey) return null;

    const user = usersData.find(u => u.public_key === publicKey);
    return user ? user.username : null;
}

async function loadEnhancedStatus() {
    try {
        const response = await fetch('/wireguard/api/status-ui');
        const data = await response.json();
        document.getElementById('statusLoading').style.display = 'none';

        if (data.success && data.status) {
            statusData = data.status;
            document.getElementById('enhancedStatus').style.display = 'block';
            displayEnhancedStatus(data.status);
        } else {
            await loadServerStatus();
        }
    } catch (error) {
        document.getElementById('statusLoading').style.display = 'none';
        await loadServerStatus();
    }
}

function displayEnhancedStatus(status) {
    const totalPeers = status.peers.length;
    const onlinePeers = status.peers.filter(peer => peer.status === 'online').length;
    const offlinePeers = status.peers.filter(peer => peer.status === 'offline').length;
    const stalePeers = totalPeers - onlinePeers - offlinePeers;

    // Status overview cards
    document.getElementById('statusOverview').innerHTML = `
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="mb-1">${totalPeers}</h3>
                    <small class="text-muted">Total Peers</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-success">
                <div class="card-body">
                    <h3 class="text-success mb-1">${onlinePeers}</h3>
                    <small class="text-muted">Online</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-warning">
                <div class="card-body">
                    <h3 class="text-warning mb-1">${stalePeers}</h3>
                    <small class="text-muted">Stale</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-danger">
                <div class="card-body">
                    <h3 class="text-danger mb-1">${offlinePeers}</h3>
                    <small class="text-muted">Offline</small>
                </div>
            </div>
        </div>
    `;

    // Interface info
    document.getElementById('interfaceInfo').innerHTML = `
        <h6 class="mb-2">Interface: <code>${status.interface.name || 'wg0'}</code></h6>
        <div class="row">
            <div class="col-md-6">
                <small class="text-muted">Public Key:</small>
                <div><code class="small">${status.interface.public_key || 'N/A'}</code></div>
            </div>
            <div class="col-md-6">
                <small class="text-muted">Listening Port:</small>
                <div><strong>${status.interface.port || 'N/A'}</strong></div>
            </div>
        </div>
    `;

    // Peers list
    if (status.peers.length > 0) {
        document.getElementById('peersList').innerHTML = status.peers.map((peer, index) => {
            const clientIp = peer.client_ip || 'Unknown';
            const peerStatus = peer.status || 'offline';
            const publicKey = peer.public_key_short || peer.public_key || '';
            const endpoint = peer.endpoint || 'N/A';
            const latestHandshake = peer.latest_handshake || 'Never';
            const transferReceived = peer.transfer_received_bytes || 0;
            const transferSent = peer.transfer_sent_bytes || 0;

            // Find username by matching public key
            const username = findUsernameForPeer(peer.public_key_full || peer.public_key);
            const displayName = username ? `${username} (${clientIp})` : clientIp;

            const statusBadgeClass = peerStatus === 'online' ? 'bg-success' :
                                     peerStatus === 'stale' ? 'bg-warning' : 'bg-danger';

            return `
            <div class="card mb-2">
                <div class="card-body py-3 px-3" style="cursor: pointer;" onclick="showPeerDetails(${index})">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">
                            <i class="fas fa-user-circle me-2 text-primary"></i>
                            ${displayName}
                        </h6>
                        <span class="badge ${statusBadgeClass} text-uppercase">${peerStatus}</span>
                    </div>
                    <div class="row g-2 small">
                        <div class="col-md-4">
                            <span class="text-muted">Public Key:</span>
                            <div><code class="small">${publicKey.substring(0, 20)}...</code></div>
                        </div>
                        <div class="col-md-4">
                            <span class="text-muted">Endpoint:</span>
                            <div><strong>${endpoint.split(':')[0]}</strong></div>
                        </div>
                        <div class="col-md-4">
                            <span class="text-muted">Last Handshake:</span>
                            <div><strong>${latestHandshake}</strong></div>
                        </div>
                    </div>
                    ${transferReceived > 0 || transferSent > 0 ? `
                    <div class="d-flex gap-3 mt-2 small">
                        <div>
                            <i class="fas fa-arrow-down text-success me-1"></i>
                            <strong>${formatBytes(transferReceived)}</strong>
                        </div>
                        <div>
                            <i class="fas fa-arrow-up text-primary me-1"></i>
                            <strong>${formatBytes(transferSent)}</strong>
                        </div>
                    </div>` : ''}
                </div>
            </div>
        `}).join('');
    } else {
        document.getElementById('peersList').innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-plug fa-3x text-muted opacity-50 mb-3"></i>
                <p class="text-muted mb-0">No peers connected</p>
            </div>
        `;
    }
}

function showPeerDetails(peerIndex) {
    currentPeer = peerIndex;

    if (statusData && statusData.peers && statusData.peers[peerIndex]) {
        displayPeerDetails(statusData.peers[peerIndex]);
    } else {
        fetch('/wireguard/api/status-ui').then(r => r.json()).then(data => {
            if (data.success && data.status && data.status.peers[peerIndex]) {
                statusData = data.status;
                displayPeerDetails(data.status.peers[peerIndex]);
            }
        }).catch(() => showToast('Error loading peer details', 'danger'));
    }
}

function displayPeerDetails(peer) {
    const username = findUsernameForPeer(peer.public_key_full || peer.public_key);
    const statusClass = peer.status === 'online' ? 'success' : peer.status === 'stale' ? 'warning' : 'danger';

    document.getElementById('peerDetailsFull').innerHTML = `
        ${username ? `
        <div class="col-md-6">
            <div class="alert alert-light mb-0">
                <label class="small text-muted mb-1">Username</label>
                <div class="fw-bold">${username}</div>
            </div>
        </div>
        ` : ''}
        <div class="col-md-6">
            <div class="alert alert-light mb-0">
                <label class="small text-muted mb-1">Client IP</label>
                <div class="fw-bold">${peer.client_ip || 'N/A'}</div>
            </div>
        </div>
        <div class="col-12">
            <div class="alert alert-light mb-0">
                <label class="small text-muted mb-1">Public Key</label>
                <div><code>${peer.public_key_full || peer.public_key || 'N/A'}</code></div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="alert alert-light mb-0">
                <label class="small text-muted mb-1">Endpoint</label>
                <div class="fw-bold">${peer.endpoint || 'N/A'}</div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="alert alert-light mb-0">
                <label class="small text-muted mb-1">Allowed IPs</label>
                <div><code>${peer.allowed_ips || 'N/A'}</code></div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="alert alert-light mb-0">
                <label class="small text-muted mb-1">Last Handshake</label>
                <div class="fw-bold">${peer.latest_handshake || 'Never'}</div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="alert alert-light mb-0">
                <label class="small text-muted mb-1">Status</label>
                <div><span class="badge bg-${statusClass} text-uppercase">${peer.status || 'offline'}</span></div>
            </div>
        </div>
    `;

    const hasTransferData = peer.transfer_received || peer.transfer_sent || peer.transfer_total;
    document.getElementById('peerTransferStatsFull').innerHTML = hasTransferData ? `
        <div class="row g-3">
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <small class="text-muted">Received</small>
                        <h5 class="mb-0 text-success">${peer.transfer_received || '0 B'}</h5>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <small class="text-muted">Sent</small>
                        <h5 class="mb-0 text-primary">${peer.transfer_sent || '0 B'}</h5>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <small class="text-muted">Total</small>
                        <h5 class="mb-0">${peer.transfer_total || '0 B'}</h5>
                    </div>
                </div>
            </div>
        </div>
    ` : '<p class="text-muted small mb-0">No transfer data available</p>';

    document.getElementById('peerActions').innerHTML = `
        <button class="btn btn-outline-primary btn-sm" onclick="refreshPeerStatus()">
            <i class="fas fa-sync-alt me-1"></i>Refresh
        </button>
    `;

    peerDetailModal.show();
}

function formatBytes(bytes) {
    if (!bytes || bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

async function loadServerStatus() {
    try {
        const response = await fetch('/wireguard/api/status');
        const data = await response.json();
        document.getElementById('statusLoading').style.display = 'none';
        document.getElementById('serverStatus').style.display = 'block';
        document.getElementById('serverStatus').textContent = data.success ? data.status : 'Failed to load status';
    } catch (error) {
        document.getElementById('statusLoading').style.display = 'none';
        document.getElementById('serverStatus').style.display = 'block';
        document.getElementById('serverStatus').textContent = 'Error loading status';
    }
}

async function loadServerConfig() {
    try {
        const response = await fetch('/wireguard/api/config');
        const data = await response.json();
        document.getElementById('configLoading').style.display = 'none';
        document.getElementById('serverConfig').style.display = 'block';
        document.getElementById('serverConfig').textContent = data.success ? data.config : 'Failed to load config';
    } catch (error) {
        document.getElementById('configLoading').style.display = 'none';
        document.getElementById('serverConfig').style.display = 'block';
        document.getElementById('serverConfig').textContent = 'Error loading config';
    }
}

async function loadUsers() {
    try {
        const response = await fetch('/wireguard/api/users');
        const data = await response.json();
        document.getElementById('usersLoading').style.display = 'none';

        if (data.success && data.users.length > 0) {
            usersData = data.users; // Store for peer matching
            document.getElementById('usersTableContainer').style.display = 'block';
            document.getElementById('usersTableBody').innerHTML = data.users.map(user => `
                <tr>
                    <td><strong><i class="fas fa-user me-2 text-primary"></i>${user.username}</strong></td>
                    <td><code>${user.ip}</code></td>
                    <td><small><code>${user.public_key.substring(0, 30)}...</code></small></td>
                    <td>${user.config_exists ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-warning">No Config</span>'}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="viewUser('${user.username}')" title="View Config">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-secondary" onclick="showQRCode('${user.username}')" title="QR Code">
                                <i class="fas fa-qrcode"></i>
                            </button>
                            <button class="btn btn-outline-info" onclick="downloadUserConfig('${user.username}')" title="Download">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteUser('${user.username}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            // Refresh the status display to show usernames
            if (statusData) {
                displayEnhancedStatus(statusData);
            }
        } else {
            document.getElementById('noUsers').style.display = 'block';
        }
    } catch (error) {
        document.getElementById('usersLoading').style.display = 'none';
        document.getElementById('noUsers').style.display = 'block';
    }
}

function showAddUserModal() {
    document.getElementById('newUsername').value = '';
    document.getElementById('newDescription').value = '';
    document.getElementById('newPrivateKey').value = '';
    document.getElementById('newPublicKey').value = '';
    document.getElementById('useExistingKeys').checked = false;
    document.getElementById('keyFields').style.display = 'none';
    addUserModal.show();
}

async function createUser() {
    const username = document.getElementById('newUsername').value.trim();
    if (!username) return showToast('Username is required', 'warning');

    const payload = {
        username,
        description: document.getElementById('newDescription').value.trim()
    };

    if (document.getElementById('useExistingKeys').checked) {
        payload.private_key = document.getElementById('newPrivateKey').value.trim();
        payload.public_key = document.getElementById('newPublicKey').value.trim();
    }

    try {
        const response = await fetch('/wireguard/api/users', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        const data = await response.json();

        if (data.success) {
            showToast(`User ${username} created successfully!`, 'success');
            addUserModal.hide();
            loadUsers();
            loadServerConfig();
            loadEnhancedStatus();
        } else {
            showToast(data.error || 'Failed to create user', 'danger');
        }
    } catch (error) {
        showToast('Error creating user', 'danger');
    }
}

async function viewUser(username) {
    currentUser = username;
    try {
        const response = await fetch(`/wireguard/api/users/${username}/config`);
        const data = await response.json();

        if (data.success) {
            document.getElementById('viewUsername').textContent = username;
            document.getElementById('viewUserConfig').textContent = data.config;
            const ipMatch = data.config.match(/Address\s*=\s*([^\n]+)/);
            document.getElementById('viewUserIP').textContent = ipMatch ? ipMatch[1].trim() : '-';
            viewUserModal.show();
        } else {
            showToast('Failed to load user config', 'danger');
        }
    } catch (error) {
        showToast('Error loading user', 'danger');
    }
}

function downloadConfigFromModal() {
    if (currentUser) downloadUserConfig(currentUser);
}

function downloadUserConfig(username) {
    window.location.href = `/wireguard/api/users/${username}/download`;
}

function showQRCode(username) {
    document.getElementById('qrImage').src = `/wireguard/api/users/${username}/qr?t=${Date.now()}`;
    qrModal.show();
}

async function deleteUser(username) {
    if (!confirm(`Are you sure you want to delete user "${username}"? This action cannot be undone.`)) return;

    try {
        const response = await fetch(`/wireguard/api/users/${username}`, {method: 'DELETE'});
        const data = await response.json();

        if (data.success) {
            showToast(`User ${username} deleted successfully`, 'success');
            loadUsers();
            loadServerConfig();
            loadEnhancedStatus();
        } else {
            showToast(data.error || 'Failed to delete user', 'danger');
        }
    } catch (error) {
        showToast('Error deleting user', 'danger');
    }
}

async function showEditConfigModal() {
    try {
        const response = await fetch('/wireguard/api/config');
        const data = await response.json();

        if (data.success) {
            document.getElementById('configEditor').value = data.config;
            editConfigModal.show();
        } else {
            showToast('Failed to load configuration', 'danger');
        }
    } catch (error) {
        showToast('Error loading configuration', 'danger');
    }
}

async function saveConfig() {
    const config = document.getElementById('configEditor').value;
    if (!confirm('Update configuration and restart WireGuard service? This will briefly interrupt all connections.')) return;

    try {
        const response = await fetch('/wireguard/api/config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({config})
        });
        const data = await response.json();

        if (data.success) {
            showToast('Configuration updated successfully', 'success');
            editConfigModal.hide();
            loadServerConfig();
            loadEnhancedStatus();
        } else {
            showToast(data.error || 'Failed to update configuration', 'danger');
        }
    } catch (error) {
        showToast('Error saving configuration', 'danger');
    }
}

async function restartWireGuard() {
    if (!confirm('Restart WireGuard service? This will briefly interrupt all connections.')) return;

    try {
        const response = await fetch('/wireguard/api/restart', {method: 'POST'});
        const data = await response.json();

        showToast(
            data.success ? 'WireGuard service restarted successfully' : data.error || 'Failed to restart',
            data.success ? 'success' : 'danger'
        );

        if (data.success) {
            setTimeout(() => loadEnhancedStatus(), 2000);
        }
    } catch (error) {
        showToast('Error restarting WireGuard', 'danger');
    }
}

function refreshStatus() {
    loadEnhancedStatus();
    loadUsers();
    showToast('Refreshing status...', 'info');
}

async function initializeUsersDirectory() {
    if (!confirm('Initialize users directory structure?')) return;

    try {
        const response = await fetch('/wireguard/api/init-users-dir', {method: 'POST'});
        const data = await response.json();

        showToast(
            data.success ? 'Users directory initialized successfully' : data.error || 'Failed to initialize',
            data.success ? 'success' : 'danger'
        );
    } catch (error) {
        showToast('Error initializing directory', 'danger');
    }
}

function refreshPeerStatus() {
    showToast('Refreshing peer status...', 'info');
    loadEnhancedStatus();
}

function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer') || createToastContainer();
    const toastId = 'toast-' + Date.now();

    const bgClass = type === 'success' ? 'bg-success' :
                    type === 'danger' ? 'bg-danger' :
                    type === 'warning' ? 'bg-warning' :
                    type === 'info' ? 'bg-info' : 'bg-secondary';

    toastContainer.innerHTML += `
        <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;

    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement);
    toast.show();

    toastElement.addEventListener('hidden.bs.toast', function() {
        this.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '9999';
    document.body.appendChild(container);
    return container;
}
</script>
{% endblock %}