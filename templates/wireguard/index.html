{% extends "base.html" %}

{% block title %}WireGuard VPN - FreePBX Dashboard{% endblock %}
{% block page_title %}WireGuard VPN Management{% endblock %}

{% block extra_css %}
<style>
.section-card {background: white;border-radius: 6px;padding: 1rem;box-shadow: 0 1px 3px rgba(0,0,0,0.08);margin-bottom: 1rem;}
.section-header {display: flex;justify-content: space-between;align-items: center;margin-bottom: 1rem;padding-bottom: 0.75rem;border-bottom: 1px solid #e9ecef;}
.section-title {font-size: 1.1rem;font-weight: 600;color: #212529;margin: 0;}
.status-box {background: #f8f9fa;border: 1px solid #dee2e6;border-radius: 6px;padding: 1rem;}
.status-box pre {background: #212529;color: #f8f9fa;padding: 0.75rem;border-radius: 4px;font-size: 0.8rem;margin: 0;}
.users-table {margin: 0;font-size: 0.85rem;}
.users-table thead th {background: #f8f9fa;font-weight: 600;border-bottom: 1px solid #dee2e6;padding: 0.5rem;}
.action-buttons {display: flex;gap: 0.25rem;flex-wrap: wrap;}
.modal-content {border: none;border-radius: 6px;box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,0.15);}
.modal-header {background: #f8f9fa;border-bottom: 1px solid #dee2e6;padding: 1rem;}
.modal-title {font-weight: 600;font-size: 1rem;}
.modal-body {padding: 1rem;}
.config-display {background: #212529;color: #f8f9fa;padding: 0.75rem;border-radius: 4px;font-size: 0.8rem;}
.loading-spinner {text-align: center;padding: 2rem;color: #6c757d;font-size: 0.9rem;}
.spinner-border {width: 2rem;height: 2rem;}
.info-grid {display: grid;grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));gap: 0.75rem;margin-bottom: 1rem;}
.info-card {background: #f8f9fa;padding: 0.75rem;border-radius: 4px;border-left: 3px solid #0d6efd;font-size: 0.85rem;}
.empty-state {text-align: center;padding: 2rem;color: #6c757d;font-size: 0.9rem;}
.btn-group-sm > .btn {padding: 0.2rem 0.4rem;font-size: 0.8rem;}

.status-overview {display: grid;grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));gap: 0.75rem;margin-bottom: 1rem;}
.status-card {background: white;border: 1px solid #e9ecef;border-radius: 6px;padding: 0.75rem;text-align: center;}
.status-card .value {font-size: 1.2rem;font-weight: 600;margin-bottom: 0.25rem;}
.status-card .label {font-size: 0.75rem;color: #6c757d;text-transform: uppercase;font-weight: 600;}

.peer-card {background: white;border: 1px solid #e9ecef;border-radius: 6px;padding: 0.75rem;margin-bottom: 0.75rem;cursor: pointer;transition: all 0.2s ease;font-size: 0.8rem;}
.peer-card:hover {box-shadow: 0 2px 4px rgba(0,0,0,0.1);}
.peer-header {display: flex;justify-content: space-between;align-items: center;margin-bottom: 0.5rem;}
.peer-title {font-weight: 600;margin: 0;font-size: 0.9rem;}
.status-badge {padding: 0.2rem 0.5rem;border-radius: 50px;font-size: 0.7rem;font-weight: 600;text-transform: uppercase;}
.status-online {background: #d1fae5;color: #065f46;}
.status-offline {background: #fee2e2;color: #991b1b;}
.status-stale {background: #fef3c7;color: #92400e;}

.peer-details-minimal {display: grid;grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));gap: 0.5rem;}
.peer-detail-minimal label {font-size: 0.65rem;color: #6c757d;font-weight: 600;margin-bottom: 0.1rem;}
.peer-detail-minimal .value {font-size: 0.75rem;font-weight: 500;}

.transfer-stats-minimal {display: flex;gap: 0.4rem;margin-top: 0.4rem;}
.transfer-stat-minimal {padding: 0.3rem;background: #f8f9fa;border-radius: 3px;min-width: 50px;}
.transfer-stat-minimal .direction {font-size: 0.6rem;color: #6c757d;}
.transfer-stat-minimal .amount {font-size: 0.7rem;font-weight: 600;}

.interface-info {background: #f8f9fa;border-radius: 6px;padding: 1rem;margin-bottom: 1rem;font-size: 0.85rem;}
.interface-details {display: grid;grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));gap: 0.75rem;}

.peer-details-full {display: grid;grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));gap: 0.75rem;margin-bottom: 1rem;font-size: 0.85rem;}
.peer-detail-full label {font-size: 0.7rem;color: #6c757d;font-weight: 600;margin-bottom: 0.3rem;}
.peer-detail-full .value {font-size: 0.8rem;padding: 0.4rem;background: #f8f9fa;border-radius: 3px;}
.peer-detail {margin-bottom: 0.5rem;}
.peer-detail label {font-size: 0.7rem;color: #6c757d;font-weight: 600;margin-bottom: 0.3rem;display: block;}

.transfer-stats-full {display: flex;gap: 0.75rem;margin-top: 0.75rem;}
.transfer-stat-full {padding: 0.75rem;background: #f8f9fa;border-radius: 4px;min-width: 80px;}
.transfer-stat-full .direction {font-size: 0.7rem;color: #6c757d;margin-bottom: 0.3rem;}
.transfer-stat-full .amount {font-size: 0.9rem;font-weight: 600;}

.peer-actions {display: flex;gap: 0.4rem;margin-top: 0.75rem;flex-wrap: wrap;}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Server Status -->
    <div class="section-card">
        <div class="section-header">
            <h2 class="section-title"><i class="fas fa-server text-primary"></i> Server Status</h2>
            <div>
                <button class="btn btn-sm btn-outline-secondary me-1" onclick="refreshStatus()"><i class="fas fa-sync-alt"></i></button>
                <button class="btn btn-sm btn-primary me-1" onclick="restartWireGuard()"><i class="fas fa-redo"></i></button>
                <button class="btn btn-sm btn-success" onclick="initializeUsersDirectory()"><i class="fas fa-folder-plus"></i></button>
            </div>
        </div>

        <div id="enhancedStatus" style="display: none;">
            <div class="status-overview" id="statusOverview"></div>
            <div class="interface-info" id="interfaceInfo"></div>
            <h6 class="mb-2">Connected Peers</h6>
            <div id="peersList"></div>
        </div>

        <div class="status-box">
            <div id="statusLoading" class="loading-spinner">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">Loading status...</p>
            </div>
            <pre id="serverStatus" style="display: none;"></pre>
        </div>
    </div>

    <!-- VPN Users -->
    <div class="section-card">
        <div class="section-header">
            <h2 class="section-title"><i class="fas fa-users text-primary"></i> VPN Users</h2>
            <button class="btn btn-success btn-sm" onclick="showAddUserModal()"><i class="fas fa-user-plus"></i> Add User</button>
        </div>

        <div id="usersLoading" class="loading-spinner">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">Loading users...</p>
        </div>

        <div id="usersTableContainer" style="display: none;">
            <div class="table-responsive">
                <table class="table table-hover users-table">
                    <thead>
                        <tr><th>Username</th><th>IP</th><th>Public Key</th><th>Status</th><th style="width: 200px;">Actions</th></tr>
                    </thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="noUsers" class="empty-state" style="display: none;">
            <i class="fas fa-user-slash"></i>
            <p class="mb-0">No users found.</p>
        </div>
    </div>

    <!-- Server Config -->
    <div class="section-card">
        <div class="section-header">
            <h2 class="section-title"><i class="fas fa-cog text-primary"></i> Server Configuration</h2>
            <button class="btn btn-sm btn-primary" onclick="showEditConfigModal()"><i class="fas fa-edit"></i> Edit</button>
        </div>
        <div class="status-box">
            <div id="configLoading" class="loading-spinner">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">Loading config...</p>
            </div>
            <pre id="serverConfig" style="display: none;"></pre>
        </div>
    </div>
</div>

<!-- Modals -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title"><i class="fas fa-user-plus text-success"></i> Add User</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <div class="mb-2"><label class="form-label">Username *</label><input type="text" class="form-control form-control-sm" id="newUsername" required></div>
            <div class="mb-2"><label class="form-label">Description</label><input type="text" class="form-control form-control-sm" id="newDescription"></div>
            <div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="useExistingKeys" onchange="toggleKeyFields()"><label class="form-check-label">Use Existing Keys</label></div>
            <div id="keyFields" class="key-fields" style="display: none;"><div class="mb-2"><label class="form-label">Private Key</label><textarea class="form-control form-control-sm" id="newPrivateKey" rows="2"></textarea></div><div class="mb-2"><label class="form-label">Public Key</label><textarea class="form-control form-control-sm" id="newPublicKey" rows="2"></textarea></div></div>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-success btn-sm" onclick="createUser()">Create</button></div>
    </div></div>
</div>

<div class="modal fade" id="viewUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title"><i class="fas fa-user text-primary"></i> User Config</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <div class="info-grid"><div class="info-card"><label>Username</label><div id="viewUsername">-</div></div><div class="info-card"><label>IP Address</label><div id="viewUserIP">-</div></div></div>
            <div class="config-display" id="viewUserConfig">Loading...</div>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button><button type="button" class="btn btn-primary btn-sm" onclick="downloadConfigFromModal()">Download</button></div>
    </div></div>
</div>

<div class="modal fade" id="qrModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title"><i class="fas fa-qrcode text-primary"></i> QR Code</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body text-center"><img id="qrImage" src="" class="img-fluid" /><p class="text-muted mt-2 mb-0 small">Scan with WireGuard app</p></div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button></div>
    </div></div>
</div>

<div class="modal fade" id="editConfigModal" tabindex="-1">
    <div class="modal-dialog modal-xl"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title"><i class="fas fa-edit text-primary"></i> Edit Config</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body"><textarea class="form-control font-monospace" id="configEditor" rows="15" style="font-size: 0.8rem;"></textarea></div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-primary btn-sm" onclick="saveConfig()">Save</button></div>
    </div></div>
</div>

<div class="modal fade" id="peerDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title"><i class="fas fa-network-wired text-primary"></i> Peer Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <div class="peer-details-full" id="peerDetailsFull"></div>
            <div class="transfer-stats-full" id="peerTransferStatsFull"></div>
            <div class="peer-actions" id="peerActions"></div>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button></div>
    </div></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentUser = null, currentPeer = null, statusData = null;
let addUserModal, viewUserModal, qrModal, editConfigModal, peerDetailModal;

document.addEventListener('DOMContentLoaded', function() {
    addUserModal = new bootstrap.Modal(document.getElementById('addUserModal'));
    viewUserModal = new bootstrap.Modal(document.getElementById('viewUserModal'));
    qrModal = new bootstrap.Modal(document.getElementById('qrModal'));
    editConfigModal = new bootstrap.Modal(document.getElementById('editConfigModal'));
    peerDetailModal = new bootstrap.Modal(document.getElementById('peerDetailModal'));
    loadEnhancedStatus(); loadServerConfig(); loadUsers();
});

function toggleKeyFields() {
    const keyFields = document.getElementById('keyFields');
    keyFields.style.display = document.getElementById('useExistingKeys').checked ? 'block' : 'none';
    if(!document.getElementById('useExistingKeys').checked) {
        document.getElementById('newPrivateKey').value = '';
        document.getElementById('newPublicKey').value = '';
    }
}

async function loadEnhancedStatus() {
    try {
        const response = await fetch('/wireguard/api/status-ui');
        const data = await response.json();
        document.getElementById('statusLoading').style.display = 'none';
        if (data.success && data.status) {
            statusData = data.status; // Store for later use
            document.getElementById('enhancedStatus').style.display = 'block';
            displayEnhancedStatus(data.status);
        } else await loadServerStatus();
    } catch (error) {
        document.getElementById('statusLoading').style.display = 'none';
        await loadServerStatus();
    }
}

function displayEnhancedStatus(status) {
    const totalPeers = status.peers.length;
    const onlinePeers = status.peers.filter(peer => peer.status === 'online').length;
    const offlinePeers = status.peers.filter(peer => peer.status === 'offline').length;

    document.getElementById('statusOverview').innerHTML = `
        <div class="status-card"><div class="value">${totalPeers}</div><div class="label">Total</div></div>
        <div class="status-card"><div class="value text-success">${onlinePeers}</div><div class="label">Online</div></div>
        <div class="status-card"><div class="value text-warning">${totalPeers - onlinePeers - offlinePeers}</div><div class="label">Stale</div></div>
        <div class="status-card"><div class="value text-danger">${offlinePeers}</div><div class="label">Offline</div></div>
    `;

    document.getElementById('interfaceInfo').innerHTML = `
        <div class="interface-header"><h6 class="interface-title">Interface: ${status.interface.name || 'wg0'}</h6></div>
        <div class="interface-details">
            <div class="peer-detail"><label>Public Key</label><div><code>${status.interface.public_key || 'N/A'}</code></div></div>
            <div class="peer-detail"><label>Port</label><div>${status.interface.port || 'N/A'}</div></div>
        </div>
    `;

    if (status.peers.length > 0) {
        document.getElementById('peersList').innerHTML = status.peers.map((peer, index) => {
            // Safely get values with defaults
            const clientIp = peer.client_ip || 'Unknown';
            const peerStatus = peer.status || 'offline';
            const publicKey = peer.public_key_short || peer.public_key || '';
            const endpoint = peer.endpoint || 'N/A';
            const latestHandshake = peer.latest_handshake || 'Never';
            const transferReceived = peer.transfer_received_bytes || 0;
            const transferSent = peer.transfer_sent_bytes || 0;

            return `
            <div class="peer-card" onclick="showPeerDetails(${index})" title="Click for details">
                <div class="peer-header">
                    <h6 class="peer-title">${clientIp}</h6>
                    <span class="status-badge status-${peerStatus}">${peerStatus}</span>
                </div>
                <div class="peer-details-minimal">
                    <div class="peer-detail-minimal">
                        <label>Public Key</label>
                        <div class="value"><code>${publicKey.substring(0,20)}...</code></div>
                    </div>
                    <div class="peer-detail-minimal">
                        <label>Endpoint</label>
                        <div class="value">${endpoint.split(':')[0]}</div>
                    </div>
                    <div class="peer-detail-minimal">
                        <label>Last Handshake</label>
                        <div class="value">${latestHandshake}</div>
                    </div>
                </div>
                ${transferReceived > 0 || transferSent > 0 ? `
                <div class="transfer-stats-minimal">
                    <div class="transfer-stat-minimal">
                        <div class="direction">↓ Recv</div>
                        <div class="amount">${formatBytes(transferReceived)}</div>
                    </div>
                    <div class="transfer-stat-minimal">
                        <div class="direction">↑ Sent</div>
                        <div class="amount">${formatBytes(transferSent)}</div>
                    </div>
                </div>` : ''}
            </div>
        `}).join('');
    } else {
        document.getElementById('peersList').innerHTML = '<div class="empty-state"><i class="fas fa-plug"></i><p class="mb-0">No peers connected</p></div>';
    }
}

function showPeerDetails(peerIndex) {
    currentPeer = peerIndex;

    // Use stored status data if available, otherwise fetch fresh
    if (statusData && statusData.peers && statusData.peers[peerIndex]) {
        displayPeerDetails(statusData.peers[peerIndex]);
    } else {
        fetch('/wireguard/api/status-ui').then(r => r.json()).then(data => {
            if (data.success && data.status && data.status.peers[peerIndex]) {
                statusData = data.status;
                displayPeerDetails(data.status.peers[peerIndex]);
            }
        }).catch(() => showToast('Error loading peer details', 'danger'));
    }
}

function displayPeerDetails(peer) {
    document.getElementById('peerDetailsFull').innerHTML = `
        <div class="peer-detail-full">
            <label>Client IP</label>
            <div class="value">${peer.client_ip || 'N/A'}</div>
        </div>
        <div class="peer-detail-full">
            <label>Public Key</label>
            <div class="value"><code>${peer.public_key_full || peer.public_key || 'N/A'}</code></div>
        </div>
        <div class="peer-detail-full">
            <label>Endpoint</label>
            <div class="value">${peer.endpoint || 'N/A'}</div>
        </div>
        <div class="peer-detail-full">
            <label>Allowed IPs</label>
            <div class="value"><code>${peer.allowed_ips || 'N/A'}</code></div>
        </div>
        <div class="peer-detail-full">
            <label>Last Handshake</label>
            <div class="value">${peer.latest_handshake || 'Never'}</div>
        </div>
        <div class="peer-detail-full">
            <label>Status</label>
            <div class="value"><span class="status-badge status-${peer.status || 'offline'}">${peer.status || 'offline'}</span></div>
        </div>
    `;

    const hasTransferData = peer.transfer_received || peer.transfer_sent || peer.transfer_total;
    document.getElementById('peerTransferStatsFull').innerHTML = hasTransferData ? `
        <div class="transfer-stat-full">
            <div class="direction">Received</div>
            <div class="amount">${peer.transfer_received || '0 B'}</div>
        </div>
        <div class="transfer-stat-full">
            <div class="direction">Sent</div>
            <div class="amount">${peer.transfer_sent || '0 B'}</div>
        </div>
        <div class="transfer-stat-full">
            <div class="direction">Total</div>
            <div class="amount">${peer.transfer_total || '0 B'}</div>
        </div>
    ` : '<p class="text-muted small">No transfer data available</p>';

    document.getElementById('peerActions').innerHTML = `
        <button class="btn btn-outline-primary btn-sm" onclick="refreshPeerStatus()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
        <button class="btn btn-outline-info btn-sm" onclick="viewPeerConfig()">
            <i class="fas fa-eye"></i> Config
        </button>
    `;

    peerDetailModal.show();
}

function formatBytes(bytes) {
    if (!bytes || bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

async function loadServerStatus() {
    try {
        const response = await fetch('/wireguard/api/status');
        const data = await response.json();
        document.getElementById('statusLoading').style.display = 'none';
        document.getElementById('serverStatus').style.display = 'block';
        document.getElementById('serverStatus').textContent = data.success ? data.status : 'Failed to load status';
    } catch (error) {
        document.getElementById('statusLoading').style.display = 'none';
        document.getElementById('serverStatus').style.display = 'block';
        document.getElementById('serverStatus').textContent = 'Error loading status';
    }
}

async function loadServerConfig() {
    try {
        const response = await fetch('/wireguard/api/config');
        const data = await response.json();
        document.getElementById('configLoading').style.display = 'none';
        document.getElementById('serverConfig').style.display = 'block';
        document.getElementById('serverConfig').textContent = data.success ? data.config : 'Failed to load config';
    } catch (error) {
        document.getElementById('configLoading').style.display = 'none';
        document.getElementById('serverConfig').style.display = 'block';
        document.getElementById('serverConfig').textContent = 'Error loading config';
    }
}

async function loadUsers() {
    try {
        const response = await fetch('/wireguard/api/users');
        const data = await response.json();
        document.getElementById('usersLoading').style.display = 'none';
        if (data.success && data.users.length > 0) {
            document.getElementById('usersTableContainer').style.display = 'block';
            document.getElementById('usersTableBody').innerHTML = data.users.map(user => `
                <tr>
                    <td><strong>${user.username}</strong></td>
                    <td><code>${user.ip}</code></td>
                    <td><small><code>${user.public_key.substring(0, 30)}...</code></small></td>
                    <td>${user.config_exists ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-warning">No Config</span>'}</td>
                    <td>
                        <div class="btn-group btn-group-sm action-buttons">
                            <button class="btn btn-outline-primary" onclick="viewUser('${user.username}')"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-outline-secondary" onclick="showQRCode('${user.username}')"><i class="fas fa-qrcode"></i></button>
                            <button class="btn btn-outline-info" onclick="downloadUserConfig('${user.username}')"><i class="fas fa-download"></i></button>
                            <button class="btn btn-outline-danger" onclick="deleteUser('${user.username}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');
        } else document.getElementById('noUsers').style.display = 'block';
    } catch (error) {
        document.getElementById('usersLoading').style.display = 'none';
        document.getElementById('noUsers').style.display = 'block';
    }
}

function showAddUserModal() {
    document.getElementById('newUsername').value = '';
    document.getElementById('newDescription').value = '';
    document.getElementById('newPrivateKey').value = '';
    document.getElementById('newPublicKey').value = '';
    document.getElementById('useExistingKeys').checked = false;
    document.getElementById('keyFields').style.display = 'none';
    addUserModal.show();
}


async function createUser() {
    const username = document.getElementById('newUsername').value.trim();
    if (!username) return showToast('Username required', 'warning');

    const payload = {username, description: document.getElementById('newDescription').value.trim()};
    if (document.getElementById('useExistingKeys').checked) {
        payload.private_key = document.getElementById('newPrivateKey').value.trim();
        payload.public_key = document.getElementById('newPublicKey').value.trim();
    }

    try {
        const response = await fetch('/wireguard/api/users', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)});
        const data = await response.json();
        if (data.success) { showToast(`User ${username} created!`, 'success'); addUserModal.hide(); loadUsers(); loadServerConfig(); loadEnhancedStatus(); }
        else showToast(data.error || 'Failed', 'danger');
    } catch (error) { showToast('Error creating user', 'danger'); }
}

async function viewUser(username) {
    currentUser = username;
    try {
        const response = await fetch(`/wireguard/api/users/${username}/config`);
        const data = await response.json();
        if (data.success) {
            document.getElementById('viewUsername').textContent = username;
            document.getElementById('viewUserConfig').textContent = data.config;
            const ipMatch = data.config.match(/Address\s*=\s*([^\n]+)/);
            document.getElementById('viewUserIP').textContent = ipMatch ? ipMatch[1].trim() : '-';
            viewUserModal.show();
        } else showToast('Failed to load config', 'danger');
    } catch (error) { showToast('Error loading user', 'danger'); }
}

function downloadConfigFromModal() { if (currentUser) downloadUserConfig(currentUser); }
function downloadUserConfig(username) { window.location.href = `/wireguard/api/users/${username}/download`; }
function showQRCode(username) { document.getElementById('qrImage').src = `/wireguard/api/users/${username}/qr?t=${Date.now()}`; qrModal.show(); }

async function deleteUser(username) {
    if (!confirm(`Delete user "${username}"?`)) return;
    try {
        const response = await fetch(`/wireguard/api/users/${username}`, {method: 'DELETE'});
        const data = await response.json();
        if (data.success) { showToast(`User ${username} deleted`, 'success'); loadUsers(); loadServerConfig(); loadEnhancedStatus(); }
        else showToast(data.error || 'Failed', 'danger');
    } catch (error) { showToast('Error deleting user', 'danger'); }
}

async function showEditConfigModal() {
    try {
        const response = await fetch('/wireguard/api/config');
        const data = await response.json();
        if (data.success) { document.getElementById('configEditor').value = data.config; editConfigModal.show(); }
        else showToast('Failed to load config', 'danger');
    } catch (error) { showToast('Error loading config', 'danger'); }
}

async function saveConfig() {
    const config = document.getElementById('configEditor').value;
    if (!confirm('Update config and restart service?')) return;
    try {
        const response = await fetch('/wireguard/api/config', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({config})});
        const data = await response.json();
        if (data.success) { showToast('Config updated', 'success'); editConfigModal.hide(); loadServerConfig(); loadEnhancedStatus(); }
        else showToast(data.error || 'Failed', 'danger');
    } catch (error) { showToast('Error saving config', 'danger'); }
}

async function restartWireGuard() {
    if (!confirm('Restart WireGuard?')) return;
    try {
        const response = await fetch('/wireguard/api/restart', {method: 'POST'});
        const data = await response.json();
        showToast(data.success ? 'Service restarted' : data.error || 'Failed', data.success ? 'success' : 'danger');
        if (data.success) setTimeout(() => loadEnhancedStatus(), 2000);
    } catch (error) { showToast('Error restarting', 'danger'); }
}

function refreshStatus() { loadEnhancedStatus(); loadUsers(); showToast('Refreshing...', 'info'); }

async function initializeUsersDirectory() {
    if (!confirm('Initialize users directory?')) return;
    try {
        const response = await fetch('/wireguard/api/init-users-dir', {method: 'POST'});
        const data = await response.json();
        showToast(data.success ? 'Directory initialized' : data.error || 'Failed', data.success ? 'success' : 'danger');
    } catch (error) { showToast('Error initializing', 'danger'); }
}

function refreshPeerStatus() { showToast('Refreshing peer...', 'info'); loadEnhancedStatus(); }
function viewPeerConfig() { showToast('Viewing peer config...', 'info'); }

function showToast(message, type = 'info') {
    let container = document.getElementById('toastContainer');
    if (!container) { container = document.createElement('div'); container.id = 'toastContainer'; container.className = 'toast-container position-fixed top-0 end-0 p-3'; document.body.appendChild(container); }
    const toastId = 'toast-' + Date.now();
    container.innerHTML += `<div id="${toastId}" class="toast align-items-center text-bg-${type} border-0"><div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div></div>`;
    const toast = new bootstrap.Toast(document.getElementById(toastId)); toast.show();
    document.getElementById(toastId).addEventListener('hidden.bs.toast', function() { this.remove(); });
}
</script>
{% endblock %}