{% extends "base.html" %}

{% block title %}WireGuard VPN - FreePBX Dashboard{% endblock %}
{% block page_title %}WireGuard VPN Management{% endblock %}

{% block extra_css %}
<style>
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .stat-card .value {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .stat-card .label {
        font-size: 0.875rem;
        opacity: 0.9;
        font-weight: 500;
    }

    .section-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        margin-bottom: 1.5rem;
        border: 1px solid #eef2f7;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1a202c;
        margin: 0;
    }

    .peers-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1rem;
    }

    .peer-card {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 1.25rem;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .peer-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border-color: #cbd5e0;
    }

    .peer-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .peer-ip {
        font-weight: 600;
        color: #2d3748;
        font-size: 1rem;
    }

    .status-badge {
        padding: 0.35rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .status-online { background: #c6f6d5; color: #22543d; }
    .status-offline { background: #fed7d7; color: #742a2a; }
    .status-stale { background: #feebc8; color: #744210; }

    .peer-details {
        display: grid;
        gap: 0.5rem;
    }

    .peer-detail {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.875rem;
    }

    .peer-detail label {
        color: #718096;
        font-weight: 500;
    }

    .peer-detail .value {
        color: #2d3748;
        font-weight: 600;
    }

    .btn-modern {
        border: none;
        border-radius: 8px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        transition: all 0.2s ease;
    }

    .btn-modern:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .users-table {
        width: 100%;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

    .users-table th {
        background: #f7fafc;
        padding: 1rem;
        font-weight: 600;
        color: #4a5568;
        border-bottom: 2px solid #e2e8f0;
    }

    .users-table td {
        padding: 1rem;
        border-bottom: 1px solid #e2e8f0;
    }

    .users-table tr:hover {
        background: #f7fafc;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .btn-icon {
        width: 32px;
        height: 32px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: none;
        border-radius: 6px;
        transition: all 0.2s ease;
    }

    .btn-icon:hover {
        transform: scale(1.05);
    }

    .modal-content {
        border: none;
        border-radius: 12px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }

    .modal-header {
        background: #f7fafc;
        border-bottom: 1px solid #e2e8f0;
        padding: 1.5rem;
    }

    .modal-title {
        font-weight: 600;
        color: #2d3748;
    }

    .modal-body {
        padding: 1.5rem;
    }

    .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .detail-item {
        background: #f7fafc;
        padding: 1rem;
        border-radius: 8px;
        border-left: 4px solid #667eea;
    }

    .detail-item label {
        font-size: 0.75rem;
        color: #718096;
        font-weight: 600;
        text-transform: uppercase;
        display: block;
        margin-bottom: 0.5rem;
    }

    .detail-item .value {
        font-size: 0.875rem;
        color: #2d3748;
        font-weight: 500;
        word-break: break-all;
    }

    .transfer-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-top: 1rem;
    }

    .transfer-stat {
        text-align: center;
        padding: 1rem;
        background: #f7fafc;
        border-radius: 8px;
    }

    .transfer-stat .direction {
        font-size: 0.75rem;
        color: #718096;
        font-weight: 600;
        text-transform: uppercase;
        margin-bottom: 0.5rem;
    }

    .transfer-stat .amount {
        font-size: 1rem;
        font-weight: 700;
        color: #2d3748;
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #a0aec0;
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .loading-spinner {
        text-align: center;
        padding: 3rem;
        color: #a0aec0;
    }

    .config-display {
        background: #2d3748;
        color: #e2e8f0;
        padding: 1rem;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
        line-height: 1.6;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Status Overview -->
    <div class="dashboard-grid">
        <div class="stat-card">
            <div class="value" id="totalPeers">0</div>
            <div class="label">Total Peers</div>
        </div>
        <div class="stat-card">
            <div class="value" id="onlinePeers">0</div>
            <div class="label">Online Now</div>
        </div>
        <div class="stat-card">
            <div class="value" id="totalUsers">0</div>
            <div class="label">VPN Users</div>
        </div>
    </div>

    <!-- Server Status -->
    <div class="section-card">
        <div class="section-header">
            <h2 class="section-title">üìä Server Status</h2>
            <div>
                <button class="btn btn-sm btn-outline-secondary me-2" onclick="refreshStatus()">
                    üîÑ Refresh
                </button>
                <button class="btn btn-sm btn-modern btn-primary" onclick="restartWireGuard()">
                    ‚ö° Restart Service
                </button>
            </div>
        </div>

        <div id="statusLoading" class="loading-spinner">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">Loading status...</p>
        </div>

        <div id="enhancedStatus" style="display: none;">
            <div class="peers-grid" id="peersList">
                <!-- Peer cards will be inserted here -->
            </div>
        </div>
    </div>

    <!-- VPN Users -->
    <div class="section-card">
        <div class="section-header">
            <h2 class="section-title">üë• VPN Users</h2>
            <button class="btn btn-modern btn-success" onclick="showAddUserModal()">
                ‚ûï Add User
            </button>
        </div>

        <div id="usersLoading" class="loading-spinner">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">Loading users...</p>
        </div>

        <div id="usersTableContainer" style="display: none;">
            <div class="table-responsive">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>IP Address</th>
                            <th>Public Key</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="noUsers" class="empty-state" style="display: none;">
            <i class="fas fa-user-slash"></i>
            <p>No users found. Click "Add User" to create one.</p>
        </div>
    </div>
</div>

<!-- Peer Details Modal -->
<div class="modal fade" id="peerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üîç Peer Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="detail-grid" id="peerDetails">
                    <!-- Dynamic content -->
                </div>
                <div class="transfer-stats" id="peerTransfer">
                    <!-- Dynamic content -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üë§ Add VPN User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-control" id="newUsername" placeholder="e.g., john_doe">
                </div>
                <div class="mb-3">
                    <label class="form-label">Description (Optional)</label>
                    <input type="text" class="form-control" id="newDescription" placeholder="e.g., John Doe - Sales">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="createUser()">Create User</button>
            </div>
        </div>
    </div>
</div>

<!-- View Config Modal -->
<div class="modal fade" id="configModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üìÑ Client Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="config-display" id="configContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="downloadCurrentConfig()">Download</button>
            </div>
        </div>
    </div>
</div>

<!-- QR Code Modal -->
<div class="modal fade" id="qrModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üì± QR Code</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="qrImage" src="" alt="QR Code" class="img-fluid rounded">
                <p class="text-muted mt-3">Scan with WireGuard mobile app</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentPeer = null;
    let currentUser = null;

    document.addEventListener('DOMContentLoaded', function() {
        loadEnhancedStatus();
        loadUsers();
    });

    async function loadEnhancedStatus() {
        try {
            const response = await fetch('/wireguard/api/status-ui');
            const data = await response.json();

            document.getElementById('statusLoading').style.display = 'none';

            if (data.success && data.status) {
                document.getElementById('enhancedStatus').style.display = 'block';
                displayEnhancedStatus(data.status);
            } else {
                document.getElementById('enhancedStatus').innerHTML = '<div class="empty-state"><p>Failed to load status</p></div>';
            }
        } catch (error) {
            console.error('Error loading status:', error);
            document.getElementById('statusLoading').style.display = 'none';
            document.getElementById('enhancedStatus').innerHTML = '<div class="empty-state"><p>Error loading status</p></div>';
        }
    }

    function displayEnhancedStatus(status) {
        const peers = status.peers || [];

        // Update overview cards
        document.getElementById('totalPeers').textContent = peers.length;
        document.getElementById('onlinePeers').textContent = peers.filter(p => p.status === 'online').length;

        // Display peer cards
        const peersDiv = document.getElementById('peersList');

        if (peers.length > 0) {
            peersDiv.innerHTML = peers.map(peer => `
                <div class="peer-card" onclick="showPeerDetails('${peer.client_ip}')">
                    <div class="peer-header">
                        <div class="peer-ip">${peer.client_ip || 'Unknown IP'}</div>
                        <span class="status-badge status-${peer.status || 'offline'}">
                            ${peer.status || 'offline'}
                        </span>
                    </div>
                    <div class="peer-details">
                        <div class="peer-detail">
                            <label>Endpoint</label>
                            <span class="value">${peer.endpoint ? peer.endpoint.split(':')[0] : 'Not connected'}</span>
                        </div>
                        <div class="peer-detail">
                            <label>Last Handshake</label>
                            <span class="value">${peer.latest_handshake ? formatHandshake(peer.latest_handshake) : 'Never'}</span>
                        </div>
                        <div class="peer-detail">
                            <label>Transfer</label>
                            <span class="value">${peer.transfer_total || '0 B'}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        } else {
            peersDiv.innerHTML = '<div class="empty-state"><p>No peers connected</p></div>';
        }
    }

    function formatHandshake(handshake) {
        if (handshake.includes('minute')) {
            const mins = handshake.match(/(\d+) minute/);
            return mins ? `${mins[1]}m ago` : 'Recently';
        } else if (handshake.includes('second')) {
            const secs = handshake.match(/(\d+) second/);
            return secs ? `${secs[1]}s ago` : 'Just now';
        }
        return handshake;
    }

    function showPeerDetails(clientIp) {
        // In a real implementation, you'd fetch detailed peer info
        // For now, we'll show a simple modal
        const modal = new bootstrap.Modal(document.getElementById('peerModal'));
        document.getElementById('peerDetails').innerHTML = `
            <div class="detail-item">
                <label>Client IP</label>
                <div class="value">${clientIp}</div>
            </div>
            <div class="detail-item">
                <label>Status</label>
                <div class="value"><span class="status-badge status-online">Online</span></div>
            </div>
            <div class="detail-item">
                <label>Connection Time</label>
                <div class="value">2 hours 15 minutes</div>
            </div>
        `;
        modal.show();
    }

    async function loadUsers() {
        try {
            const response = await fetch('/wireguard/api/users');
            const data = await response.json();

            document.getElementById('usersLoading').style.display = 'none';
            document.getElementById('totalUsers').textContent = data.users ? data.users.length : 0;

            if (data.success && data.users.length > 0) {
                document.getElementById('usersTableContainer').style.display = 'block';
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = data.users.map(user => `
                    <tr>
                        <td><strong>${user.username}</strong></td>
                        <td><code>${user.ip}</code></td>
                        <td><small><code>${user.public_key.substring(0, 20)}...</code></small></td>
                        <td>${user.config_exists ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-warning">Inactive</span>'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-icon btn btn-outline-primary" onclick="viewConfig('${user.username}')" title="View Config">
                                    üëÅÔ∏è
                                </button>
                                <button class="btn-icon btn btn-outline-secondary" onclick="showQRCode('${user.username}')" title="QR Code">
                                    üì±
                                </button>
                                <button class="btn-icon btn btn-outline-info" onclick="downloadUserConfig('${user.username}')" title="Download">
                                    üì•
                                </button>
                                <button class="btn-icon btn btn-outline-danger" onclick="deleteUser('${user.username}')" title="Delete">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            } else {
                document.getElementById('noUsers').style.display = 'block';
            }
        } catch (error) {
            console.error('Error loading users:', error);
            document.getElementById('usersLoading').style.display = 'none';
            document.getElementById('noUsers').style.display = 'block';
        }
    }

    function showAddUserModal() {
        document.getElementById('newUsername').value = '';
        document.getElementById('newDescription').value = '';
        new bootstrap.Modal(document.getElementById('addUserModal')).show();
    }

    async function createUser() {
        const username = document.getElementById('newUsername').value.trim();
        const description = document.getElementById('newDescription').value.trim();

        if (!username) {
            alert('Please enter a username');
            return;
        }

        try {
            const response = await fetch('/wireguard/api/users', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username, description})
            });

            const data = await response.json();

            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
                showToast('User created successfully!', 'success');
                loadUsers();
                loadEnhancedStatus();
            } else {
                alert(data.error || 'Failed to create user');
            }
        } catch (error) {
            console.error('Error creating user:', error);
            alert('Error creating user');
        }
    }

    async function viewConfig(username) {
        try {
            const response = await fetch(`/wireguard/api/users/${username}/config`);
            const data = await response.json();

            if (data.success) {
                document.getElementById('configContent').textContent = data.config;
                currentUser = username;
                new bootstrap.Modal(document.getElementById('configModal')).show();
            } else {
                alert('Failed to load configuration');
            }
        } catch (error) {
            console.error('Error loading config:', error);
            alert('Error loading configuration');
        }
    }

    function downloadCurrentConfig() {
        if (currentUser) {
            downloadUserConfig(currentUser);
        }
    }

    function downloadUserConfig(username) {
        window.open(`/wireguard/api/users/${username}/download`, '_blank');
    }

    function showQRCode(username) {
        document.getElementById('qrImage').src = `/wireguard/api/users/${username}/qr?t=${Date.now()}`;
        new bootstrap.Modal(document.getElementById('qrModal')).show();
    }

    async function deleteUser(username) {
        if (!confirm(`Delete user "${username}"? This cannot be undone.`)) return;

        try {
            const response = await fetch(`/wireguard/api/users/${username}`, {method: 'DELETE'});
            const data = await response.json();

            if (data.success) {
                showToast('User deleted successfully', 'success');
                loadUsers();
                loadEnhancedStatus();
            } else {
                alert(data.error || 'Failed to delete user');
            }
        } catch (error) {
            console.error('Error deleting user:', error);
            alert('Error deleting user');
        }
    }

    async function restartWireGuard() {
        if (!confirm('Restart WireGuard service?')) return;

        try {
            const response = await fetch('/wireguard/api/restart', {method: 'POST'});
            const data = await response.json();

            if (data.success) {
                showToast('Service restarted successfully', 'success');
                setTimeout(loadEnhancedStatus, 2000);
            } else {
                alert(data.error || 'Failed to restart service');
            }
        } catch (error) {
            console.error('Error restarting service:', error);
            alert('Error restarting service');
        }
    }

    function refreshStatus() {
        loadEnhancedStatus();
        loadUsers();
        showToast('Status refreshed', 'info');
    }

    function showToast(message, type = 'info') {
        // Simple toast implementation
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 250px;';
        toast.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
</script>
{% endblock %}