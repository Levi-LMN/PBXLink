{% extends "base.html" %}

{% block title %}WireGuard VPN - FreePBX Dashboard{% endblock %}
{% block page_title %}WireGuard VPN Management{% endblock %}

{% block extra_css %}
<style>
.peer-card { cursor: pointer; transition: all 0.2s ease; }
.peer-card:hover { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Server Status -->
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="fas fa-server text-primary"></i> Server Status</h6>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary" onclick="refreshStatus()"><i class="fas fa-sync-alt"></i></button>
                <button class="btn btn-outline-primary" onclick="restartWireGuard()"><i class="fas fa-redo"></i> Restart</button>
                <button class="btn btn-outline-success" onclick="initializeUsersDirectory()"><i class="fas fa-folder-plus"></i> Init</button>
            </div>
        </div>
        <div class="card-body">
            <div id="enhancedStatus" style="display: none;">
                <!-- Status Overview -->
                <div class="row g-2 mb-3" id="statusOverview"></div>

                <!-- Interface Info -->
                <div class="alert alert-light mb-3" id="interfaceInfo"></div>

                <!-- Connected Peers -->
                <h6 class="mb-2">Connected Peers</h6>
                <div id="peersList"></div>
            </div>

            <!-- Loading/Fallback -->
            <div id="statusLoading" class="text-center py-4">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="text-muted mt-2">Loading status...</p>
            </div>
            <pre id="serverStatus" class="bg-dark text-light p-3 rounded" style="display: none;"></pre>
        </div>
    </div>

    <!-- VPN Users -->
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="fas fa-users text-primary"></i> VPN Users</h6>
            <button class="btn btn-success btn-sm" onclick="showAddUserModal()"><i class="fas fa-user-plus"></i> Add User</button>
        </div>
        <div class="card-body">
            <div id="usersLoading" class="text-center py-4">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="text-muted mt-2">Loading users...</p>
            </div>

            <div id="usersTableContainer" style="display: none;">
                <div class="table-responsive">
                    <table class="table table-sm table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Username</th>
                                <th>IP</th>
                                <th>Public Key</th>
                                <th>Status</th>
                                <th style="width: 200px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="noUsers" class="text-center py-4 text-muted" style="display: none;">
                <i class="fas fa-user-slash fa-2x mb-2"></i>
                <p class="mb-0">No users found.</p>
            </div>
        </div>
    </div>

    <!-- Server Config -->
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="fas fa-cog text-primary"></i> Server Configuration</h6>
            <button class="btn btn-primary btn-sm" onclick="showEditConfigModal()"><i class="fas fa-edit"></i> Edit</button>
        </div>
        <div class="card-body">
            <div id="configLoading" class="text-center py-4">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="text-muted mt-2">Loading config...</p>
            </div>
            <pre id="serverConfig" class="bg-dark text-light p-3 rounded" style="display: none;"></pre>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-user-plus text-success"></i> Add User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Username *</label>
                    <input type="text" class="form-control" id="newUsername" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <input type="text" class="form-control" id="newDescription">
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="useExistingKeys" onchange="toggleKeyFields()">
                    <label class="form-check-label">Use Existing Keys</label>
                </div>
                <div id="keyFields" style="display: none;">
                    <div class="mb-3">
                        <label class="form-label">Private Key</label>
                        <textarea class="form-control font-monospace" id="newPrivateKey" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Public Key</label>
                        <textarea class="form-control font-monospace" id="newPublicKey" rows="2"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="createUser()">Create</button>
            </div>
        </div>
    </div>
</div>

<!-- View User Modal -->
<div class="modal fade" id="viewUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-user text-primary"></i> User Config</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <div class="p-3 bg-light rounded">
                            <small class="text-muted d-block">Username</small>
                            <strong id="viewUsername">-</strong>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="p-3 bg-light rounded">
                            <small class="text-muted d-block">IP Address</small>
                            <strong id="viewUserIP">-</strong>
                        </div>
                    </div>
                </div>
                <pre id="viewUserConfig" class="bg-dark text-light p-3 rounded">Loading...</pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="downloadConfigFromModal()">Download</button>
            </div>
        </div>
    </div>
</div>

<!-- QR Code Modal -->
<div class="modal fade" id="qrModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-qrcode text-primary"></i> QR Code</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="qrImage" src="" class="img-fluid" />
                <p class="text-muted mt-2 mb-0 small">Scan with WireGuard app</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Config Modal -->
<div class="modal fade" id="editConfigModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-edit text-primary"></i> Edit Config</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <textarea class="form-control font-monospace" id="configEditor" rows="15" style="font-size: 0.85rem;"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveConfig()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Peer Detail Modal -->
<div class="modal fade" id="peerDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-network-wired text-primary"></i> Peer Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3 mb-3" id="peerDetailsFull"></div>
                <div class="row g-2 mb-3" id="peerTransferStatsFull"></div>
                <div class="d-flex gap-2" id="peerActions"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentUser = null, currentPeer = null, statusData = null, usersData = [];
let addUserModal, viewUserModal, qrModal, editConfigModal, peerDetailModal;

document.addEventListener('DOMContentLoaded', function() {
    addUserModal = new bootstrap.Modal(document.getElementById('addUserModal'));
    viewUserModal = new bootstrap.Modal(document.getElementById('viewUserModal'));
    qrModal = new bootstrap.Modal(document.getElementById('qrModal'));
    editConfigModal = new bootstrap.Modal(document.getElementById('editConfigModal'));
    peerDetailModal = new bootstrap.Modal(document.getElementById('peerDetailModal'));
    loadEnhancedStatus(); loadServerConfig(); loadUsers();
});

function toggleKeyFields() {
    const keyFields = document.getElementById('keyFields');
    keyFields.style.display = document.getElementById('useExistingKeys').checked ? 'block' : 'none';
    if(!document.getElementById('useExistingKeys').checked) {
        document.getElementById('newPrivateKey').value = '';
        document.getElementById('newPublicKey').value = '';
    }
}

function getUsernameByIP(ip) {
    // Extract IP without CIDR notation
    const cleanIP = ip.replace('/32', '');
    const user = usersData.find(u => u.ip.replace('/32', '') === cleanIP);
    return user ? user.username : null;
}

async function loadEnhancedStatus() {
    try {
        const response = await fetch('/wireguard/api/status-ui');
        const data = await response.json();
        document.getElementById('statusLoading').style.display = 'none';
        if (data.success && data.status) {
            statusData = data.status;
            document.getElementById('enhancedStatus').style.display = 'block';
            displayEnhancedStatus(data.status);
        } else await loadServerStatus();
    } catch (error) {
        document.getElementById('statusLoading').style.display = 'none';
        await loadServerStatus();
    }
}

function displayEnhancedStatus(status) {
    const totalPeers = status.peers.length;
    const onlinePeers = status.peers.filter(peer => peer.status === 'online').length;
    const offlinePeers = status.peers.filter(peer => peer.status === 'offline').length;
    const stalePeers = totalPeers - onlinePeers - offlinePeers;

    document.getElementById('statusOverview').innerHTML = `
        <div class="col-6 col-md-3">
            <div class="card text-center">
                <div class="card-body py-2">
                    <h4 class="mb-0">${totalPeers}</h4>
                    <small class="text-muted text-uppercase">Total</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card text-center border-success">
                <div class="card-body py-2">
                    <h4 class="mb-0 text-success">${onlinePeers}</h4>
                    <small class="text-muted text-uppercase">Online</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card text-center border-warning">
                <div class="card-body py-2">
                    <h4 class="mb-0 text-warning">${stalePeers}</h4>
                    <small class="text-muted text-uppercase">Stale</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card text-center border-danger">
                <div class="card-body py-2">
                    <h4 class="mb-0 text-danger">${offlinePeers}</h4>
                    <small class="text-muted text-uppercase">Offline</small>
                </div>
            </div>
        </div>
    `;

    document.getElementById('interfaceInfo').innerHTML = `
        <div class="row">
            <div class="col-md-6 mb-2 mb-md-0">
                <small class="text-muted d-block">Interface</small>
                <strong>${status.interface.name || 'wg0'}</strong>
            </div>
            <div class="col-md-6">
                <small class="text-muted d-block">Public Key</small>
                <code class="small">${status.interface.public_key || 'N/A'}</code>
            </div>
        </div>
    `;

    if (status.peers.length > 0) {
        document.getElementById('peersList').innerHTML = status.peers.map((peer, index) => {
            const clientIp = peer.client_ip || 'Unknown';
            const username = getUsernameByIP(peer.allowed_ips || clientIp);
            const displayName = username || clientIp;
            const peerStatus = peer.status || 'offline';
            const statusColor = peerStatus === 'online' ? 'success' : peerStatus === 'stale' ? 'warning' : 'danger';
            const publicKey = peer.public_key_short || peer.public_key || '';
            const endpoint = peer.endpoint || 'N/A';
            const latestHandshake = peer.latest_handshake || 'Never';

            return `
            <div class="card peer-card mb-2" onclick="showPeerDetails(${index})">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">
                            ${username ? `<i class="fas fa-user me-1"></i>${username}` : clientIp}
                            ${username ? `<small class="text-muted ms-2">${clientIp}</small>` : ''}
                        </h6>
                        <span class="badge bg-${statusColor} text-uppercase">${peerStatus}</span>
                    </div>
                    <div class="row g-2 small">
                        <div class="col-md-4">
                            <div class="text-muted">Public Key</div>
                            <code class="small">${publicKey.substring(0,20)}...</code>
                        </div>
                        <div class="col-md-4">
                            <div class="text-muted">Endpoint</div>
                            <div>${endpoint.split(':')[0]}</div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-muted">Last Handshake</div>
                            <div>${latestHandshake}</div>
                        </div>
                    </div>
                </div>
            </div>
        `}).join('');
    } else {
        document.getElementById('peersList').innerHTML = `
            <div class="text-center py-4 text-muted">
                <i class="fas fa-plug fa-2x mb-2"></i>
                <p class="mb-0">No peers connected</p>
            </div>`;
    }
}

function showPeerDetails(peerIndex) {
    currentPeer = peerIndex;
    if (statusData && statusData.peers && statusData.peers[peerIndex]) {
        displayPeerDetails(statusData.peers[peerIndex]);
    } else {
        fetch('/wireguard/api/status-ui').then(r => r.json()).then(data => {
            if (data.success && data.status && data.status.peers[peerIndex]) {
                statusData = data.status;
                displayPeerDetails(data.status.peers[peerIndex]);
            }
        }).catch(() => showToast('Error loading peer details', 'danger'));
    }
}

function displayPeerDetails(peer) {
    const username = getUsernameByIP(peer.allowed_ips || peer.client_ip);
    const statusColor = peer.status === 'online' ? 'success' : peer.status === 'stale' ? 'warning' : 'danger';

    document.getElementById('peerDetailsFull').innerHTML = `
        ${username ? `
        <div class="col-md-6">
            <div class="p-3 bg-light rounded">
                <small class="text-muted d-block">Username</small>
                <strong><i class="fas fa-user me-1"></i>${username}</strong>
            </div>
        </div>` : ''}
        <div class="col-md-6">
            <div class="p-3 bg-light rounded">
                <small class="text-muted d-block">Client IP</small>
                <strong>${peer.client_ip || 'N/A'}</strong>
            </div>
        </div>
        <div class="col-md-12">
            <div class="p-3 bg-light rounded">
                <small class="text-muted d-block">Public Key</small>
                <code class="small">${peer.public_key_full || peer.public_key || 'N/A'}</code>
            </div>
        </div>
        <div class="col-md-6">
            <div class="p-3 bg-light rounded">
                <small class="text-muted d-block">Endpoint</small>
                <strong>${peer.endpoint || 'N/A'}</strong>
            </div>
        </div>
        <div class="col-md-6">
            <div class="p-3 bg-light rounded">
                <small class="text-muted d-block">Allowed IPs</small>
                <code class="small">${peer.allowed_ips || 'N/A'}</code>
            </div>
        </div>
        <div class="col-md-6">
            <div class="p-3 bg-light rounded">
                <small class="text-muted d-block">Last Handshake</small>
                <strong>${peer.latest_handshake || 'Never'}</strong>
            </div>
        </div>
        <div class="col-md-6">
            <div class="p-3 bg-light rounded">
                <small class="text-muted d-block">Status</small>
                <span class="badge bg-${statusColor} text-uppercase">${peer.status || 'offline'}</span>
            </div>
        </div>
    `;

    const hasTransferData = peer.transfer_received || peer.transfer_sent || peer.transfer_total;
    document.getElementById('peerTransferStatsFull').innerHTML = hasTransferData ? `
        <div class="col-4">
            <div class="card text-center">
                <div class="card-body py-2">
                    <small class="text-muted d-block">Received</small>
                    <strong>${peer.transfer_received || '0 B'}</strong>
                </div>
            </div>
        </div>
        <div class="col-4">
            <div class="card text-center">
                <div class="card-body py-2">
                    <small class="text-muted d-block">Sent</small>
                    <strong>${peer.transfer_sent || '0 B'}</strong>
                </div>
            </div>
        </div>
        <div class="col-4">
            <div class="card text-center">
                <div class="card-body py-2">
                    <small class="text-muted d-block">Total</small>
                    <strong>${peer.transfer_total || '0 B'}</strong>
                </div>
            </div>
        </div>
    ` : '<p class="text-muted small">No transfer data available</p>';

    document.getElementById('peerActions').innerHTML = `
        <button class="btn btn-outline-primary btn-sm" onclick="refreshPeerStatus()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
        ${username ? `
        <button class="btn btn-outline-info btn-sm" onclick="viewUserFromPeer('${username}')">
            <i class="fas fa-eye"></i> View Config
        </button>` : ''}
    `;

    peerDetailModal.show();
}

function viewUserFromPeer(username) {
    peerDetailModal.hide();
    setTimeout(() => viewUser(username), 300);
}

async function loadServerStatus() {
    try {
        const response = await fetch('/wireguard/api/status');
        const data = await response.json();
        document.getElementById('statusLoading').style.display = 'none';
        document.getElementById('serverStatus').style.display = 'block';
        document.getElementById('serverStatus').textContent = data.success ? data.status : 'Failed to load status';
    } catch (error) {
        document.getElementById('statusLoading').style.display = 'none';
        document.getElementById('serverStatus').style.display = 'block';
        document.getElementById('serverStatus').textContent = 'Error loading status';
    }
}

async function loadServerConfig() {
    try {
        const response = await fetch('/wireguard/api/config');
        const data = await response.json();
        document.getElementById('configLoading').style.display = 'none';
        document.getElementById('serverConfig').style.display = 'block';
        document.getElementById('serverConfig').textContent = data.success ? data.config : 'Failed to load config';
    } catch (error) {
        document.getElementById('configLoading').style.display = 'none';
        document.getElementById('serverConfig').style.display = 'block';
        document.getElementById('serverConfig').textContent = 'Error loading config';
    }
}

async function loadUsers() {
    try {
        const response = await fetch('/wireguard/api/users');
        const data = await response.json();
        document.getElementById('usersLoading').style.display = 'none';
        if (data.success && data.users.length > 0) {
            usersData = data.users; // Store for IP matching
            document.getElementById('usersTableContainer').style.display = 'block';
            document.getElementById('usersTableBody').innerHTML = data.users.map(user => `
                <tr>
                    <td><strong>${user.username}</strong></td>
                    <td><code>${user.ip}</code></td>
                    <td><small><code>${user.public_key.substring(0, 30)}...</code></small></td>
                    <td>${user.config_exists ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-warning">No Config</span>'}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="viewUser('${user.username}')" title="View"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-outline-secondary" onclick="showQRCode('${user.username}')" title="QR Code"><i class="fas fa-qrcode"></i></button>
                            <button class="btn btn-outline-info" onclick="downloadUserConfig('${user.username}')" title="Download"><i class="fas fa-download"></i></button>
                            <button class="btn btn-outline-danger" onclick="deleteUser('${user.username}')" title="Delete"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');
            // Refresh status to match usernames with peers
            if (statusData) displayEnhancedStatus(statusData);
        } else {
            document.getElementById('noUsers').style.display = 'block';
        }
    } catch (error) {
        document.getElementById('usersLoading').style.display = 'none';
        document.getElementById('noUsers').style.display = 'block';
    }
}

function showAddUserModal() {
    document.getElementById('newUsername').value = '';
    document.getElementById('newDescription').value = '';
    document.getElementById('newPrivateKey').value = '';
    document.getElementById('newPublicKey').value = '';
    document.getElementById('useExistingKeys').checked = false;
    document.getElementById('keyFields').style.display = 'none';
    addUserModal.show();
}

async function createUser() {
    const username = document.getElementById('newUsername').value.trim();
    if (!username) return showToast('Username required', 'warning');

    const payload = {username, description: document.getElementById('newDescription').value.trim()};
    if (document.getElementById('useExistingKeys').checked) {
        payload.private_key = document.getElementById('newPrivateKey').value.trim();
        payload.public_key = document.getElementById('newPublicKey').value.trim();
    }

    try {
        const response = await fetch('/wireguard/api/users', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)});
        const data = await response.json();
        if (data.success) { showToast(`User ${username} created!`, 'success'); addUserModal.hide(); loadUsers(); loadServerConfig(); loadEnhancedStatus(); }
        else showToast(data.error || 'Failed', 'danger');
    } catch (error) { showToast('Error creating user', 'danger'); }
}

async function viewUser(username) {
    currentUser = username;
    try {
        const response = await fetch(`/wireguard/api/users/${username}/config`);
        const data = await response.json();
        if (data.success) {
            document.getElementById('viewUsername').textContent = username;
            document.getElementById('viewUserConfig').textContent = data.config;
            const ipMatch = data.config.match(/Address\s*=\s*([^\n]+)/);
            document.getElementById('viewUserIP').textContent = ipMatch ? ipMatch[1].trim() : '-';
            viewUserModal.show();
        } else showToast('Failed to load config', 'danger');
    } catch (error) { showToast('Error loading user', 'danger'); }
}

function downloadConfigFromModal() { if (currentUser) downloadUserConfig(currentUser); }
function downloadUserConfig(username) { window.location.href = `/wireguard/api/users/${username}/download`; }
function showQRCode(username) { document.getElementById('qrImage').src = `/wireguard/api/users/${username}/qr?t=${Date.now()}`; qrModal.show(); }

async function deleteUser(username) {
    if (!confirm(`Delete user "${username}"?`)) return;
    try {
        const response = await fetch(`/wireguard/api/users/${username}`, {method: 'DELETE'});
        const data = await response.json();
        if (data.success) { showToast(`User ${username} deleted`, 'success'); loadUsers(); loadServerConfig(); loadEnhancedStatus(); }
        else showToast(data.error || 'Failed', 'danger');
    } catch (error) { showToast('Error deleting user', 'danger'); }
}

async function showEditConfigModal() {
    try {
        const response = await fetch('/wireguard/api/config');
        const data = await response.json();
        if (data.success) { document.getElementById('configEditor').value = data.config; editConfigModal.show(); }
        else showToast('Failed to load config', 'danger');
    } catch (error) { showToast('Error loading config', 'danger'); }
}

async function saveConfig() {
    const config = document.getElementById('configEditor').value;
    if (!confirm('Update config and restart service?')) return;
    try {
        const response = await fetch('/wireguard/api/config', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({config})});
        const data = await response.json();
        if (data.success) { showToast('Config updated', 'success'); editConfigModal.hide(); loadServerConfig(); loadEnhancedStatus(); }
        else showToast(data.error || 'Failed', 'danger');
    } catch (error) { showToast('Error saving config', 'danger'); }
}

async function restartWireGuard() {
    if (!confirm('Restart WireGuard?')) return;
    try {
        const response = await fetch('/wireguard/api/restart', {method: 'POST'});
        const data = await response.json();
        showToast(data.success ? 'Service restarted' : data.error || 'Failed', data.success ? 'success' : 'danger');
        if (data.success) setTimeout(() => loadEnhancedStatus(), 2000);
    } catch (error) { showToast('Error restarting', 'danger'); }
}

function refreshStatus() { loadEnhancedStatus(); loadUsers(); showToast('Refreshing...', 'info'); }

async function initializeUsersDirectory() {
    if (!confirm('Initialize users directory?')) return;
    try {
        const response = await fetch('/wireguard/api/init-users-dir', {method: 'POST'});
        const data = await response.json();
        showToast(data.success ? 'Directory initialized' : data.error || 'Failed', data.success ? 'success' : 'danger');
    } catch (error) { showToast('Error initializing', 'danger'); }
}

function refreshPeerStatus() { showToast('Refreshing peer...', 'info'); loadEnhancedStatus(); }

function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer') || (() => {
        const container = document.createElement('div');
        container.id = 'toastContainer';
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        container.style.zIndex = '9999';
        document.body.appendChild(container);
        return container;
    })();

    const toastId = 'toast-' + Date.now();
    const bgClass = type === 'success' ? 'bg-success' : type === 'danger' ? 'bg-danger' : type === 'warning' ? 'bg-warning' : 'bg-info';

    toastContainer.innerHTML += `
        <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>`;

    const toastEl = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastEl);
    toast.show();

    toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
}
</script>
{% endblock %}