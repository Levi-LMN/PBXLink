{% extends "base.html" %}

{% block title %}Extensions - FreePBX Dashboard{% endblock %}
{% block page_title %}Extensions Management{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        background: white;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 1.25rem;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        transition: all 0.2s ease;
    }

    .stat-card:hover {
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        margin-bottom: 1rem;
    }

    .stat-value {
        font-size: 1.75rem;
        font-weight: 600;
        margin: 0.5rem 0;
        color: var(--text-primary);
    }

    .stat-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin: 0;
        font-weight: 500;
    }

    .btn-icon {
        width: 32px;
        height: 32px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .action-buttons .btn-group-sm .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="row g-4 mb-4">
    <!-- Stats Cards -->
    <div class="col-md-6 col-lg-3">
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(25,135,84,0.1); color: #198754;">
                <i class="fas fa-check-circle"></i>
            </div>
            <h3 class="stat-value" id="online-count">-</h3>
            <p class="stat-label">Online</p>
        </div>
    </div>

    <div class="col-md-6 col-lg-3">
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(220,53,69,0.1); color: #dc3545;">
                <i class="fas fa-times-circle"></i>
            </div>
            <h3 class="stat-value" id="offline-count">-</h3>
            <p class="stat-label">Offline</p>
        </div>
    </div>

    <div class="col-md-6 col-lg-3">
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(13,110,253,0.1); color: #0d6efd;">
                <i class="fas fa-phone-alt"></i>
            </div>
            <h3 class="stat-value" id="total-count">-</h3>
            <p class="stat-label">Total Extensions</p>
        </div>
    </div>

    <div class="col-md-6 col-lg-3">
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(255,193,7,0.1); color: #ffc107;">
                <i class="fas fa-sync-alt"></i>
            </div>
            <p class="stat-label mb-3">Quick Actions</p>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-warning" onclick="refreshStatus()" title="Refresh Status Cache">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button class="btn btn-sm btn-danger" onclick="reloadAsterisk()" title="Apply Config (Reload Asterisk)">
                    <i class="fas fa-redo"></i> Reload
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Actions Bar -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-6 mb-2 mb-md-0">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" id="search-input" placeholder="Search extensions...">
                </div>
            </div>
            <div class="col-md-6 text-end">
                <button class="btn btn-primary" onclick="showCreateModal()">
                    <i class="fas fa-plus"></i> Add Extension
                </button>
                <button class="btn btn-outline-primary" onclick="showBulkCreateModal()">
                    <i class="fas fa-plus-square"></i> Bulk Create
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Extensions Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="fas fa-list"></i> Extensions</span>
        <span class="badge bg-secondary" id="filtered-count">0</span>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="extensions-table">
                <thead>
                    <tr>
                        <th>Extension</th>
                        <th>Name</th>
                        <th>Status</th>
                        <th>Caller ID</th>
                        <th>Tech</th>
                        <th>Device Type</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="extensions-tbody">
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create Extension Modal -->
<div class="modal fade" id="createModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Extension</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="create-form">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Extension Number *</label>
                            <input type="text" class="form-control" name="extensionId" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Display Name *</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Technology</label>
                            <select class="form-select" name="tech">
                                <option value="pjsip" selected>PJSIP</option>
                                <option value="sip">SIP</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Outbound CID</label>
                            <input type="text" class="form-control" name="outboundCid">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Emergency CID</label>
                            <input type="text" class="form-control" name="emergencyCid">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Caller ID</label>
                            <input type="text" class="form-control" name="callerId">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">SIP Password</label>
                            <input type="text" class="form-control" name="extPassword" placeholder="Auto-generated if empty">
                            <small class="text-muted">Leave empty to auto-generate</small>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Max Contacts</label>
                            <input type="number" class="form-control" name="maxContacts" value="1" min="1">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">VM Password</label>
                            <input type="text" class="form-control" name="vmPassword">
                            <small class="text-muted">Voicemail PIN</small>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="vmEnable" checked>
                                <label class="form-check-label">Enable Voicemail</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createExtension()">
                    <i class="fas fa-save"></i> Create Extension
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Create Modal -->
<div class="modal fade" id="bulkCreateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Create Extensions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="bulk-create-form">
                    <div class="mb-3">
                        <label class="form-label">Start Extension *</label>
                        <input type="number" class="form-control" name="startExtension" required>
                        <small class="text-muted">Starting extension number</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Number of Extensions *</label>
                        <input type="number" class="form-control" name="numberOfExtensions" required min="1">
                        <small class="text-muted">How many extensions to create</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Name Template</label>
                        <input type="text" class="form-control" name="name" placeholder="Extension">
                        <small class="text-muted">Names will be: "Extension 1000", "Extension 1001", etc.</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Technology</label>
                        <select class="form-select" name="tech">
                            <option value="pjsip" selected>PJSIP</option>
                            <option value="sip">SIP</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="bulkCreateExtensions()">
                    <i class="fas fa-plus-square"></i> Create Extensions
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Extension Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Extension</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="edit-form">
                    <input type="hidden" id="edit-extension-id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Extension Number</label>
                            <input type="text" class="form-control" id="edit-ext-number" disabled>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Display Name *</label>
                            <input type="text" class="form-control" name="name" id="edit-name" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Technology</label>
                            <select class="form-select" name="tech" id="edit-tech">
                                <option value="pjsip">PJSIP</option>
                                <option value="sip">SIP</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" id="edit-email">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Outbound CID</label>
                            <input type="text" class="form-control" name="outboundCid" id="edit-outbound-cid">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Emergency CID</label>
                            <input type="text" class="form-control" name="emergencyCid" id="edit-emergency-cid">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">SIP Password</label>
                            <input type="text" class="form-control" name="extPassword" id="edit-ext-password" placeholder="Leave empty to keep current">
                            <small class="text-muted">Leave empty to keep existing password</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Caller ID</label>
                            <input type="text" class="form-control" name="callerId" id="edit-caller-id">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateExtension()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Details Modal -->
<div class="modal fade" id="viewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Extension Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">Extension Number</label>
                        <p class="form-control-plaintext fw-bold" id="view-ext-number">-</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">Display Name</label>
                        <p class="form-control-plaintext" id="view-name">-</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">Technology</label>
                        <p class="form-control-plaintext" id="view-tech">-</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">Status</label>
                        <p class="form-control-plaintext" id="view-status">-</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 mb-3">
                        <div class="alert alert-info">
                            <strong><i class="fas fa-key"></i> SIP Credentials</strong>
                            <hr>
                            <div class="row">
                                <div class="col-md-4">
                                    <small class="text-muted d-block">Username</small>
                                    <strong id="view-username">-</strong>
                                </div>
                                <div class="col-md-4">
                                    <small class="text-muted d-block">Password</small>
                                    <div class="d-flex align-items-center gap-2">
                                        <code id="view-password" style="font-size: 1rem;">••••••••</code>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="togglePassword()" id="toggle-password-btn">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="copyPassword()" title="Copy to clipboard">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <small class="text-muted d-block">Server</small>
                                    <strong id="view-server">-</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">Caller ID</label>
                        <p class="form-control-plaintext" id="view-caller-id">-</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">Outbound CID</label>
                        <p class="form-control-plaintext" id="view-outbound-cid">-</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">Emergency CID</label>
                        <p class="form-control-plaintext" id="view-emergency-cid">-</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-muted">Email</label>
                        <p class="form-control-plaintext" id="view-email">-</p>
                    </div>
                </div>
                <div class="row" id="view-contacts-section" style="display: none;">
                    <div class="col-12">
                        <label class="form-label text-muted">Registered Contacts</label>
                        <div id="view-contacts" class="border rounded p-2 bg-light">
                            <code style="font-size: 0.85rem; white-space: pre-wrap;"></code>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="editFromView()">
                    <i class="fas fa-edit"></i> Edit Extension
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allExtensions = [];
let createModalInstance, bulkCreateModalInstance, editModalInstance, viewModalInstance;
let currentExtensionData = null;
let passwordVisible = false;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    createModalInstance = new bootstrap.Modal(document.getElementById('createModal'));
    bulkCreateModalInstance = new bootstrap.Modal(document.getElementById('bulkCreateModal'));
    editModalInstance = new bootstrap.Modal(document.getElementById('editModal'));
    viewModalInstance = new bootstrap.Modal(document.getElementById('viewModal'));

    loadExtensions();
    loadStatus();

    // Setup search
    document.getElementById('search-input').addEventListener('input', filterExtensions);

    // Auto-refresh status every 30 seconds
    setInterval(loadStatus, 30000);
});

// Load extensions list
async function loadExtensions() {
    try {
        const response = await fetch('/extensions/api/list');
        const data = await response.json();

        if (data.status === 'success') {
            allExtensions = data.extensions;
            document.getElementById('total-count').textContent = data.total;
            renderExtensions(allExtensions);
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        console.error('Error loading extensions:', error);
        showToast('Failed to load extensions', 'danger');
    }
}

// Load status information
async function loadStatus() {
    try {
        const response = await fetch('/extensions/api/status');
        const data = await response.json();

        if (data.status === 'success') {
            document.getElementById('online-count').textContent = data.online_count;
            document.getElementById('offline-count').textContent = data.offline_count;
        }
    } catch (error) {
        console.error('Error loading status:', error);
    }
}

// Render extensions table
function renderExtensions(extensions) {
    const tbody = document.getElementById('extensions-tbody');
    document.getElementById('filtered-count').textContent = extensions.length;

    if (extensions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">No extensions found</td></tr>';
        return;
    }

    tbody.innerHTML = extensions.map(ext => `
        <tr>
            <td><strong>${ext.extension_id}</strong></td>
            <td>${ext.name}</td>
            <td>
                ${ext.registered
                    ? '<span class="badge bg-success"><i class="fas fa-check-circle"></i> ' + ext.status + '</span>'
                    : '<span class="badge bg-secondary"><i class="fas fa-times-circle"></i> Offline</span>'
                }
                ${ext.contact_count > 0 ? `<small class="text-muted ms-1">(${ext.contact_count})</small>` : ''}
            </td>
            <td>${ext.caller_id || '-'}</td>
            <td><span class="badge bg-info">${ext.tech.toUpperCase()}</span></td>
            <td>${ext.device_type || '-'}</td>
            <td class="action-buttons">
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-info" onclick="viewExtension('${ext.extension_id}')" title="View Details & Password">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-outline-primary" onclick="editExtension('${ext.extension_id}')" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="confirmDelete('${ext.extension_id}')" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

// Filter extensions
function filterExtensions() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const filtered = allExtensions.filter(ext =>
        ext.extension_id.toLowerCase().includes(searchTerm) ||
        ext.name.toLowerCase().includes(searchTerm) ||
        (ext.caller_id && ext.caller_id.toLowerCase().includes(searchTerm))
    );
    renderExtensions(filtered);
}

// Refresh status
async function refreshStatus() {
    try {
        showToast('Refreshing status cache...', 'info');
        const response = await fetch('/extensions/api/refresh-status', { method: 'POST' });
        const data = await response.json();

        if (data.status === 'success') {
            showToast('Status cache cleared, refreshing data...', 'success');
            setTimeout(() => {
                loadStatus();
                loadExtensions();
            }, 1000);
        }
    } catch (error) {
        console.error('Error refreshing status:', error);
        showToast('Failed to refresh status', 'danger');
    }
}

// Reload Asterisk configuration
async function reloadAsterisk() {
    try {
        if (!confirm('Apply configuration changes and reload Asterisk? This may briefly interrupt calls.')) {
            return;
        }

        showToast('Reloading Asterisk configuration...', 'info');
        const response = await fetch('/extensions/api/reload', { method: 'POST' });
        const data = await response.json();

        if (data.status === 'success') {
            showToast('Asterisk configuration reloaded successfully!', 'success');
            setTimeout(() => {
                loadStatus();
                loadExtensions();
            }, 2000);
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        console.error('Error reloading Asterisk:', error);
        showToast('Failed to reload Asterisk', 'danger');
    }
}

// Show create modal
function showCreateModal() {
    document.getElementById('create-form').reset();
    createModalInstance.show();
}

// Create extension
async function createExtension() {
    const form = document.getElementById('create-form');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    // Convert checkbox
    data.vmEnable = form.querySelector('[name="vmEnable"]').checked;

    try {
        showToast('Creating extension...', 'info');
        const response = await fetch('/extensions/api/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.status === 'success') {
            createModalInstance.hide();

            // Show message based on reload status
            if (result.reloaded) {
                showToast(`${result.message} - Asterisk reloaded successfully!`, 'success');
            } else {
                showToast(`${result.message} - Note: Asterisk reload failed, you may need to manually reload.`, 'warning');
            }

            // Refresh data after a short delay to allow Asterisk to process
            setTimeout(() => {
                loadExtensions();
                loadStatus();
            }, 2000);
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('Error creating extension:', error);
        showToast('Failed to create extension: ' + error.message, 'danger');
    }
}

// Show bulk create modal
function showBulkCreateModal() {
    document.getElementById('bulk-create-form').reset();
    bulkCreateModalInstance.show();
}

// Bulk create extensions
async function bulkCreateExtensions() {
    const form = document.getElementById('bulk-create-form');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    try {
        showToast('Creating extensions...', 'info');
        const response = await fetch('/extensions/api/bulk-create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.status === 'success') {
            bulkCreateModalInstance.hide();

            // Show message based on reload status
            if (result.reloaded) {
                showToast(`${result.message} - Asterisk reloaded successfully!`, 'success');
            } else {
                showToast(`${result.message} - Note: Asterisk reload failed, you may need to manually reload.`, 'warning');
            }

            // Refresh data after a short delay
            setTimeout(() => {
                loadExtensions();
                loadStatus();
            }, 2000);
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('Error bulk creating extensions:', error);
        showToast('Failed to bulk create extensions: ' + error.message, 'danger');
    }
}

// Edit extension
async function editExtension(extensionId) {
    try {
        const response = await fetch(`/extensions/api/get/${extensionId}`);
        const data = await response.json();

        if (data.status === 'success') {
            const ext = data.extension;
            document.getElementById('edit-extension-id').value = ext.extension_id;
            document.getElementById('edit-ext-number').value = ext.extension_id;
            document.getElementById('edit-name').value = ext.name;
            document.getElementById('edit-tech').value = ext.tech;
            document.getElementById('edit-email').value = ext.email || '';
            document.getElementById('edit-outbound-cid').value = ext.outbound_cid || '';
            document.getElementById('edit-emergency-cid').value = ext.emergency_cid || '';

            editModalInstance.show();
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        console.error('Error loading extension:', error);
        showToast('Failed to load extension details', 'danger');
    }
}

// Update extension
async function updateExtension() {
    const extensionId = document.getElementById('edit-extension-id').value;
    const form = document.getElementById('edit-form');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    try {
        showToast('Updating extension...', 'info');
        const response = await fetch(`/extensions/api/update/${extensionId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.status === 'success') {
            editModalInstance.hide();

            // Show message based on reload status
            if (result.reloaded) {
                showToast(`${result.message} - Asterisk reloaded successfully!`, 'success');
            } else {
                showToast(`${result.message} - Note: Asterisk reload failed, you may need to manually reload.`, 'warning');
            }

            // Refresh data
            setTimeout(() => {
                loadExtensions();
            }, 2000);
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('Error updating extension:', error);
        showToast('Failed to update extension: ' + error.message, 'danger');
    }
}

// Confirm delete
function confirmDelete(extensionId) {
    if (confirm(`Are you sure you want to delete extension ${extensionId}?`)) {
        deleteExtension(extensionId);
    }
}

// Delete extension
async function deleteExtension(extensionId) {
    try {
        showToast('Deleting extension...', 'info');
        const response = await fetch(`/extensions/api/delete/${extensionId}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.status === 'success') {
            // Show message based on reload status
            if (result.reloaded) {
                showToast(`${result.message} - Asterisk reloaded successfully!`, 'success');
            } else {
                showToast(`${result.message} - Note: Asterisk reload failed, you may need to manually reload.`, 'warning');
            }

            // Refresh data
            setTimeout(() => {
                loadExtensions();
                loadStatus();
            }, 2000);
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('Error deleting extension:', error);
        showToast('Failed to delete extension: ' + error.message, 'danger');
    }
}

// View extension details with password
async function viewExtension(extensionId) {
    try {
        const response = await fetch(`/extensions/api/get/${extensionId}`);
        const data = await response.json();

        if (data.status === 'success') {
            const ext = data.extension;
            currentExtensionData = ext;
            passwordVisible = false;

            document.getElementById('view-ext-number').textContent = ext.extension_id;
            document.getElementById('view-name').textContent = ext.name || '-';
            document.getElementById('view-tech').textContent = ext.tech ? ext.tech.toUpperCase() : '-';
            document.getElementById('view-status').innerHTML = ext.registered
                ? '<span class="badge bg-success">Online</span>'
                : '<span class="badge bg-secondary">Offline</span>';

            // SIP Credentials
            document.getElementById('view-username').textContent = ext.extension_id;
            document.getElementById('view-password').textContent = '••••••••';
            document.getElementById('view-password').setAttribute('data-password', ext.password || ext.extPassword || 'Not set');
            document.getElementById('view-server').textContent = window.location.hostname;

            // Other details
            document.getElementById('view-caller-id').textContent = ext.caller_id || '-';
            document.getElementById('view-outbound-cid').textContent = ext.outbound_cid || '-';
            document.getElementById('view-emergency-cid').textContent = ext.emergency_cid || '-';
            document.getElementById('view-email').textContent = ext.email || '-';

            // Show registered contacts if available
            if (ext.contacts && ext.contacts.length > 0) {
                document.getElementById('view-contacts-section').style.display = 'block';
                document.getElementById('view-contacts').querySelector('code').textContent = ext.contacts.join('\n');
            } else {
                document.getElementById('view-contacts-section').style.display = 'none';
            }

            viewModalInstance.show();
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        console.error('Error loading extension:', error);
        showToast('Failed to load extension details', 'danger');
    }
}

// Toggle password visibility
function togglePassword() {
    const passwordEl = document.getElementById('view-password');
    const toggleBtn = document.getElementById('toggle-password-btn');
    const actualPassword = passwordEl.getAttribute('data-password');

    passwordVisible = !passwordVisible;

    if (passwordVisible) {
        passwordEl.textContent = actualPassword;
        toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
    } else {
        passwordEl.textContent = '••••••••';
        toggleBtn.innerHTML = '<i class="fas fa-eye"></i>';
    }
}

// Copy password to clipboard
function copyPassword() {
    const passwordEl = document.getElementById('view-password');
    const actualPassword = passwordEl.getAttribute('data-password');

    navigator.clipboard.writeText(actualPassword).then(() => {
        showToast('Password copied to clipboard!', 'success');
    }).catch(err => {
        console.error('Failed to copy:', err);
        showToast('Failed to copy password', 'danger');
    });
}

// Edit from view modal
function editFromView() {
    if (currentExtensionData) {
        viewModalInstance.hide();
        setTimeout(() => {
            editExtension(currentExtensionData.extension_id);
        }, 300);
    }
}
</script>
{% endblock %}