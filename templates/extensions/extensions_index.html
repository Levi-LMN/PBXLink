{% extends "base.html" %}

{% block title %}Extensions - FreePBX Dashboard{% endblock %}
{% block page_title %}Extensions Management{% endblock %}

{% block content %}
<div class="row mb-4">
    <!-- Stats Cards -->
    <div class="col-md-6 col-lg-3 mb-3">
        <div class="stat-card">
            <div class="stat-icon" style="background: #d4edda; color: #28a745;">
                <i class="fas fa-check-circle"></i>
            </div>
            <p class="stat-value" id="online-count">-</p>
            <p class="stat-label">Online</p>
        </div>
    </div>
    <div class="col-md-6 col-lg-3 mb-3">
        <div class="stat-card">
            <div class="stat-icon" style="background: #f8d7da; color: #dc3545;">
                <i class="fas fa-times-circle"></i>
            </div>
            <p class="stat-value" id="offline-count">-</p>
            <p class="stat-label">Offline</p>
        </div>
    </div>
    <div class="col-md-6 col-lg-3 mb-3">
        <div class="stat-card">
            <div class="stat-icon" style="background: #cfe2ff; color: #0d6efd;">
                <i class="fas fa-phone-alt"></i>
            </div>
            <p class="stat-value" id="total-count">-</p>
            <p class="stat-label">Total Extensions</p>
        </div>
    </div>
    <div class="col-md-6 col-lg-3 mb-3">
        <div class="stat-card">
            <div class="stat-icon" style="background: #fff3cd; color: #ffc107;">
                <i class="fas fa-sync-alt"></i>
            </div>
            <p class="stat-label mb-2">Actions</p>
            <button class="btn btn-sm btn-warning me-1" onclick="refreshStatus()" title="Refresh Status Cache">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button class="btn btn-sm btn-danger" onclick="reloadAsterisk()" title="Apply Config (Reload Asterisk)">
                <i class="fas fa-redo"></i>
            </button>
        </div>
    </div>
</div>

<!-- Actions Bar -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-6 mb-2 mb-md-0">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" id="search-input" placeholder="Search extensions...">
                </div>
            </div>
            <div class="col-md-6 text-end">
                <button class="btn btn-primary" onclick="showCreateModal()">
                    <i class="fas fa-plus"></i> Add Extension
                </button>
                <button class="btn btn-outline-primary" onclick="showBulkCreateModal()">
                    <i class="fas fa-plus-square"></i> Bulk Create
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Extensions Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="fas fa-list"></i> Extensions</span>
        <span class="badge bg-secondary" id="filtered-count">0</span>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="extensions-table">
                <thead>
                    <tr>
                        <th>Extension</th>
                        <th>Name</th>
                        <th>Status</th>
                        <th>Caller ID</th>
                        <th>Tech</th>
                        <th>Device Type</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="extensions-tbody">
                    <tr>
                        <td colspan="7" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create Extension Modal -->
<div class="modal fade" id="createModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Extension</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="create-form">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Extension Number *</label>
                            <input type="text" class="form-control" name="extensionId" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Display Name *</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Technology</label>
                            <select class="form-select" name="tech">
                                <option value="pjsip" selected>PJSIP</option>
                                <option value="sip">SIP</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Outbound CID</label>
                            <input type="text" class="form-control" name="outboundCid">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Emergency CID</label>
                            <input type="text" class="form-control" name="emergencyCid">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Caller ID</label>
                            <input type="text" class="form-control" name="callerId">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Max Contacts</label>
                            <input type="number" class="form-control" name="maxContacts" value="1" min="1">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="vmEnable" checked>
                                <label class="form-check-label">Enable Voicemail</label>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">VM Password</label>
                            <input type="text" class="form-control" name="vmPassword">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createExtension()">
                    <i class="fas fa-save"></i> Create Extension
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Create Modal -->
<div class="modal fade" id="bulkCreateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Create Extensions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="bulk-create-form">
                    <div class="mb-3">
                        <label class="form-label">Start Extension *</label>
                        <input type="number" class="form-control" name="startExtension" required>
                        <small class="text-muted">Starting extension number</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Number of Extensions *</label>
                        <input type="number" class="form-control" name="numberOfExtensions" required min="1">
                        <small class="text-muted">How many extensions to create</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Name Template</label>
                        <input type="text" class="form-control" name="name" placeholder="Extension">
                        <small class="text-muted">Names will be: "Extension 1000", "Extension 1001", etc.</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Technology</label>
                        <select class="form-select" name="tech">
                            <option value="pjsip" selected>PJSIP</option>
                            <option value="sip">SIP</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="bulkCreateExtensions()">
                    <i class="fas fa-plus-square"></i> Create Extensions
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Extension Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Extension</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="edit-form">
                    <input type="hidden" id="edit-extension-id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Extension Number</label>
                            <input type="text" class="form-control" id="edit-ext-number" disabled>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Display Name *</label>
                            <input type="text" class="form-control" name="name" id="edit-name" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Technology</label>
                            <select class="form-select" name="tech" id="edit-tech">
                                <option value="pjsip">PJSIP</option>
                                <option value="sip">SIP</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" id="edit-email">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Outbound CID</label>
                            <input type="text" class="form-control" name="outboundCid" id="edit-outbound-cid">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Emergency CID</label>
                            <input type="text" class="form-control" name="emergencyCid" id="edit-emergency-cid">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateExtension()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allExtensions = [];
let createModalInstance, bulkCreateModalInstance, editModalInstance;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    createModalInstance = new bootstrap.Modal(document.getElementById('createModal'));
    bulkCreateModalInstance = new bootstrap.Modal(document.getElementById('bulkCreateModal'));
    editModalInstance = new bootstrap.Modal(document.getElementById('editModal'));

    loadExtensions();
    loadStatus();

    // Setup search
    document.getElementById('search-input').addEventListener('input', filterExtensions);

    // Auto-refresh status every 30 seconds
    setInterval(loadStatus, 30000);
});

// Load extensions list
async function loadExtensions() {
    try {
        const response = await fetch('/extensions/api/list');
        const data = await response.json();

        if (data.status === 'success') {
            allExtensions = data.extensions;
            document.getElementById('total-count').textContent = data.total;
            renderExtensions(allExtensions);
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        handleError(error);
    }
}

// Load status information
async function loadStatus() {
    try {
        const response = await fetch('/extensions/api/status');
        const data = await response.json();

        if (data.status === 'success') {
            document.getElementById('online-count').textContent = data.online_count;
            document.getElementById('offline-count').textContent = data.offline_count;
        }
    } catch (error) {
        console.error('Error loading status:', error);
    }
}

// Render extensions table
function renderExtensions(extensions) {
    const tbody = document.getElementById('extensions-tbody');
    document.getElementById('filtered-count').textContent = extensions.length;

    if (extensions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">No extensions found</td></tr>';
        return;
    }

    tbody.innerHTML = extensions.map(ext => `
        <tr>
            <td><strong>${ext.extension_id}</strong></td>
            <td>${ext.name}</td>
            <td>
                ${ext.registered
                    ? '<span class="badge bg-success"><i class="fas fa-check-circle"></i> ' + ext.status + '</span>'
                    : '<span class="badge bg-secondary"><i class="fas fa-times-circle"></i> Offline</span>'
                }
                ${ext.contact_count > 0 ? `<small class="text-muted">(${ext.contact_count})</small>` : ''}
            </td>
            <td>${ext.caller_id || '-'}</td>
            <td><span class="badge bg-info">${ext.tech.toUpperCase()}</span></td>
            <td>${ext.device_type || '-'}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary btn-icon" onclick="editExtension('${ext.extension_id}')" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-icon" onclick="confirmDelete('${ext.extension_id}')" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

// Filter extensions
function filterExtensions() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const filtered = allExtensions.filter(ext =>
        ext.extension_id.toLowerCase().includes(searchTerm) ||
        ext.name.toLowerCase().includes(searchTerm) ||
        (ext.caller_id && ext.caller_id.toLowerCase().includes(searchTerm))
    );
    renderExtensions(filtered);
}

// Refresh status
async function refreshStatus() {
    try {
        showToast('Refreshing status cache...', 'info');
        const response = await fetch('/extensions/api/refresh-status', { method: 'POST' });
        const data = await response.json();

        if (data.status === 'success') {
            showToast('Status cache cleared, refreshing data...', 'success');
            setTimeout(() => {
                loadStatus();
                loadExtensions();
            }, 1000);
        }
    } catch (error) {
        handleError(error);
    }
}

// Reload Asterisk configuration
async function reloadAsterisk() {
    try {
        if (!confirm('Apply configuration changes and reload Asterisk? This may briefly interrupt calls.')) {
            return;
        }

        showToast('Reloading Asterisk configuration...', 'info');
        const response = await fetch('/extensions/api/reload', { method: 'POST' });
        const data = await response.json();

        if (data.status === 'success') {
            showToast('Asterisk configuration reloaded successfully!', 'success');
            setTimeout(() => {
                loadStatus();
                loadExtensions();
            }, 2000);
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        handleError(error);
    }
}

// Show create modal
function showCreateModal() {
    document.getElementById('create-form').reset();
    createModalInstance.show();
}

// Create extension
async function createExtension() {
    const form = document.getElementById('create-form');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    // Convert checkbox
    data.vmEnable = form.querySelector('[name="vmEnable"]').checked;

    try {
        showToast('Creating extension...', 'info');
        const response = await fetch('/extensions/api/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.status === 'success') {
            createModalInstance.hide();

            // Show message based on reload status
            if (result.reloaded) {
                showToast(`${result.message} - Asterisk reloaded successfully!`, 'success');
            } else {
                showToast(`${result.message} - Note: Asterisk reload failed, you may need to manually reload.`, 'warning');
            }

            // Refresh data after a short delay to allow Asterisk to process
            setTimeout(() => {
                loadExtensions();
                loadStatus();
            }, 2000);
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        handleError(error);
    }
}

// Show bulk create modal
function showBulkCreateModal() {
    document.getElementById('bulk-create-form').reset();
    bulkCreateModalInstance.show();
}

// Bulk create extensions
async function bulkCreateExtensions() {
    const form = document.getElementById('bulk-create-form');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    try {
        showToast('Creating extensions...', 'info');
        const response = await fetch('/extensions/api/bulk-create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.status === 'success') {
            bulkCreateModalInstance.hide();

            // Show message based on reload status
            if (result.reloaded) {
                showToast(`${result.message} - Asterisk reloaded successfully!`, 'success');
            } else {
                showToast(`${result.message} - Note: Asterisk reload failed, you may need to manually reload.`, 'warning');
            }

            // Refresh data after a short delay
            setTimeout(() => {
                loadExtensions();
                loadStatus();
            }, 2000);
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        handleError(error);
    }
}

// Edit extension
async function editExtension(extensionId) {
    try {
        const response = await fetch(`/extensions/api/get/${extensionId}`);
        const data = await response.json();

        if (data.status === 'success') {
            const ext = data.extension;
            document.getElementById('edit-extension-id').value = ext.extension_id;
            document.getElementById('edit-ext-number').value = ext.extension_id;
            document.getElementById('edit-name').value = ext.name;
            document.getElementById('edit-tech').value = ext.tech;
            document.getElementById('edit-email').value = ext.email || '';
            document.getElementById('edit-outbound-cid').value = ext.outbound_cid || '';
            document.getElementById('edit-emergency-cid').value = ext.emergency_cid || '';

            editModalInstance.show();
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        handleError(error);
    }
}

// Update extension
async function updateExtension() {
    const extensionId = document.getElementById('edit-extension-id').value;
    const form = document.getElementById('edit-form');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    try {
        showToast('Updating extension...', 'info');
        const response = await fetch(`/extensions/api/update/${extensionId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.status === 'success') {
            editModalInstance.hide();

            // Show message based on reload status
            if (result.reloaded) {
                showToast(`${result.message} - Asterisk reloaded successfully!`, 'success');
            } else {
                showToast(`${result.message} - Note: Asterisk reload failed, you may need to manually reload.`, 'warning');
            }

            // Refresh data
            setTimeout(() => {
                loadExtensions();
            }, 2000);
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        handleError(error);
    }
}

// Confirm delete
function confirmDelete(extensionId) {
    if (confirm(`Are you sure you want to delete extension ${extensionId}?`)) {
        deleteExtension(extensionId);
    }
}

// Delete extension
async function deleteExtension(extensionId) {
    try {
        showToast('Deleting extension...', 'info');
        const response = await fetch(`/extensions/api/delete/${extensionId}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.status === 'success') {
            // Show message based on reload status
            if (result.reloaded) {
                showToast(`${result.message} - Asterisk reloaded successfully!`, 'success');
            } else {
                showToast(`${result.message} - Note: Asterisk reload failed, you may need to manually reload.`, 'warning');
            }

            // Refresh data
            setTimeout(() => {
                loadExtensions();
                loadStatus();
            }, 2000);
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        handleError(error);
    }
}
</script>
{% endblock %}